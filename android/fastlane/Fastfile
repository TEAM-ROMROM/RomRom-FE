lane :build do
  short_commit_hash = ENV['SHORT_COMMIT_HASH']
  flutter_build(
    build: 'apk',
    project_dir: '..',
    output_name: "romrom-#{short_commit_hash}.apk"
  )
end

def flutter_build(options)
  # 프로젝트 루트 디렉토리에서 Flutter 빌드 실행
  Dir.chdir(options[:project_dir]) do
    sh(
      "flutter",
      "build",
      options[:build],
      "--release",
      "--no-tree-shake-icons",
      "--target-platform=android-arm64",
      "-v"
    )
  end
  # 루트 디렉토리 기준으로 경로 확인 및 파일 이동
  sh("ls", "-la", "./build/")
  sh("ls", "-la", "./build/app/")
  sh("ls", "-la", "./build/app/outputs/")
  sh("ls", "-la", "./build/app/outputs/flutter-apk/")
  sh("mkdir", "-p", "./android/app/build/outputs/apk/release/")
  sh("mv", "./build/app/outputs/flutter-apk/app-release.apk", "./android/app/build/outputs/apk/release/#{options[:output_name]}")
end