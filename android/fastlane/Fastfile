lane :build do
  short_commit_hash = ENV['SHORT_COMMIT_HASH']
  flutter_build(
    build: 'apk',
    project_dir: '..',
    output_name: "romrom-#{short_commit_hash}.apk"
  )
end

def flutter_build(options)
  Dir.chdir(options[:project_dir]) do
    sh(
      "flutter",
      "build",
      options[:build],
      "--release",
      "--no-tree-shake-icons",
      "--target-platform=android-arm64",
      "-v"
    )
  end
  # 디버깅용 ls 명령은 실패해도 계속 진행하도록 error: false 추가
  sh("ls", "-la", "../build/", error: false)
  sh("ls", "-la", "../build/app/", error: false)
  sh("ls", "-la", "../build/app/outputs/", error: false)
  sh("ls", "-la", "../build/app/outputs/flutter-apk/", error: false)
  # APK 이동만 보장
  sh("mkdir", "-p", "./app/build/outputs/apk/release/")
  sh("mv", "../build/app/outputs/flutter-apk/app-release.apk", "./app/build/outputs/apk/release/#{options[:output_name]}")
end