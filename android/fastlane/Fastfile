lane :build do
  short_commit_hash = ENV['SHORT_COMMIT_HASH']
  flutter_build(
    build: 'apk',
    project_dir: '..',
    output_name: "romrom-#{short_commit_hash}.apk"
  )
end

def flutter_build(options)
  sh(
    "flutter",
    "build",
    options[:build],
    "--release",
    "--no-tree-shake-icons",
    "--target-platform=android-arm64",
    "-v"
  )
  sh("ls", "-la", "../build/") # 상위 디렉터리 확인
  sh("ls", "-la", "../build/app/outputs/") # 출력 디렉터리 확인
  sh("ls", "-la", "../build/app/outputs/flutter-apk/") # APK 위치 확인
  sh("mkdir", "-p", "app/build/outputs/apk/release/") # 디렉터리 생성
  sh("mv", "../build/app/outputs/flutter-apk/app-release.apk", "app/build/outputs/apk/release/#{options[:output_name]}")
end