default_platform(:android)

platform :android do
  desc "Build AAB for Play Store"
  lane :build_aab do
    flutter_build(
      build: 'appbundle',
      project_dir: '..'
    )
  end

  desc "Deploy to Play Store Internal Testing Track"
  lane :deploy_internal do
    # Release notes ì½ê¸°
    release_notes = ENV["RELEASE_NOTES"] || "ìƒˆë¡œìš´ ë²„ì „ ì—…ë°ì´íŠ¸"
    version_name = ENV["VERSION_NAME"] || "1.0.0"
    version_code = ENV["VERSION_CODE"] || "1"

    puts "ğŸ“¦ ë°°í¬ ì •ë³´:"
    puts "  ë²„ì „: #{version_name} (#{version_code})"
    puts "  ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸: #{release_notes}"

    # Step 1: Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— Draftë¡œ ì—…ë¡œë“œ
    puts ""
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¤ 1ë‹¨ê³„: Draft ìƒíƒœë¡œ AAB ì—…ë¡œë“œ ì¤‘..."
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    upload_to_play_store(
      package_name: 'com.alom.romrom',        # Android íŒ¨í‚¤ì§€ ì´ë¦„
      track: 'internal',                      # ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™
      aab: ENV["AAB_PATH"],                   # AAB íŒŒì¼ ê²½ë¡œ
      json_key: ENV["GOOGLE_PLAY_JSON_KEY"],  # Service Account JSON ê²½ë¡œ
      skip_upload_apk: true,                  # APK ì—…ë¡œë“œ ì•ˆí•¨
      skip_upload_metadata: true,             # ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì•ˆí•¨
      skip_upload_images: true,               # ì´ë¯¸ì§€ ì—…ë¡œë“œ ì•ˆí•¨
      skip_upload_screenshots: true,          # ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ ì•ˆí•¨
      skip_upload_changelogs: false,          # Changelog ì—…ë¡œë“œ (metadata ë””ë ‰í† ë¦¬ì—ì„œ ìë™ ì¸ì‹)
      release_status: 'draft',                # Draft App ì œì•½ ìš°íšŒë¥¼ ìœ„í•´ ë¨¼ì € draftë¡œ ì—…ë¡œë“œ
      version_name: ENV["VERSION_NAME"],      # ë²„ì „ ì´ë¦„
      version_code: ENV["VERSION_CODE"]       # ë²„ì „ ì½”ë“œ
    )

    puts "âœ… Draft ì—…ë¡œë“œ ì™„ë£Œ!"
    puts ""
    
    # Step 2: ì‹¤í—˜ì  ê¸°ëŠ¥ - Draftë¥¼ Completedë¡œ ìë™ ì „í™˜ ì‹œë„
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ§ª 2ë‹¨ê³„: ì‹¤í—˜ì  ìë™ ì „í™˜ ì‹œë„ (Draft â†’ Completed)"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ’¡ Google Play APIë¥¼ ì‚¬ìš©í•˜ì—¬ draft ë¦´ë¦¬ì¦ˆë¥¼ completedë¡œ ì „í™˜í•©ë‹ˆë‹¤."
    puts "â±ï¸  API ë°˜ì˜ ëŒ€ê¸° ì¤‘... (10ì´ˆ)"
    sleep(10)
    
    begin
      require 'googleauth'
      require 'google/apis/androidpublisher_v3'
      
      puts "ğŸ” Service Account ì¸ì¦ ì¤‘..."
      
      # Google Play Developer API ì¸ì¦
      scopes = ['https://www.googleapis.com/auth/androidpublisher']
      authorizer = Google::Auth::ServiceAccountCredentials.make_creds(
        json_key_io: File.open(ENV["GOOGLE_PLAY_JSON_KEY"]),
        scope: scopes
      )
      authorizer.fetch_access_token!
      
      puts "âœ… ì¸ì¦ ì„±ê³µ!"
      
      # AndroidPublisher API í´ë¼ì´ì–¸íŠ¸ ìƒì„±
      service = Google::Apis::AndroidpublisherV3::AndroidPublisherService.new
      service.authorization = authorizer
      
      package_name = 'com.alom.romrom'
      
      puts "ğŸ“ Edit ì„¸ì…˜ ì‹œì‘ ì¤‘..."
      
      # 1. ìƒˆ Edit ì„¸ì…˜ ì‹œì‘
      edit = service.insert_edit(package_name)
      edit_id = edit.id
      
      puts "âœ… Edit ì„¸ì…˜ ìƒì„±: #{edit_id}"
      puts "ğŸ” Internal íŠ¸ë™ì—ì„œ Draft ë¦´ë¦¬ì¦ˆ ì¡°íšŒ ì¤‘..."
      
      # 2. Internal íŠ¸ë™ì˜ í˜„ì¬ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
      track = service.get_edit_track(package_name, edit_id, 'internal')
      
      puts "ğŸ“‹ íŠ¸ë™ ì •ë³´: #{track.releases.size}ê°œ ë¦´ë¦¬ì¦ˆ ë°œê²¬"
      
      # 3. ë°©ê¸ˆ ì—…ë¡œë“œí•œ Draft ë¦´ë¦¬ì¦ˆ ì°¾ê¸°
      latest_release = track.releases.find do |release|
        release.version_codes.include?(version_code.to_i) && release.status == 'draft'
      end
      
      if latest_release.nil?
        puts "âš ï¸ Draft ë¦´ë¦¬ì¦ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë²„ì „ ì½”ë“œ: #{version_code})"
        puts "ğŸ“‹ í˜„ì¬ íŠ¸ë™ì˜ ë¦´ë¦¬ì¦ˆ ëª©ë¡:"
        track.releases.each do |r|
          puts "  - ë²„ì „ ì½”ë“œ: #{r.version_codes.join(', ')}, ìƒíƒœ: #{r.status}"
        end
        raise "Draft release not found for version code #{version_code}"
      end
      
      puts "âœ… Draft ë¦´ë¦¬ì¦ˆ ë°œê²¬!"
      puts "   ë²„ì „ ì½”ë“œ: #{latest_release.version_codes.join(', ')}"
      puts "   í˜„ì¬ ìƒíƒœ: #{latest_release.status}"
      puts "   ë¦´ë¦¬ì¦ˆ ì´ë¦„: #{latest_release.name || 'N/A'}"
      
      puts ""
      puts "ğŸš€ ë¦´ë¦¬ì¦ˆ ìƒíƒœë¥¼ 'completed'ë¡œ ë³€ê²½ ì¤‘..."
      
      # 4. ë¦´ë¦¬ì¦ˆ ìƒíƒœë¥¼ completedë¡œ ë³€ê²½
      latest_release.status = 'completed'
      
      # 5. íŠ¸ë™ ì—…ë°ì´íŠ¸ ìš”ì²­
      updated_track = Google::Apis::AndroidpublisherV3::Track.new(
        track: 'internal',
        releases: [latest_release]
      )
      
      service.update_edit_track(package_name, edit_id, 'internal', updated_track)
      
      puts "âœ… íŠ¸ë™ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
      puts "ğŸ’¾ Edit ì„¸ì…˜ ì»¤ë°‹ ì¤‘ (ì‹¤ì œ ì ìš©)..."
      
      # 6. Edit ì»¤ë°‹ (ì‹¤ì œë¡œ Play Storeì— ë°˜ì˜)
      service.commit_edit(package_name, edit_id)
      
      puts ""
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "ğŸ‰ ìë™ ì¶œì‹œ ì„±ê³µ!"
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "âœ… ë²„ì „ #{version_name} (#{version_code})ì´ ë‚´ë¶€ í…ŒìŠ¤í„°ì—ê²Œ ìë™ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
      puts "ğŸ“± í…ŒìŠ¤í„°ëŠ” Play Storeì—ì„œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•©ë‹ˆë‹¤."
      puts "ğŸŠ í”„ë¡œë•ì…˜ ì¶œì‹œ ì—†ì´ ì™„ì „ ìë™í™” ì„±ê³µ!"
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
    rescue Google::Apis::ClientError => e
      puts ""
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "âš ï¸ ìë™ ì „í™˜ ì‹¤íŒ¨ - Google Play API ì œì•½"
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "ğŸ“‹ ì˜¤ë¥˜ ë©”ì‹œì§€: #{e.message}"
      puts ""
      
      # Draft App ì œì•½ í™•ì¸
      if e.message.include?("Only releases with status draft may be created on draft app")
        puts "ğŸ” ì‹¤í—˜ ê²°ê³¼: Draft App ì œì•½ì€ API ìˆ˜ì •ì—ë„ ì ìš©ë¨"
        puts ""
        puts "ğŸ“Š ì›ì¸ ë¶„ì„:"
        puts "  Google PlayëŠ” 'í•œ ë²ˆë„ í”„ë¡œë•ì…˜ ì¶œì‹œë¥¼ í•˜ì§€ ì•Šì€ ì•±(Draft App)'ì— ëŒ€í•´"
        puts "  APIë¥¼ í†µí•œ ìë™ ì¶œì‹œ(completed)ë¥¼ í—ˆìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        puts "  ì´ëŠ” ìƒì„±ë¿ë§Œ ì•„ë‹ˆë¼ ìˆ˜ì • ì‹œì—ë„ ë™ì¼í•˜ê²Œ ì ìš©ë˜ëŠ” ì •ì±…ì…ë‹ˆë‹¤."
        puts ""
        puts "ğŸ’¡ í•´ê²° ë°©ë²•:"
        puts "  1. í”„ë¡œë•ì…˜ íŠ¸ë™ì— ìµœì†Œ 1íšŒ ì¶œì‹œ"
        puts "  2. ì•± ìƒíƒœê°€ 'Published App'ìœ¼ë¡œ ì „í™˜ë¨"
        puts "  3. ì´í›„ë¶€í„°ëŠ” ì´ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤!"
        puts ""
        puts "ğŸ“‹ í˜„ì¬ í•„ìš”í•œ ìˆ˜ë™ ì‘ì—…:"
        puts "  1. Play Console ì ‘ì†: https://play.google.com/console"
        puts "  2. í…ŒìŠ¤íŠ¸ ë° ì¶œì‹œ â†’ ë‚´ë¶€ í…ŒìŠ¤íŠ¸"
        puts "  3. 'ë‹¤ìŒ' ë²„íŠ¼ í´ë¦­"
        puts "  4. 'ì €ì¥ ë° ì¶œì‹œ' ë²„íŠ¼ í´ë¦­"
        puts ""
        puts "ğŸ¯ í”„ë¡œë•ì…˜ 1íšŒ ì¶œì‹œ í›„:"
        puts "  ì´ ìŠ¤í¬ë¦½íŠ¸ê°€ iOS TestFlightì²˜ëŸ¼ ì™„ì „ ìë™ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤!"
      elsif e.message.include?("edit") && e.message.include?("not found")
        puts "ğŸ” ì‹¤í—˜ ê²°ê³¼: Edit ì„¸ì…˜ íƒ€ì´ë° ì´ìŠˆ"
        puts ""
        puts "ğŸ“Š ì›ì¸ ë¶„ì„:"
        puts "  ì²« ë²ˆì§¸ upload_to_play_store() í˜¸ì¶œë¡œ Editê°€ ì´ë¯¸ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤."
        puts "  ë³„ë„ Edit ì„¸ì…˜ì—ì„œ ë°©ê¸ˆ ìƒì„±ëœ ë¦´ë¦¬ì¦ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        puts ""
        puts "ğŸ’¡ ê¸°ìˆ ì  ì œì•½:"
        puts "  Fastlaneì˜ upload_to_play_storeëŠ” ë‚´ë¶€ì ìœ¼ë¡œ Editë¥¼ ìë™ ì»¤ë°‹í•˜ë¯€ë¡œ"
        puts "  ë™ì¼ ì„¸ì…˜ì—ì„œ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
      else
        puts "ğŸ” ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ"
        puts "ğŸ“‹ ë””ë²„ê¹… ì •ë³´:"
        puts "  ì˜¤ë¥˜ íƒ€ì…: #{e.class}"
        puts "  ìƒíƒœ ì½”ë“œ: #{e.status_code}" if e.respond_to?(:status_code)
        puts "  ì‘ë‹µ ë³¸ë¬¸: #{e.body[0..500]}" if e.respond_to?(:body)
      end
      
      puts ""
      puts "âœ… AAB ì—…ë¡œë“œëŠ” ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì›Œí¬í”Œë¡œìš°ëŠ” ì •ìƒ ì™„ë£Œ ì²˜ë¦¬ë©ë‹ˆë‹¤."
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
    rescue LoadError => e
      puts ""
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "âš ï¸ Google API ë¼ì´ë¸ŒëŸ¬ë¦¬ ëˆ„ë½"
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "ğŸ“‹ ì˜¤ë¥˜: #{e.message}"
      puts ""
      puts "ğŸ’¡ í•´ê²° ë°©ë²•:"
      puts "  gem install google-api-client"
      puts ""
      puts "âœ… AAB ì—…ë¡œë“œëŠ” ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì›Œí¬í”Œë¡œìš°ëŠ” ì •ìƒ ì™„ë£Œ ì²˜ë¦¬ë©ë‹ˆë‹¤."
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
    rescue => e
      puts ""
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜"
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "ğŸ“‹ ì˜¤ë¥˜ íƒ€ì…: #{e.class}"
      puts "ğŸ“‹ ì˜¤ë¥˜ ë©”ì‹œì§€: #{e.message}"
      puts "ğŸ“‹ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:"
      puts e.backtrace.first(10).join("\n") if e.respond_to?(:backtrace)
      puts ""
      puts "âœ… AAB ì—…ë¡œë“œëŠ” ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì›Œí¬í”Œë¡œìš°ëŠ” ì •ìƒ ì™„ë£Œ ì²˜ë¦¬ë©ë‹ˆë‹¤."
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    end
    
    puts ""
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì™„ë£Œ!"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¦ ë²„ì „: #{version_name} (#{version_code})"
    puts "ğŸ“‹ ìƒíƒœ: Draft ì—…ë¡œë“œ ì„±ê³µ"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  desc "Promote internal to alpha testing"
  lane :promote_to_alpha do
    upload_to_play_store(
      track: 'internal',
      track_promote_to: 'alpha',
      json_key: ENV["GOOGLE_PLAY_JSON_KEY"],
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Promote alpha to beta testing"
  lane :promote_to_beta do
    upload_to_play_store(
      track: 'alpha',
      track_promote_to: 'beta',
      json_key: ENV["GOOGLE_PLAY_JSON_KEY"],
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Promote beta to production"
  lane :promote_to_production do
    upload_to_play_store(
      track: 'beta',
      track_promote_to: 'production',
      json_key: ENV["GOOGLE_PLAY_JSON_KEY"],
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      rollout: '0.1'  # 10% ë‹¨ê³„ì  ì¶œì‹œ
    )
  end
end

def flutter_build(options)
  Dir.chdir(options[:project_dir]) do
    sh(
      "flutter",
      "build",
      options[:build],
      "--release",
      "--no-tree-shake-icons",
      "-v"
    )
  end
end

