default_platform(:android)

platform :android do
  desc "Build AAB for Play Store"
  lane :build_aab do
    flutter_build(
      build: 'appbundle',
      project_dir: '..'
    )
  end

  desc "Deploy to Play Store Internal Testing Track"
  lane :deploy_internal do
    # Release notes ì½ê¸°
    release_notes = ENV["RELEASE_NOTES"] || "ìƒˆë¡œìš´ ë²„ì „ ì—…ë°ì´íŠ¸"
    version_name = ENV["VERSION_NAME"] || "1.0.0"
    version_code = ENV["VERSION_CODE"] || "1"

    puts "ğŸ“¦ ë°°í¬ ì •ë³´:"
    puts "  ë²„ì „: #{version_name} (#{version_code})"
    puts "  ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸: #{release_notes}"

    # Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— ì—…ë¡œë“œ
    upload_to_play_store(
      track: 'internal',                      # ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™
      aab: ENV["AAB_PATH"],                   # AAB íŒŒì¼ ê²½ë¡œ
      json_key: ENV["GOOGLE_PLAY_JSON_KEY"],  # Service Account JSON ê²½ë¡œ
      skip_upload_apk: true,                  # APK ì—…ë¡œë“œ ì•ˆí•¨
      skip_upload_metadata: true,             # ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì•ˆí•¨
      skip_upload_images: true,               # ì´ë¯¸ì§€ ì—…ë¡œë“œ ì•ˆí•¨
      skip_upload_screenshots: true,          # ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ ì•ˆí•¨
      skip_upload_changelogs: false,          # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ëŠ” ì—…ë¡œë“œ
      release_status: 'completed',            # ì¦‰ì‹œ ë°°í¬
      rollout: '1.0'                          # 100% ë°°í¬
    )

    puts "âœ… Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì™„ë£Œ!"
    puts "ë²„ì „: #{version_name} (#{version_code})"
  end

  desc "Promote internal to alpha testing"
  lane :promote_to_alpha do
    upload_to_play_store(
      track: 'internal',
      track_promote_to: 'alpha',
      json_key: ENV["GOOGLE_PLAY_JSON_KEY"],
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Promote alpha to beta testing"
  lane :promote_to_beta do
    upload_to_play_store(
      track: 'alpha',
      track_promote_to: 'beta',
      json_key: ENV["GOOGLE_PLAY_JSON_KEY"],
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Promote beta to production"
  lane :promote_to_production do
    upload_to_play_store(
      track: 'beta',
      track_promote_to: 'production',
      json_key: ENV["GOOGLE_PLAY_JSON_KEY"],
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      rollout: '0.1'  # 10% ë‹¨ê³„ì  ì¶œì‹œ
    )
  end
end

def flutter_build(options)
  Dir.chdir(options[:project_dir]) do
    sh(
      "flutter",
      "build",
      options[:build],
      "--release",
      "--no-tree-shake-icons",
      "-v"
    )
  end
end

