# 첫 물품 등록 후 네비게이션 및 코치마크 표시 기능

## 기능 개요

### 핵심 기능 설명
사용자가 첫 물품을 등록한 후 자동으로 물품 상세 페이지로 이동하고, 상세 페이지에서 홈 탭으로 돌아왔을 때 코치마크를 표시하여 앱 사용 가이드를 제공하는 기능입니다.

### 개발 목적
- 신규 사용자의 첫 물품 등록 후 즉각적인 피드백 제공
- 자연스러운 앱 기능 안내를 통한 사용자 경험(UX) 개선
- 올바른 네비게이션 스택 관리로 뒤로가기 동작 일관성 확보
- 코치마크를 통한 주요 기능 온보딩 강화

### 주요 개선사항 요약
1. **네비게이션 플로우 개선**: 첫 물품 등록 후 "내 물건" 탭 → "홈" 탭 → 상세 화면으로 자동 이동
2. **코치마크 타이밍 최적화**: 상세 화면에서 홈으로 돌아올 때만 코치마크 표시
3. **백엔드 연동 강화**: `isFirstItemPosted` 플래그를 백엔드에서 받아 정확한 첫 등록 여부 판단
4. **상태 관리 개선**: `SharedPreferences`를 통한 `isCoachMarkShown` 플래그 관리로 중복 표시 방지
5. **이미지 표시 문제 해결**: 상세 화면 이동 시 올바른 이미지 크기 전달

---

## 기술 스택 및 키포인트

### 사용된 주요 기술
- **Flutter Framework**: 3.x
- **상태 관리**: StatefulWidget + setState
- **영속성 저장소**: SharedPreferences
- **위젯 간 통신**: GlobalKey
- **비동기 처리**: async/await, Future
- **네비게이션**: Navigator 2.0 API

### 핵심 문법 요소
1. **GlobalKey 패턴**
   ```dart
   static final GlobalKey<State<HomeTabScreen>> globalKey = GlobalKey();
   ```
   - 다른 위젯에서 특정 위젯의 state에 접근하기 위한 키
   - 위젯 트리 전체에서 유일한 참조 제공

2. **WidgetsBinding.instance.addPostFrameCallback**
   ```dart
   WidgetsBinding.instance.addPostFrameCallback((_) async {
     // 현재 프레임이 완료된 후 실행
   });
   ```
   - 위젯 렌더링 완료 후 작업 실행 보장

3. **SharedPreferences 비동기 저장**
   ```dart
   await prefs.setBool('isCoachMarkShown', true);
   ```

4. **Navigator.push with await**
   ```dart
   await Navigator.push(context, MaterialPageRoute(...));
   // push가 완료되고 pop될 때까지 대기
   ```

### 중요 디자인 패턴
1. **Observer Pattern**: UserInfo 상태 변경 감지
2. **Strategy Pattern**: 코치마크 표시 조건 전략
3. **State Pattern**: 네비게이션 플래그를 통한 상태 관리

---

## 상세 구현 내용

### 1. 백엔드 API 응답 구조 개선

#### ItemResponse 모델 확장
```dart
// lib/models/apis/responses/item_response.dart
class ItemResponse {
  final Item? item;
  final ItemPage? itemPage;
  final bool? isLiked;
  final bool? isFirstItemPosted; // 신규 추가

  ItemResponse({
    this.item,
    this.itemPage,
    this.isLiked,
    this.isFirstItemPosted,
  });
}
```

#### ItemApi 반환 타입 변경
```dart
// lib/services/apis/item_api.dart
Future<ItemResponse> postItem(ItemRequest request) async {
  const String url = '${AppUrls.baseUrl}/api/item/post';
  late ItemResponse itemResponse;
  
  await _apiService.post(
    url: url,
    formFields: formFields,
    onSuccess: (responseData) {
      itemResponse = ItemResponse.fromJson(responseData);
      debugPrint('물품 등록 성공: ${itemResponse.item?.itemName}');
    },
    onError: (error) {
      debugPrint('물품 등록 실패: $error');
      throw Exception('물품 등록 실패: $error');
    },
  );
  
  return itemResponse; // ItemResponse 반환
}
```

### 2. UserInfo 모델 개선

#### isCoachMarkShown 플래그 추가
```dart
// lib/models/user_info.dart
class UserInfo {
  bool? isFirstLogin;
  bool? isFirstItemPosted;
  bool? isCoachMarkShown; // 신규 추가
  bool? isItemCategorySaved;
  bool? isMemberLocationSaved;
  bool? isMarketingInfoAgreed;
  bool? isRequiredTermsAgreed;

  Future<void> saveLoginStatus({
    bool? isFirstLogin,
    bool? isFirstItemPosted,
    bool? isItemCategorySaved,
    bool? isMemberLocationSaved,
    bool? isMarketingInfoAgreed,
    bool? isRequiredTermsAgreed,
    bool? isCoachMarkShown, // 신규 추가
  }) async {
    final prefs = await SharedPreferences.getInstance();
    
    if (isCoachMarkShown != null) {
      await prefs.setBool('isCoachMarkShown', isCoachMarkShown);
      this.isCoachMarkShown = isCoachMarkShown;
    }
    // ... 다른 필드 저장
  }

  Future<void> getUserInfo() async {
    final prefs = await SharedPreferences.getInstance();
    
    isCoachMarkShown = prefs.getBool('isCoachMarkShown');
    // ... 다른 필드 로드
  }
}
```

### 3. 물품 등록 후 처리 로직 (register_input_form.dart)

```dart
// 등록 모드
final response = await ItemApi().postItem(itemRequest);
debugPrint('물품 등록 응답: isFirstItemPosted=${response.isFirstItemPosted}');

final userInfo = UserInfo();
await userInfo.getUserInfo();

// 첫 물품 등록인 경우 UserInfo 업데이트
if (response.isFirstItemPosted == true) {
  debugPrint('첫 물품 등록 확인! UserInfo 업데이트 중...');
  await userInfo.saveLoginStatus(
    isFirstLogin: false,
    isFirstItemPosted: true,
    isItemCategorySaved: userInfo.isItemCategorySaved ?? false,
    isMemberLocationSaved: userInfo.isMemberLocationSaved ?? false,
    isMarketingInfoAgreed: userInfo.isMarketingInfoAgreed ?? false,
    isRequiredTermsAgreed: userInfo.isRequiredTermsAgreed ?? false,
    isCoachMarkShown: userInfo.isCoachMarkShown,
  );
}

// itemId와 isFirstItemPosted를 함께 반환
if (context.mounted) {
  final resultData = {
    if (response.item?.itemId != null)
      'itemId': response.item!.itemId,
    'isFirstItemPosted': response.isFirstItemPosted ?? false,
  };
  Navigator.of(context).pop(resultData);
}
```

### 4. RegisterTabScreen에서 네비게이션 처리

```dart
// lib/screens/register_tab_screen.dart
onTap: () async {
  final result = await Navigator.push(
    context,
    MaterialPageRoute(builder: (_) => ItemRegisterScreen(...)),
  );
  
  debugPrint('ItemRegisterScreen에서 돌아옴: result=$result');
  
  _loadMyItems(isRefresh: true);
  
  // 첫 물품 등록인 경우 홈 탭으로 이동 후 상세 화면 표시
  if (result is Map<String, dynamic> &&
      result['isFirstItemPosted'] == true &&
      result['itemId'] != null) {
    debugPrint('첫 물건 등록 확인! 홈 탭으로 이동 시작...');
    _navigateToHomeAndShowDetail(result['itemId'] as String);
  }
}

void _navigateToHomeAndShowDetail(String itemId) {
  debugPrint('_navigateToHomeAndShowDetail 호출됨: itemId=$itemId');
  
  // 1. MainScreen의 GlobalKey로 홈 탭(인덱스 0)으로 전환
  final mainState = MainScreen.globalKey.currentState;
  if (mainState != null) {
    (mainState as dynamic).switchToTab(0);
  }
  
  // 2. HomeTabScreen의 GlobalKey로 상세 페이지로 이동
  WidgetsBinding.instance.addPostFrameCallback((_) {
    final homeState = HomeTabScreen.globalKey.currentState;
    if (homeState != null) {
      (homeState as dynamic).navigateToItemDetail(itemId);
    }
  });
}
```

### 5. HomeTabScreen 네비게이션 및 코치마크 로직

#### 상태 플래그 추가
```dart
// lib/screens/home_tab_screen.dart
class _HomeTabScreenState extends State<HomeTabScreen> {
  bool _isBlurShown = false;
  bool _isNavigatingToFirstItemDetail = false; // 신규 추가
  OverlayEntry? _overlayEntry;
  
  // ...
}
```

#### 상세 페이지 이동 메서드
```dart
void navigateToItemDetail(String itemId) {
  debugPrint('HomeTabScreen.navigateToItemDetail 호출됨: itemId=$itemId');
  
  // 첫 물품 상세 화면으로 이동 중임을 표시 (코치마크 미루기)
  _isNavigatingToFirstItemDetail = true;
  
  WidgetsBinding.instance.addPostFrameCallback((_) async {
    if (mounted) {
      final screenWidth = MediaQuery.of(context).size.width;
      final imageHeight = screenWidth;
      
      // Navigator.push로 상세 화면 이동 (await로 pop 대기)
      await Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => ItemDetailDescriptionScreen(
            itemId: itemId,
            imageSize: Size(screenWidth, imageHeight), // 올바른 이미지 크기
            currentImageIndex: 0,
            heroTag: 'first_item_$itemId',
            isMyItem: true,
            isRequestManagement: false,
          ),
        ),
      );
      
      // 상세 화면에서 돌아왔을 때 코치마크 표시
      debugPrint('상세 화면에서 돌아옴! 이제 코치마크를 표시합니다.');
      _isNavigatingToFirstItemDetail = false;
      _checkAndShowCoachMark();
    }
  });
}
```

#### 초기 화면 체크 로직
```dart
Future<void> _checkFirstMainScreen() async {
  debugPrint('_checkFirstMainScreen 호출됨');
  try {
    final userInfo = UserInfo();
    await userInfo.getUserInfo();

    debugPrint('UserInfo 로드 완료:');
    debugPrint('  - isFirstItemPosted: ${userInfo.isFirstItemPosted}');
    debugPrint('  - isCoachMarkShown: ${userInfo.isCoachMarkShown}');
    debugPrint('  - _isNavigatingToFirstItemDetail: $_isNavigatingToFirstItemDetail');

    // 블러 표시: 첫 물건 미등록 시
    final bool shouldShowBlur = userInfo.isFirstItemPosted != true;

    // 코치마크 표시: 첫 물건 등록 완료 && 미표시 && 상세 화면 이동 중 아님
    final bool shouldShowCoachMark = (userInfo.isFirstItemPosted == true) &&
        (userInfo.isCoachMarkShown != true) &&
        !_isNavigatingToFirstItemDetail;

    setState(() {
      _isBlurShown = shouldShowBlur;
    });

    if (shouldShowCoachMark) {
      debugPrint('✅ 코치마크 표시 조건 충족!');
      WidgetsBinding.instance.addPostFrameCallback((_) {
        _showCoachMarkOverlay();
      });
    }
  } catch (e) {
    debugPrint('⚠️ 첫 화면 체크 실패: $e');
    setState(() {
      _isBlurShown = false;
    });
  }
}
```

#### 상세 화면 복귀 시 코치마크 표시
```dart
Future<void> _checkAndShowCoachMark() async {
  debugPrint('_checkAndShowCoachMark 호출됨 (상세 화면에서 돌아옴)');
  try {
    final userInfo = UserInfo();
    await userInfo.getUserInfo();

    final bool shouldShowCoachMark = (userInfo.isFirstItemPosted == true) &&
        (userInfo.isCoachMarkShown != true);

    if (shouldShowCoachMark) {
      debugPrint('✅ 코치마크 표시 조건 충족!');
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (mounted) {
          _showCoachMarkOverlay();
        }
      });
    }
  } catch (e) {
    debugPrint('⚠️ 코치마크 체크 실패: $e');
  }
}
```

#### 코치마크 닫기 처리
```dart
void _closeCoachMark() async {
  _removeCoachMarkOverlay();
  
  final userInfo = UserInfo();
  await userInfo.getUserInfo();
  await userInfo.saveLoginStatus(
    isFirstLogin: userInfo.isFirstLogin ?? false,
    isFirstItemPosted: userInfo.isFirstItemPosted ?? false,
    isItemCategorySaved: userInfo.isItemCategorySaved ?? false,
    isMemberLocationSaved: userInfo.isMemberLocationSaved ?? false,
    isMarketingInfoAgreed: userInfo.isMarketingInfoAgreed ?? false,
    isRequiredTermsAgreed: userInfo.isRequiredTermsAgreed ?? false,
    isCoachMarkShown: true, // 코치마크 표시 완료 플래그
  );
  
  debugPrint('코치마크 닫기: isCoachMarkShown = true');
}
```

### 6. MainScreen GlobalKey 연결

#### MainScreen에 GlobalKey 추가
```dart
// lib/screens/main_screen.dart
class MainScreen extends StatefulWidget {
  const MainScreen({super.key});
  
  static final GlobalKey<State<MainScreen>> globalKey = GlobalKey();

  @override
  State<MainScreen> createState() => _MainScreenState();
}

class _MainScreenState extends State<MainScreen> {
  int _currentTabIndex = 0;
  
  // 외부에서 탭 전환 가능하도록 메서드 추가
  void switchToTab(int index) {
    if (index >= 0 && index < _navigationTabScreens.length) {
      setState(() {
        _currentTabIndex = index;
      });
    }
  }
  
  final List<Widget> _navigationTabScreens = [
    HomeTabScreen(key: HomeTabScreen.globalKey), // GlobalKey 연결
    // ...
  ];
}
```

#### 앱 진입점에서 GlobalKey 전달
```dart
// lib/main.dart
return MainScreen(key: MainScreen.globalKey);

// lib/widgets/login_button.dart
nextScreen = MainScreen(key: MainScreen.globalKey);

// lib/screens/onboarding/onboarding_flow_screen.dart
Navigator.of(context).pushAndRemoveUntil(
  MaterialPageRoute(builder: (context) => MainScreen(key: MainScreen.globalKey)),
  (route) => false,
);
```

### 7. 온보딩 완료 시 코치마크 플래그 초기화

```dart
// lib/screens/onboarding/category_selection_step.dart
enabledOnPressed: () async {
  try {
    await memberApi.savePreferredCategories(selectedCategories);
    
    // 온보딩 완료 시 코치마크 미표시 상태로 초기화
    final userInfo = UserInfo();
    await userInfo.getUserInfo();
    await userInfo.saveLoginStatus(
      isFirstLogin: userInfo.isFirstLogin ?? true,
      isFirstItemPosted: userInfo.isFirstItemPosted ?? false,
      isItemCategorySaved: userInfo.isItemCategorySaved ?? false,
      isMemberLocationSaved: userInfo.isMemberLocationSaved ?? false,
      isMarketingInfoAgreed: userInfo.isMarketingInfoAgreed ?? false,
      isRequiredTermsAgreed: userInfo.isRequiredTermsAgreed ?? false,
      isCoachMarkShown: false, // 명시적으로 false 설정
    );
    
    widget.onComplete();
    await RomAuthApi().fetchAndSaveMemberInfo();
  } catch (e) {
    debugPrint("Error: $e");
  }
},
```

---

## 개선 및 보완사항

### 이전 버전 대비 개선점

1. **네비게이션 플로우 수정**
   - **Before**: 첫 물품 등록 후 "내 물건" 탭에 머물러 있고, 홈 탭 이동 시 코치마크가 즉시 표시됨
   - **After**: 첫 물품 등록 후 자동으로 홈 탭 → 상세 화면으로 이동하고, 상세 화면에서 돌아올 때 코치마크 표시

2. **코치마크 타이밍 최적화**
   - **Before**: 홈 탭 전환 즉시 코치마크 표시 (상세 화면 위에 오버레이)
   - **After**: 상세 화면에서 홈으로 돌아올 때만 코치마크 표시 (자연스러운 플로우)

3. **백엔드 연동 정확도 향상**
   - **Before**: 프론트엔드에서만 첫 등록 여부 판단
   - **After**: 백엔드 API 응답의 `isFirstItemPosted` 플래그를 신뢰하여 정확한 판단

4. **이미지 표시 문제 해결**
   - **Before**: 상세 화면 이동 시 `imageSize: Size(0, 0)` 전달로 이미지 미표시
   - **After**: 화면 크기 기반 `Size(screenWidth, imageHeight)` 전달로 정상 표시

5. **상태 관리 개선**
   - **Before**: 코치마크 중복 표시 방지 로직 부재
   - **After**: `isCoachMarkShown` 플래그로 한 번만 표시되도록 보장

### 신규 추가 기능

1. **GlobalKey 기반 위젯 간 통신**
   - `MainScreen.globalKey`와 `HomeTabScreen.globalKey`를 통한 탭 전환 및 메서드 호출

2. **네비게이션 플래그 관리**
   - `_isNavigatingToFirstItemDetail` 플래그로 코치마크 표시 타이밍 제어

3. **코치마크 표시 조건 로직 분리**
   - `_checkFirstMainScreen()`: 초기 진입 시 체크
   - `_checkAndShowCoachMark()`: 상세 화면 복귀 시 체크

4. **온보딩 완료 시 초기화**
   - 온보딩 완료 시점에 `isCoachMarkShown: false` 명시적 설정

### 버그 수정 내역

1. **빌드 에러 수정**
   - `context.navigateTo()`가 `void` 반환하여 `.then()` 사용 불가
   - `Navigator.push()` + `await` 패턴으로 변경

2. **Import 누락 수정**
   - `category_selection_step.dart`에 `UserInfo` import 추가

3. **GlobalKey 할당 오류 수정**
   - `Scaffold`가 아닌 `MainScreen` 위젯 자체에 GlobalKey 할당

4. **_pageSize 값 복구**
   - 테스트 중 변경된 `_pageSize = 1`을 원래 값 `10`으로 복구

### 성능 개선 사항

1. **불필요한 상태 업데이트 방지**
   - `_isNavigatingToFirstItemDetail` 플래그로 코치마크 오버레이 생성 방지

2. **에러 핸들링 강화**
   - `_checkFirstMainScreen()`에 try-catch 추가로 안정성 향상

3. **메모리 관리**
   - `_overlayEntry` null 체크 및 안전한 제거

---

## 사용 가이드

### 기본 사용법

#### 1. 신규 회원 가입 및 온보딩
```
1. 앱 실행
2. 소셜 로그인 (카카오/네이버 등)
3. 약관 동의
4. 위치 설정
5. 선호 카테고리 선택
   → 이 시점에 isCoachMarkShown = false로 초기화
```

#### 2. 첫 물품 등록
```
1. 메인 화면 → "내 물건" 탭
2. "물품 등록" 버튼 클릭
3. 물품 정보 입력 (이미지, 제목, 설명, 가격 등)
4. "등록" 버튼 클릭
   → 백엔드에서 isFirstItemPosted: true 응답
   → UserInfo 업데이트
```

#### 3. 자동 네비게이션 플로우
```
물품 등록 완료
  ↓
RegisterTabScreen.pop(result)
  ↓
RegisterTabScreen._navigateToHomeAndShowDetail() 호출
  ↓
MainScreen.switchToTab(0) - 홈 탭으로 전환
  ↓
HomeTabScreen.navigateToItemDetail() 호출
  ↓
_isNavigatingToFirstItemDetail = true 설정
  ↓
Navigator.push → ItemDetailDescriptionScreen 표시
  ↓
[사용자가 상세 화면에서 뒤로가기 클릭]
  ↓
Navigator.pop 완료
  ↓
_isNavigatingToFirstItemDetail = false 설정
  ↓
_checkAndShowCoachMark() 호출
  ↓
코치마크 오버레이 표시 (PageView 6장)
```

#### 4. 코치마크 닫기
```
1. 코치마크 이미지 터치로 페이지 넘기기 (1→2→3→4→5→6)
2. 6번째 페이지에서 터치
   → _closeCoachMark() 호출
   → isCoachMarkShown = true 저장
   → 오버레이 제거
```

### 고급 설정 옵션

#### UserInfo 플래그 수동 설정 (개발/테스트용)
```dart
final userInfo = UserInfo();
await userInfo.getUserInfo();

// 코치마크 재표시 (테스트용)
await userInfo.saveLoginStatus(
  isFirstLogin: userInfo.isFirstLogin ?? false,
  isFirstItemPosted: true, // 유지
  isCoachMarkShown: false, // 재표시를 위해 false
  // ... 다른 플래그
);
```

#### 코치마크 강제 표시 (디버깅용)
```dart
// home_tab_screen.dart의 initState()에서
@override
void initState() {
  super.initState();
  _loadInitialItems();
  _loadMyCards();
  // _checkFirstMainScreen(); // 주석 처리
  
  // 강제 표시
  WidgetsBinding.instance.addPostFrameCallback((_) {
    _showCoachMarkOverlay();
  });
}
```

### 실제 사용 예시

#### 예시 1: 정상 플로우
```
[신규 사용자]
1. 회원 가입 → 온보딩 완료
   → isFirstItemPosted: false, isCoachMarkShown: false
   
2. 첫 물품 등록
   → isFirstItemPosted: true, isCoachMarkShown: false
   → 홈 탭 → 상세 화면 자동 이동
   
3. 상세 화면에서 뒤로가기
   → 홈 탭 표시
   → 코치마크 오버레이 표시
   
4. 코치마크 완료
   → isFirstItemPosted: true, isCoachMarkShown: true
   
5. 이후 앱 재실행
   → 코치마크 미표시 (이미 true)
```

#### 예시 2: 기존 사용자 (이미 물품 등록 경험 있음)
```
[기존 사용자]
1. 앱 실행
   → isFirstItemPosted: true (백엔드에서 관리)
   
2. 물품 등록
   → isFirstItemPosted: false (백엔드 응답)
   → 일반 플로우 (자동 이동 없음)
```

### 주의사항 및 제한사항

1. **GlobalKey 사용 시 주의사항**
   - GlobalKey는 위젯당 하나만 존재해야 함
   - `currentState`가 null일 수 있으므로 항상 null 체크 필요
   - 위젯이 dispose된 후 접근하면 에러 발생

2. **SharedPreferences 비동기 처리**
   - 모든 `getUserInfo()`, `saveLoginStatus()` 호출은 `await` 필수
   - 동시 호출 시 race condition 가능성 있음

3. **백엔드 의존성**
   - `isFirstItemPosted` 플래그는 백엔드가 정확히 관리해야 함
   - 백엔드 응답이 null인 경우 처리 로직 필요

4. **네비게이션 타이밍**
   - `WidgetsBinding.instance.addPostFrameCallback` 사용으로 프레임 완료 대기
   - 너무 빠른 네비게이션 시도 시 context 에러 가능

5. **코치마크 이미지**
   - 6장의 코치마크 이미지가 `assets/images/` 경로에 존재해야 함
   - 이미지 누락 시 빌드 에러 발생

---

## 테스트 가이드

### 테스트 환경 설정

#### 1. 테스트 계정 생성
```
- 새로운 카카오 계정으로 로그인
- 또는 기존 계정 탈퇴 후 재가입
```

#### 2. 개발자 모드 활성화
```dart
// lib/main.dart
void main() {
  debugPrint('======== 개발자 모드: 코치마크 테스트 ========');
  runApp(MyApp());
}
```

#### 3. SharedPreferences 초기화 (필요 시)
```dart
final prefs = await SharedPreferences.getInstance();
await prefs.clear(); // 모든 저장 데이터 삭제
```

### 단위 테스트 방법

#### Test Case 1: 첫 물품 등록 플래그 확인
```dart
test('첫 물품 등록 시 isFirstItemPosted 플래그 업데이트', () async {
  // Given
  final userInfo = UserInfo();
  await userInfo.saveLoginStatus(
    isFirstItemPosted: false,
    isCoachMarkShown: false,
  );
  
  // When
  await userInfo.saveLoginStatus(isFirstItemPosted: true);
  await userInfo.getUserInfo();
  
  // Then
  expect(userInfo.isFirstItemPosted, true);
});
```

#### Test Case 2: 코치마크 표시 조건
```dart
test('코치마크 표시 조건: isFirstItemPosted=true, isCoachMarkShown=false', () {
  final isFirstItemPosted = true;
  final isCoachMarkShown = false;
  final isNavigating = false;
  
  final shouldShowCoachMark = (isFirstItemPosted) &&
      (!isCoachMarkShown) &&
      (!isNavigating);
  
  expect(shouldShowCoachMark, true);
});
```

#### Test Case 3: GlobalKey 접근
```dart
testWidgets('GlobalKey를 통한 HomeTabScreen 접근', (tester) async {
  await tester.pumpWidget(
    MaterialApp(
      home: MainScreen(key: MainScreen.globalKey),
    ),
  );
  
  final mainState = MainScreen.globalKey.currentState;
  expect(mainState, isNotNull);
  
  // switchToTab 메서드 호출 테스트
  (mainState as dynamic).switchToTab(0);
  await tester.pump();
  
  // 탭 전환 확인
  expect(find.byType(HomeTabScreen), findsOneWidget);
});
```

### 통합 테스트 시나리오

#### 시나리오 1: 전체 플로우 테스트
```
1. 앱 시작
   → 확인: 로그인 화면 표시
   
2. 카카오 로그인
   → 확인: 온보딩 화면 표시
   
3. 온보딩 완료 (약관 동의 → 위치 설정 → 카테고리 선택)
   → 확인: 메인 화면 표시 (홈 탭)
   → 확인: 블러 효과 표시 (물품 없음)
   → 확인: isCoachMarkShown = false
   
4. "내 물건" 탭 → "물품 등록" 버튼 클릭
   → 확인: 물품 등록 화면 표시
   
5. 물품 정보 입력 후 "등록" 버튼 클릭
   → 확인: 백엔드 API 호출 (POST /api/item/post)
   → 확인: 응답에 isFirstItemPosted: true 포함
   → 확인: UserInfo.isFirstItemPosted = true 업데이트
   
6. 자동 네비게이션 확인
   → 확인: 홈 탭으로 전환
   → 확인: 상세 화면 표시 (물품 정보, 이미지 정상 표시)
   → 확인: 코치마크 미표시 (_isNavigatingToFirstItemDetail = true)
   
7. 상세 화면에서 뒤로가기 버튼 클릭
   → 확인: 홈 탭으로 복귀
   → 확인: 코치마크 오버레이 표시
   → 확인: 코치마크 1번 페이지 표시
   
8. 코치마크 터치로 페이지 넘기기 (6번까지)
   → 확인: 각 페이지 전환 애니메이션
   → 확인: 6번 페이지에서 터치 시 오버레이 제거
   → 확인: isCoachMarkShown = true 저장
   
9. 앱 재시작
   → 확인: 코치마크 미표시 (이미 true)
```

#### 시나리오 2: 두 번째 물품 등록 테스트
```
1. 이미 첫 물품 등록 완료된 상태
   → isFirstItemPosted: true, isCoachMarkShown: true
   
2. "물품 등록" 버튼으로 두 번째 물품 등록
   → 확인: 백엔드 응답 isFirstItemPosted: false
   → 확인: 자동 네비게이션 미발생
   → 확인: "내 물건" 탭에 머물러 있음
```

### 성능 테스트 방법

#### 1. 네비게이션 응답 속도
```
- 물품 등록 완료 후 상세 화면 표시까지 소요 시간 측정
- 목표: 1초 이내
```

#### 2. 코치마크 오버레이 렌더링
```
- 코치마크 오버레이 표시까지 소요 시간 측정
- 목표: 500ms 이내
```

#### 3. SharedPreferences 읽기/쓰기 속도
```dart
final stopwatch = Stopwatch()..start();
final userInfo = UserInfo();
await userInfo.getUserInfo();
stopwatch.stop();
debugPrint('getUserInfo 소요 시간: ${stopwatch.elapsedMilliseconds}ms');
```

---

## API 명세

### POST /api/item/post

#### 요청
```http
POST /api/item/post HTTP/1.1
Host: api.romrom.xyz
Authorization: Bearer {accessToken}
Content-Type: multipart/form-data

itemName: "테스트 물품"
itemDescription: "물품 설명"
itemCategory: "VEHICLES_MOTORCYCLES"
itemCondition: "SLIGHTLY_USED"
itemTradeOptions: "DIRECT_ONLY"
itemPrice: "10000"
itemImageUrls: "http://..."
longitude: "127.10379"
latitude: "37.51395"
```

#### 응답 (첫 물품 등록)
```json
{
  "item": {
    "itemId": "a50502aa-fb4a-4a5f-bab8-ff14512ff896",
    "itemName": "테스트 물품",
    "itemDescription": "물품 설명",
    "member": {
      "memberId": "3e4cb723-ecb6-4204-858a-ab54f140fba5",
      "email": "user@example.com",
      "nickname": "테스트유저",
      "isFirstItemPosted": true
    },
    "itemImages": [
      {
        "imageUrl": "http://..."
      }
    ],
    "price": 10000
  },
  "itemPage": null,
  "isLiked": null,
  "isFirstItemPosted": true  // ← 핵심 플래그
}
```

#### 응답 (두 번째 이후 물품 등록)
```json
{
  "item": { ... },
  "isFirstItemPosted": false  // ← false 반환
}
```

### 에러 처리
```json
{
  "error": "물품 등록 실패",
  "message": "이미지 업로드 실패",
  "statusCode": 500
}
```

---

## 실행 조건 및 환경

### 필수 시스템 요구사항
- **Flutter SDK**: 3.0 이상
- **Dart SDK**: 3.0 이상
- **iOS**: 12.0 이상
- **Android**: API 21 (Android 5.0) 이상

### 환경 변수 설정
```yaml
# pubspec.yaml
dependencies:
  flutter:
    sdk: flutter
  shared_preferences: ^2.2.0
  flutter_screenutil: ^5.9.0
```

### 의존성 패키지
```yaml
dependencies:
  # 네비게이션
  flutter:
    sdk: flutter
  
  # 상태 영속성
  shared_preferences: ^2.2.0
  
  # 화면 크기 대응
  flutter_screenutil: ^5.9.0
  
  # 이미지 표시
  cached_network_image: ^3.0.0
  
  # HTTP 통신
  http: ^1.0.0
```

### 특수 조건 및 제약사항

1. **백엔드 API 의존성**
   - `POST /api/item/post` 엔드포인트가 `isFirstItemPosted` 플래그를 정확히 반환해야 함
   - 백엔드는 사용자별 첫 물품 등록 여부를 DB에서 관리

2. **코치마크 이미지 필수**
   ```
   assets/images/coachMark1.png
   assets/images/coachMark2.png
   assets/images/coachMark3.png
   assets/images/coachMark4.png
   assets/images/coachMark5.png
   assets/images/coachMark6.png
   ```

3. **GlobalKey 충돌 방지**
   - 동일한 GlobalKey를 여러 위젯에 할당하면 안 됨
   - 앱 전체에서 `MainScreen.globalKey`, `HomeTabScreen.globalKey`는 단 하나씩만 존재

4. **네비게이션 스택 관리**
   - 홈 탭의 네비게이션 스택과 내 물건 탭의 네비게이션 스택이 독립적으로 관리됨
   - 상세 화면은 홈 탭의 네비게이션 스택에 push되어야 뒤로가기 시 홈 탭으로 복귀

---

## 문제 해결 가이드

### 일반적인 이슈 해결방법

#### 1. 코치마크가 표시되지 않는 경우

**증상**: 첫 물품 등록 후 상세 화면에서 돌아왔는데 코치마크가 안 뜸

**원인 분석**:
```
1. isFirstItemPosted가 false인 경우
   → 백엔드 응답 확인
   
2. isCoachMarkShown이 이미 true인 경우
   → SharedPreferences 확인
   
3. _isNavigatingToFirstItemDetail이 true인 경우
   → 플래그 리셋 로직 확인
```

**해결 방법**:
```dart
// SharedPreferences 초기화
final prefs = await SharedPreferences.getInstance();
await prefs.remove('isCoachMarkShown');

// UserInfo 확인
final userInfo = UserInfo();
await userInfo.getUserInfo();
debugPrint('isFirstItemPosted: ${userInfo.isFirstItemPosted}');
debugPrint('isCoachMarkShown: ${userInfo.isCoachMarkShown}');
```

#### 2. 상세 화면으로 이동하지 않는 경우

**증상**: 첫 물품 등록 후 "내 물건" 탭에 머물러 있음

**원인 분석**:
```
1. result['isFirstItemPosted']가 false
   → 백엔드 API 응답 로그 확인
   
2. result['itemId']가 null
   → ItemResponse.item?.itemId 확인
   
3. GlobalKey.currentState가 null
   → MainScreen, HomeTabScreen의 GlobalKey 할당 확인
```

**해결 방법**:
```dart
// 디버그 로그 확인
debugPrint('ItemRegisterScreen에서 돌아옴: result=$result');
debugPrint('MainScreen.globalKey.currentState: ${MainScreen.globalKey.currentState}');
debugPrint('HomeTabScreen.globalKey.currentState: ${HomeTabScreen.globalKey.currentState}');
```

#### 3. 이미지가 표시되지 않는 경우

**증상**: 상세 화면에서 물품 이미지가 안 보임

**원인 분석**:
```
1. imageSize가 Size(0, 0)
   → navigateToItemDetail() 메서드 확인
   
2. itemImageUrls가 비어있음
   → 백엔드 응답 확인
```

**해결 방법**:
```dart
// 올바른 imageSize 전달
final screenWidth = MediaQuery.of(context).size.width;
final imageHeight = screenWidth;

ItemDetailDescriptionScreen(
  imageSize: Size(screenWidth, imageHeight), // ✅
  // imageSize: Size(0, 0), // ❌
);
```

### 디버깅 방법

#### 1. 전체 플로우 디버그 로그 활성화
```dart
// lib/screens/register_tab_screen.dart
debugPrint('====================================');
debugPrint('ItemRegisterScreen에서 돌아옴: result=$result');
debugPrint('result type: ${result.runtimeType}');
if (result is Map<String, dynamic>) {
  debugPrint('  - isFirstItemPosted: ${result['isFirstItemPosted']}');
  debugPrint('  - itemId: ${result['itemId']}');
}
debugPrint('====================================');

// lib/screens/home_tab_screen.dart
debugPrint('====================================');
debugPrint('HomeTabScreen.navigateToItemDetail 호출됨: itemId=$itemId');
debugPrint('mounted: $mounted');
debugPrint('====================================');

debugPrint('====================================');
debugPrint('_checkFirstMainScreen 호출됨');
debugPrint('UserInfo 로드 완료:');
debugPrint('  - isFirstItemPosted: ${userInfo.isFirstItemPosted}');
debugPrint('  - isCoachMarkShown: ${userInfo.isCoachMarkShown}');
debugPrint('  - _isNavigatingToFirstItemDetail: $_isNavigatingToFirstItemDetail');
debugPrint('====================================');
```

#### 2. 백엔드 API 응답 확인
```dart
// lib/services/apis/item_api.dart
onSuccess: (responseData) {
  debugPrint('====================================');
  debugPrint('백엔드 응답: ${jsonEncode(responseData)}');
  debugPrint('====================================');
  itemResponse = ItemResponse.fromJson(responseData);
},
```

#### 3. Flutter DevTools 사용
```
1. flutter run 실행
2. 터미널에 표시된 DevTools URL 클릭
3. Widget Inspector → 위젯 트리 확인
4. Network → API 호출 내역 확인
5. Logging → debugPrint 로그 확인
```

### 로깅 및 모니터링

#### 로그 레벨 설정
```dart
// lib/main.dart
void main() {
  // 개발 모드
  if (kDebugMode) {
    debugPrint('====== 개발 모드: 상세 로그 활성화 ======');
  }
  
  // 프로덕션 모드
  if (kReleaseMode) {
    debugPrint = (String? message, {int? wrapWidth}) {}; // 로그 비활성화
  }
  
  runApp(MyApp());
}
```

#### 주요 로그 포인트
```
1. 물품 등록 완료 시점
   → "물품 등록 응답: isFirstItemPosted=true"
   
2. UserInfo 업데이트 시점
   → "첫 물품 등록 확인! UserInfo 업데이트 중..."
   
3. 홈 탭 전환 시점
   → "홈 탭(인덱스 0)으로 전환 시도..."
   
4. 상세 화면 이동 시점
   → "HomeTabScreen의 navigateToItemDetail 호출 시도..."
   
5. 상세 화면 복귀 시점
   → "상세 화면에서 돌아옴! 이제 코치마크를 표시합니다."
   
6. 코치마크 표시 조건 체크
   → "✅ 코치마크 표시 조건 충족!" or "❌ 코치마크 표시 조건 불충족"
```

### 트러블슈팅 체크리스트

- [ ] 백엔드 API가 `isFirstItemPosted` 플래그를 정확히 반환하는가?
- [ ] `ItemResponse` 모델에 `isFirstItemPosted` 필드가 추가되었는가?
- [ ] `UserInfo` 모델에 `isCoachMarkShown` 필드가 추가되었는가?
- [ ] `MainScreen`과 `HomeTabScreen`에 GlobalKey가 올바르게 할당되었는가?
- [ ] 모든 진입점(`main.dart`, `login_button.dart`, `onboarding_flow_screen.dart`)에서 GlobalKey를 전달하는가?
- [ ] 코치마크 이미지 6장이 `assets/images/` 폴더에 존재하는가?
- [ ] `pubspec.yaml`에 이미지 경로가 등록되었는가?
- [ ] `_isNavigatingToFirstItemDetail` 플래그가 올바르게 초기화/리셋되는가?
- [ ] `Navigator.push()`와 `await`를 사용하여 pop 대기하는가?
- [ ] `mounted` 체크를 통해 위젯이 dispose되지 않았는지 확인하는가?

---

## 참고 자료

### 관련 문서 링크
- [Flutter GlobalKey Documentation](https://api.flutter.dev/flutter/widgets/GlobalKey-class.html)
- [Flutter Navigation and Routing](https://docs.flutter.dev/ui/navigation)
- [SharedPreferences Plugin](https://pub.dev/packages/shared_preferences)
- [WidgetsBinding Docs](https://api.flutter.dev/flutter/widgets/WidgetsBinding-class.html)

### 코드 저장소 정보
- 저장소: RomRom-FE
- 브랜치: main
- 버전: 1.3.9

### 추가 학습 자료
- Flutter 위젯 생명주기 (initState, dispose, mounted)
- Flutter 네비게이션 스택 관리
- Overlay와 OverlayEntry를 활용한 전역 오버레이
- GlobalKey vs BuildContext 차이점
- SharedPreferences를 활용한 로컬 상태 영속성

---

## 구현 플로우 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                        첫 물품 등록 플로우                         │
└─────────────────────────────────────────────────────────────────┘

[사용자] "물품 등록" 버튼 클릭
    ↓
[RegisterTabScreen] ItemRegisterScreen으로 이동
    ↓
[ItemRegisterScreen → RegisterInputForm] 물품 정보 입력
    ↓
[RegisterInputForm] "등록" 버튼 클릭
    ↓
[ItemApi] POST /api/item/post 호출
    ↓
[Backend] isFirstItemPosted: true 응답
    ↓
[RegisterInputForm] UserInfo.isFirstItemPosted = true 저장
    ↓
[RegisterInputForm] Navigator.pop(result) → RegisterTabScreen 복귀
    ↓
[RegisterTabScreen] result['isFirstItemPosted'] == true 확인
    ↓
[RegisterTabScreen] _navigateToHomeAndShowDetail(itemId) 호출
    ↓
    ├─ [MainScreen.globalKey] switchToTab(0) 호출 → 홈 탭 전환
    │
    └─ [HomeTabScreen.globalKey] navigateToItemDetail(itemId) 호출
           ↓
       [HomeTabScreen] _isNavigatingToFirstItemDetail = true 설정
           ↓
       [HomeTabScreen] Navigator.push → ItemDetailDescriptionScreen
           ↓
       [사용자] 상세 화면에서 물품 정보 확인
           ↓
       [사용자] 뒤로가기 버튼 클릭
           ↓
       [HomeTabScreen] Navigator.pop 완료
           ↓
       [HomeTabScreen] _isNavigatingToFirstItemDetail = false 설정
           ↓
       [HomeTabScreen] _checkAndShowCoachMark() 호출
           ↓
           ├─ UserInfo.isFirstItemPosted == true 확인
           ├─ UserInfo.isCoachMarkShown == false 확인
           └─ 조건 충족!
                  ↓
       [HomeTabScreen] _showCoachMarkOverlay() 호출
           ↓
       [OverlayEntry] 코치마크 PageView (6장) 표시
           ↓
       [사용자] 코치마크 터치로 페이지 넘김 (1→2→3→4→5→6)
           ↓
       [HomeTabScreen] _closeCoachMark() 호출
           ↓
       [UserInfo] isCoachMarkShown = true 저장
           ↓
       [OverlayEntry] 오버레이 제거
           ↓
       [완료] 이후 코치마크 미표시


┌─────────────────────────────────────────────────────────────────┐
│                    코치마크 표시 조건 플로우                       │
└─────────────────────────────────────────────────────────────────┘

[_checkFirstMainScreen() 또는 _checkAndShowCoachMark() 호출]
    ↓
UserInfo.getUserInfo() 호출
    ↓
┌─────────────────────────────────────────────────┐
│ isFirstItemPosted == true?                      │
│    NO → 코치마크 미표시                          │
│    YES ↓                                        │
│                                                 │
│ isCoachMarkShown == false?                      │
│    NO → 코치마크 미표시 (이미 표시함)             │
│    YES ↓                                        │
│                                                 │
│ _isNavigatingToFirstItemDetail == false?        │
│    NO → 코치마크 미표시 (상세 화면 이동 중)       │
│    YES ↓                                        │
│                                                 │
│ ✅ 코치마크 표시!                                │
└─────────────────────────────────────────────────┘
```

---

## 결론

본 기능은 사용자의 첫 물품 등록 후 자연스러운 네비게이션 플로우와 적절한 타이밍의 코치마크 표시를 통해 신규 사용자의 앱 사용 경험을 크게 개선했습니다. 

특히 GlobalKey를 활용한 위젯 간 통신, 네비게이션 플래그를 통한 타이밍 제어, SharedPreferences를 활용한 상태 영속성 관리는 복잡한 사용자 플로우를 안정적으로 구현하는 데 핵심적인 역할을 했습니다.

향후 개선 방향으로는 상태 관리 라이브러리(Provider, Riverpod 등) 도입을 통한 GlobalKey 의존성 감소, 코치마크 애니메이션 개선, A/B 테스트를 통한 코치마크 효과 측정 등을 고려할 수 있습니다.

