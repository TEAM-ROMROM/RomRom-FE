name: CHANGELOG ìë™ ì—…ë°ì´íŠ¸

on:
  pull_request:
    types: [opened, synchronize]
    branches: ["deploy"]

jobs:
  update-changelog:
    name: CHANGELOG.md ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: main

      - name: í˜„ì¬ ë²„ì „ í™•ì¸
        id: get_version
        run: |
          CURRENT_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          VERSION=$(echo $CURRENT_VERSION | cut -d'+' -f1)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "í˜„ì¬ ë²„ì „: $CURRENT_VERSION"

      - name: CodeRabbit Summary ì¶”ì¶œ ëŒ€ê¸° (5ë¶„)
        run: |
          echo "CodeRabbitì´ Summaryë¥¼ ì‘ì„±í•  ë•Œê¹Œì§€ 5ë¶„ ëŒ€ê¸° ì¤‘..."
          echo "í˜„ì¬ ì‹œê°„: $(date)"
          sleep 300
          echo "ëŒ€ê¸° ì™„ë£Œ ì‹œê°„: $(date)"

      - name: PRì—ì„œ CodeRabbit Summary ì¶”ì¶œ
        id: extract_summary
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="https://github.com/${{ github.repository }}/pull/${PR_NUMBER}"
          
          echo "PR Number: $PR_NUMBER"
          echo "PR URL: $PR_URL"
          echo "Repository: ${{ github.repository }}"
          echo "Event Action: ${{ github.event.action }}"
          echo "Source Branch: ${{ github.event.pull_request.head.ref }}"
          echo "Target Branch: ${{ github.event.pull_request.base.ref }}"
          
          # GitHub APIë¡œ PRì˜ HTML ê°€ì ¸ì˜¤ê¸°
          echo "GitHub API í˜¸ì¶œ ì¤‘..."
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.html" \
               "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}" \
               > pr_content.html
          
          echo "API ì‘ë‹µ í¬ê¸°: $(wc -c < pr_content.html) bytes"
          
          # CodeRabbit Summary ë¶€ë¶„ ì¶”ì¶œ
          if grep -q "Summary by CodeRabbit" pr_content.html; then
            echo "CodeRabbit Summary ë°œê²¬ë¨"
            
            # CodeRabbit Summary ì „ì²´ ì„¹ì…˜ ì¶”ì¶œ (Summary by CodeRabbitë¶€í„° ë‹¤ìŒ h2 íƒœê·¸ê¹Œì§€)
            sed -n '/<h2[^>]*>Summary by CodeRabbit<\/h2>/,/<h2[^>]*>/p' pr_content.html | sed '$d' > summary_section.html
            
            # Summaryë§Œ ìˆê³  ë‹¤ìŒ h2ê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ìœ„í•œ ëŒ€ì•ˆ
            if [ ! -s summary_section.html ]; then
              sed -n '/<h2[^>]*>Summary by CodeRabbit<\/h2>/,$p' pr_content.html > summary_section.html
            fi
            
            # HTMLì„ ê¹”ë”í•œ Markdownìœ¼ë¡œ ë³€í™˜
            cat summary_section.html | \
            # h2 íƒœê·¸ë¥¼ ## ë¡œ ë³€í™˜
            sed 's/<h2[^>]*>Summary by CodeRabbit<\/h2>/## Summary by CodeRabbit/g' | \
            # ul/li íƒœê·¸ë¥¼ ë§ˆí¬ë‹¤ìš´ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
            sed 's/<ul[^>]*>/\n/g' | \
            sed 's/<\/ul>/\n/g' | \
            sed 's/<li[^>]*>/\n- /g' | \
            sed 's/<\/li>//g' | \
            # strong íƒœê·¸ë¥¼ ** ë¡œ ë³€í™˜
            sed 's/<strong>/\*\*/g' | \
            sed 's/<\/strong>/\*\*/g' | \
            # p íƒœê·¸ ì œê±°
            sed 's/<p[^>]*>//g' | \
            sed 's/<\/p>//g' | \
            # br íƒœê·¸ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ
            sed 's/<br[^>]*>/\n/g' | \
            # code íƒœê·¸ë¥¼ ë°±í‹±ìœ¼ë¡œ
            sed 's/<code[^>]*>/`/g' | \
            sed 's/<\/code>/`/g' | \
            # ê¸°íƒ€ HTML íƒœê·¸ ì œê±°
            sed 's/<[^>]*>//g' | \
            # HTML ì—”í‹°í‹° ë³€í™˜
            sed 's/&amp;/\&/g' | \
            sed 's/&lt;/</g' | \
            sed 's/&gt;/>/g' | \
            sed 's/&quot;/"/g' | \
            sed 's/&#39;/'"'"'/g' | \
            # ì—°ì†ëœ ë¹ˆ ì¤„ ì œê±°
            sed '/^$/N;/^\n$/d' | \
            # ì•ë’¤ ê³µë°± ì œê±°
            sed 's/^[ \t]*//;s/[ \t]*$//' | \
            # ë¹ˆ ì¤„ ì œê±°
            sed '/^$/d' > summary_clean.md
            
            # ê²°ê³¼ í™•ì¸ ë° ì •ë¦¬
            if [ -s summary_clean.md ]; then
              echo "SUMMARY_FOUND=true" >> $GITHUB_ENV
              echo "âœ… CodeRabbit Summary ì¶”ì¶œ ì„±ê³µ!"
              echo "ğŸ“„ ë³€í™˜ëœ Summary:"
              echo "----------------------------------------"
              cat summary_clean.md
              echo "----------------------------------------"
              mv summary_clean.md summary_final.md
            else
              echo "SUMMARY_FOUND=false" >> $GITHUB_ENV
              echo "âŒ CodeRabbit Summary íŒŒì‹± ì‹¤íŒ¨"
              echo "## Summary by CodeRabbit" > summary_final.md
              echo "" >> summary_final.md
              echo "- ìë™ Summary ì¶”ì¶œ ì‹¤íŒ¨" >> summary_final.md
            fi
          else
            echo "CodeRabbit Summaryë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "SUMMARY_FOUND=false" >> $GITHUB_ENV
            echo "## Summary by CodeRabbit" > summary_final.md
            echo "" >> summary_final.md
            echo "- CodeRabbit Summaryê°€ PRì— ì—†ìŠµë‹ˆë‹¤" >> summary_final.md
          fi

      - name: CHANGELOG.md ì—…ë°ì´íŠ¸
        if: env.SUMMARY_FOUND == 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TODAY=$(date '+%Y-%m-%d')
          
          # CHANGELOG.mdê°€ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f "CHANGELOG.md" ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "ì´ í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ì£¼ëª©í•  ë§Œí•œ ë³€ê²½ì‚¬í•­ì´ ì´ íŒŒì¼ì— ë¬¸ì„œí™”ë©ë‹ˆë‹¤." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          # ì„ì‹œ íŒŒì¼ì— ìƒˆ ë²„ì „ ì •ë³´ ì‘ì„±
          echo "## [$VERSION] - $TODAY" > new_entry.md
          echo "" >> new_entry.md
          cat summary_final.md >> new_entry.md
          echo "" >> new_entry.md
          echo "---" >> new_entry.md
          echo "" >> new_entry.md
          
          # ê¸°ì¡´ CHANGELOG.mdì™€ ìƒˆ ì—”íŠ¸ë¦¬ í•©ì¹˜ê¸°
          if grep -q "## \[" CHANGELOG.md; then
            # ì²« ë²ˆì§¸ ë²„ì „ ì—”íŠ¸ë¦¬ ì•ì— ìƒˆ ì—”íŠ¸ë¦¬ ì‚½ì…
            sed '/## \[/i\
            ' CHANGELOG.md > temp_changelog.md
            sed '/## \[/r new_entry.md' temp_changelog.md > CHANGELOG.md
          else
            # ì²« ë²ˆì§¸ ë²„ì „ ì—”íŠ¸ë¦¬ì¸ ê²½ìš°
            cat new_entry.md >> CHANGELOG.md
          fi
          
          echo "CHANGELOG.md ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "ì¶”ê°€ëœ ë‚´ìš©:"
          head -20 CHANGELOG.md

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        if: env.SUMMARY_FOUND == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "docs: CHANGELOG.md ì—…ë°ì´íŠ¸ - v${{ steps.get_version.outputs.version }}" || exit 0
          git push origin main

      - name: CHANGELOG ì—…ë°ì´íŠ¸ ì™„ë£Œ ì•Œë¦¼
        run: |
          if [ "${{ env.SUMMARY_FOUND }}" == "true" ]; then
            echo "âœ… CHANGELOG.md ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
            echo "ë²„ì „: ${{ steps.get_version.outputs.version }}"
            echo "PR: #${{ github.event.pull_request.number }}"
          else
            echo "âš ï¸ CodeRabbit Summaryë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ CHANGELOG ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤."
          fi

      - name: ì •ë¦¬
        run: |
          rm -f pr_content.html summary_section.html summary_clean.md summary_final.md new_entry.md temp_changelog.md 