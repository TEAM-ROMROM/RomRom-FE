name: Project-iOS-TestFlight-Deploy

on:
  push:
    branches: ["deploy"]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.27.3"
  XCODE_VERSION: "16.3"

jobs:
  build-and-deploy:
    name: Build and Deploy to TestFlight
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created"

      - name: Create Secrets.xcconfig file
        run: |
          mkdir -p ios/Flutter
          if [ -n "${{ secrets.SECRETS_XCCONFIG }}" ]; then
            echo "${{ secrets.SECRETS_XCCONFIG }}" > ios/Flutter/Secrets.xcconfig
            echo "Secrets.xcconfig created"
          else
            echo "// No secrets provided" > ios/Flutter/Secrets.xcconfig
          fi

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install

      # Apple ì¸ì¦ì„œ ì„¤ì •
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profile
        run: |
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          uuid=$(grep -A1 -a "UUID" profile.mobileprovision | grep string | sed -e "s/<string>//" -e "s/<\/string>//" -e "s/[[:space:]]//g")
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision

      # ExportOptions.plist íŒŒì¼ ìƒì„±
      - name: Create ExportOptions.plist
        run: |
          cd ios
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>CUK22HY6YC</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.alom.romrom</key>
                  <string>RomRom Distribution</string>
              </dict>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

      # í˜„ì¬ ë²„ì „ ì •ë³´ ì½ê¸°
      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          VERSION=$(echo $CURRENT_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $CURRENT_VERSION | cut -d'+' -f2)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "í˜„ì¬ ë²„ì „: $CURRENT_VERSION"

      # Flutter build (no codesign) to generate Xcode project artifacts
      - name: Flutter build (no codesign)
        run: |
          flutter build ios --release --no-codesign \
            --build-name="${{ steps.current_version.outputs.version }}" \
            --build-number="${{ steps.current_version.outputs.build_number }}"

      # Archive ìƒì„± (manual signing)
      - name: Create Archive
        run: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -archivePath build/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            archive \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="RomRom Distribution" \
            CODE_SIGN_IDENTITY="Apple Distribution"

      # IPA ìƒì„±
      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist

      # App Store Connect API Key ì„¤ì •
      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      # CHANGELOG.jsonì—ì„œ í˜„ì¬ ë²„ì „ì˜ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ
      - name: Extract release notes from CHANGELOG.json
        id: release_notes
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"
          
          if [ -f "CHANGELOG.json" ]; then
            echo "ğŸ“„ CHANGELOG.jsonì—ì„œ v$VERSION ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì¤‘..."
            
            # Pythonìœ¼ë¡œ JSONì—ì„œ í•´ë‹¹ ë²„ì „ì˜ ì •ë³´ ì¶”ì¶œ
            python3 << PYTHON_SCRIPT > final_release_notes.txt
          import json
          import sys
          
          try:
              with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              version = "$VERSION"
              found = False
              
              for release in data['releases']:
                  if release['version'] == version:
                      found = True
                      
                      # AIê°€ ìƒì„±í•œ ëª¨ë“  ì¹´í…Œê³ ë¦¬ë¥¼ ë™ì ìœ¼ë¡œ ì²˜ë¦¬
                      for category_key, items in release['parsed_changes'].items():
                          if items:
                              # ìƒˆ í˜•ì‹ì¸ì§€ ê¸°ì¡´ í˜•ì‹ì¸ì§€ í™•ì¸
                              if isinstance(items, dict) and 'title' in items and 'items' in items:
                                  title = items['title']
                                  actual_items = items['items']
                              else:
                                  title = category_key.replace('_', ' ').title()
                                  actual_items = items
                              
                              print(f"**{title}**")
                              for item in actual_items:
                                  if item.strip():
                                      print(f"â€¢ {item}")
                              print()
                      
                      break
              
              if not found:
                  print(f"v{version} ì—…ë°ì´íŠ¸")
                  
          except Exception as e:
              print(f"v{version} ì—…ë°ì´íŠ¸")
          PYTHON_SCRIPT
            
            if [ -s final_release_notes.txt ]; then
              echo "âœ… ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì„±ê³µ!"
              echo "ğŸ“‹ ì¶”ì¶œëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸:"
              echo "----------------------------------------"
              cat final_release_notes.txt
              echo "----------------------------------------"
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "âŒ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
            fi
          elif [ -f "CHANGELOG.md" ]; then
            echo "ğŸ“„ CHANGELOG.mdì—ì„œ v$VERSION ë³€ê²½ì‚¬í•­ ì¶”ì¶œ ì¤‘..."
            sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > current_release_notes.txt
            tail -n +2 current_release_notes.txt > release_notes_clean.txt
            sed '/^$/d; /^---$/d' release_notes_clean.txt > final_release_notes.txt
            if [ -s final_release_notes.txt ]; then
              echo "ì¶”ì¶œëœ ë³€ê²½ì‚¬í•­:"
              cat final_release_notes.txt
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "í˜„ì¬ ë²„ì „ì˜ ë³€ê²½ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
            fi
          else
            echo "âš ï¸ CHANGELOG.jsonê³¼ CHANGELOG.md íŒŒì¼ì´ ëª¨ë‘ ì—†ìŠµë‹ˆë‹¤."
            echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
            echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
          fi

      # Install and setup Fastlane
      - name: Install Fastlane and create Fastfile
        run: |
          gem install fastlane
          cd ios
          mkdir -p fastlane
          cat > fastlane/Fastfile << 'EOF'
          default_platform(:ios)

          platform :ios do
            lane :upload_testflight do
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                key_filepath: ENV["API_KEY_PATH"]
              )
              
              # ì—…ë¡œë“œ + ì•”í˜¸í™” ê·œì • ìë™ ì„¤ì •
              pilot(
                api_key: api_key,
                ipa: ENV["IPA_PATH"],
                changelog: ENV["RELEASE_NOTES"],
                skip_waiting_for_build_processing: true,  # ë¹ ë¥´ê²Œ ì—…ë¡œë“œë§Œ
                distribute_external: false,
                notify_external_testers: false,
                uses_non_exempt_encryption: false  # ì•”í˜¸í™” ê·œì • ìë™ ì„¤ì •
              )
              
              # alom ê·¸ë£¹ì— ë°°í¬ ì‹œë„
              puts "ğŸ”„ alom ê·¸ë£¹ì— ë°°í¬ ì‹œë„ ì¤‘..."
              begin
                pilot(
                  api_key: api_key,
                  app_identifier: "com.alom.romrom",
                  distribute_only: true,
                  groups: ["alom"],
                  notify_external_testers: false
                )
                puts "âœ… alom ê·¸ë£¹ ë°°í¬ ì„±ê³µ!"
              rescue => e
                puts "âš ï¸ alom ê·¸ë£¹ ë°°í¬ ì‹¤íŒ¨: #{e.message}"
                
                # test ê·¸ë£¹ìœ¼ë¡œ ëŒ€ì•ˆ ì‹œë„ (testê°€ ì‘ë™í•˜ëŠ” ê²ƒ ê°™ìœ¼ë‹ˆ)
                puts "ğŸ”„ test ê·¸ë£¹ìœ¼ë¡œ ëŒ€ì•ˆ ì‹œë„ ì¤‘..."
                begin
                  pilot(
                    api_key: api_key,
                    app_identifier: "com.alom.romrom", 
                    distribute_only: true,
                    groups: ["test"],
                    notify_external_testers: false
                  )
                  puts "âœ… test ê·¸ë£¹ ë°°í¬ ì„±ê³µ! (alom ê·¸ë£¹ì€ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•´ì£¼ì„¸ìš”)"
                rescue => e2
                  puts "âš ï¸ test ê·¸ë£¹ë„ ì‹¤íŒ¨: #{e2.message}"
                  puts "App Store Connectì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ë°°í¬í•´ì£¼ì„¸ìš”."
                end
              end
            end
          end
          EOF

      # Upload to TestFlight with Fastlane (ìë™í™” ê°œì„ )
      - name: Upload to TestFlight with Fastlane
        run: |
          # ì ˆëŒ€ ê²½ë¡œë¡œ IPA íŒŒì¼ ì°¾ê¸°
          IPA_PATH=$(find $GITHUB_WORKSPACE/ios/build/ipa -name "*.ipa" | head -1)
          echo "Found IPA at: $IPA_PATH"
          
          if [ ! -f "$IPA_PATH" ]; then
            echo "âŒ IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "ë¹Œë“œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la ios/build/ipa/
            exit 1
          fi
          
          # Release notes ì¤€ë¹„
          if [ "${{ env.RELEASE_NOTES_FOUND }}" == "true" ]; then
            RELEASE_NOTES=$(cat final_release_notes.txt)
            echo "Release Notes í¬í•¨í•˜ì—¬ ì—…ë¡œë“œ:"
            echo "$RELEASE_NOTES"
          else
            RELEASE_NOTES="v${{ steps.current_version.outputs.version }} ì—…ë°ì´íŠ¸"
            echo "ê¸°ë³¸ Release Notesë¡œ ì—…ë¡œë“œ: $RELEASE_NOTES"
          fi
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export APP_STORE_CONNECT_API_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}"
          export APP_STORE_CONNECT_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
          export API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          export IPA_PATH="$IPA_PATH"
          export RELEASE_NOTES="$RELEASE_NOTES"
          
          # ë””ë²„ê¹… ì •ë³´
          echo "Working directory: $(pwd)"
          echo "IPA_PATH: $IPA_PATH"
          echo "API_KEY_PATH: $API_KEY_PATH"
          
          # Fastlane ì‹¤í–‰
          cd ios
          fastlane upload_testflight

      # ì„±ê³µ ì•Œë¦¼
      - name: Notify TestFlight Upload Success
        if: success()
        run: |
          echo "âœ… TestFlight ì—…ë¡œë“œ ì„±ê³µ!"
          echo "ë²„ì „: ${{ steps.current_version.outputs.current_version }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ TestFlight ì—…ë¡œë“œ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
