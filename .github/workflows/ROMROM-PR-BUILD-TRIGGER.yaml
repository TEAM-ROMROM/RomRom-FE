# ===================================================================
# PR ëŒ“ê¸€ì„ í†µí•œ ì•± ë¹Œë“œ íŠ¸ë¦¬ê±° ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” PRì— ëŒ“ê¸€ë¡œ "@suh-lab build app"ì„ ì‘ì„±í•˜ë©´
# Androidì™€ iOS ì•± ë¹Œë“œë¥¼ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.
#
# ì£¼ìš” íŠ¹ì§•:
# - PR ëŒ“ê¸€ ê°ì§€: "@suh-lab build app" í‚¤ì›Œë“œ ê°ì§€
# - repository_dispatch ì´ë²¤íŠ¸ë¡œ ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
# - PR ë²ˆí˜¸ë¥¼ ë¹Œë“œ ë²ˆí˜¸ë¡œ ì‚¬ìš©
# - ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ìë™ ì¶”ì¶œ
#
# ì‚¬ìš© ë°©ë²•:
# PRì— ëŒ“ê¸€ ì‘ì„±: "@suh-lab build app"
#
# ===================================================================

name: ROMROM-PR-BUILD-TRIGGER

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  trigger-builds:
    name: ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
    # @suh-lab, build, app í‚¤ì›Œë“œê°€ ëª¨ë‘ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì‹¤í–‰
    if: |
      contains(github.event.comment.body, '@suh-lab') &&
      contains(github.event.comment.body, 'build') &&
      contains(github.event.comment.body, 'app')
    runs-on: ubuntu-latest

    steps:
      - name: ëŒ“ê¸€ì— ğŸ‘€ ë¦¬ì•¡ì…˜ ì¶”ê°€
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = context.payload.comment.id;
            
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              content: 'eyes'
            });
            
            console.log('ğŸ‘€ ëŒ“ê¸€ì— í™•ì¸ ë¦¬ì•¡ì…˜ ì¶”ê°€ ì™„ë£Œ');

      - name: PR ì •ë³´ í™•ì¸ ë° ì¶”ì¶œ
        id: pr_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;

            // PRì¸ì§€ í™•ì¸
            try {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: issueNumber
              });

              const branchName = pr.data.head.ref;
              const prNumber = pr.data.number;
              const headSha = pr.data.head.sha;

              console.log(`âœ… PR í™•ì¸: #${prNumber}`);
              console.log(`ğŸŒ¿ ë¸Œëœì¹˜ëª…: ${branchName}`);
              console.log(`ğŸ“ ì»¤ë°‹ í•´ì‹œ: ${headSha}`);

              // ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (#280 í˜•ì‹)
              const issueMatch = branchName.match(/#(\d+)/);
              const extractedIssueNumber = issueMatch ? issueMatch[1] : '';

              if (extractedIssueNumber) {
                console.log(`ğŸ“Œ ì¶”ì¶œëœ ì´ìŠˆ ë²ˆí˜¸: #${extractedIssueNumber}`);
              } else {
                console.log('âš ï¸ ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              }

              // core.setOutputìœ¼ë¡œ ê°œë³„ ê°’ ì„¤ì •
              core.setOutput('isPR', 'true');
              core.setOutput('prNumber', prNumber.toString());
              core.setOutput('branchName', branchName);
              core.setOutput('headSha', headSha);
              core.setOutput('issueNumber', extractedIssueNumber);

            } catch (error) {
              console.log('âŒ PRì´ ì•„ë‹™ë‹ˆë‹¤ ë˜ëŠ” PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              console.log('ì—ëŸ¬:', error.message);
              core.setOutput('isPR', 'false');
            }

      - name: PRì´ ì•„ë‹Œ ê²½ìš° ì¢…ë£Œ
        if: steps.pr_info.outputs.isPR != 'true'
        run: |
          echo "âš ï¸ ì´ ëŒ“ê¸€ì€ PRì´ ì•„ë‹Œ ì´ìŠˆì— ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "PRì— ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."
          exit 1

      - name: PRë³„ ë¹Œë“œ íšŸìˆ˜ ì¡°íšŒ ë° ë¹Œë“œ ë²ˆí˜¸ ìƒì„±
        id: build_number_calc
        if: steps.pr_info.outputs.isPR == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.pr_info.outputs.prNumber }}');

            console.log(`ğŸ“Š PR #${prNumber}ì˜ ë¹Œë“œ íšŸìˆ˜ ì¡°íšŒ ì¤‘...`);

            // PRì˜ ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });

            // "ì•± ë¹Œë“œ íŠ¸ë¦¬ê±° ì™„ë£Œ" ëŒ“ê¸€ ê°œìˆ˜ = ì´ì „ ë¹Œë“œ íšŸìˆ˜
            const buildCount = comments.data.filter(c =>
              c.body.includes('ì•± ë¹Œë“œ íŠ¸ë¦¬ê±° ì™„ë£Œ')
            ).length;

            // ë¹Œë“œ ë²ˆí˜¸: PRë²ˆí˜¸ + 2ìë¦¬ ì¹´ìš´íŠ¸ (38300, 38301, 38302...)
            const buildNumber = `${prNumber}${String(buildCount).padStart(2, '0')}`;

            console.log(`ğŸ“Š PR #${prNumber}: ${buildCount}ë²ˆì§¸ ë¹Œë“œ (ì´ì „ ë¹Œë“œ ${buildCount}íšŒ)`);
            console.log(`ğŸ“¦ ìƒì„±ëœ ë¹Œë“œ ë²ˆí˜¸: ${buildNumber}`);

            core.setOutput('buildCount', buildCount.toString());
            core.setOutput('buildNumber', buildNumber);

      - name: Android ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
        if: steps.pr_info.outputs.isPR == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ steps.pr_info.outputs.prNumber }}';
            const branchName = '${{ steps.pr_info.outputs.branchName }}';
            const issueNumber = '${{ steps.pr_info.outputs.issueNumber }}';
            const buildNumber = '${{ steps.build_number_calc.outputs.buildNumber }}';

            console.log(`ğŸš€ Android ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì‹œì‘...`);
            console.log(`   PR ë²ˆí˜¸: #${prNumber}`);
            console.log(`   ë¹Œë“œ ë²ˆí˜¸: ${buildNumber}`);
            console.log(`   ë¸Œëœì¹˜: ${branchName}`);
            console.log(`   ì´ìŠˆ ë²ˆí˜¸: ${issueNumber || 'ì—†ìŒ'}`);

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'build-android-app',
              client_payload: {
                pr_number: prNumber,
                build_number: buildNumber,
                branch_name: branchName,
                issue_number: issueNumber || '',
                triggered_by: 'pr-comment',
                comment_id: context.payload.comment.id.toString()
              }
            });

            console.log('âœ… Android ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì™„ë£Œ');

      - name: iOS ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
        if: steps.pr_info.outputs.isPR == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ steps.pr_info.outputs.prNumber }}';
            const branchName = '${{ steps.pr_info.outputs.branchName }}';
            const issueNumber = '${{ steps.pr_info.outputs.issueNumber }}';
            const buildNumber = '${{ steps.build_number_calc.outputs.buildNumber }}';

            console.log(`ğŸš€ iOS ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì‹œì‘...`);
            console.log(`   PR ë²ˆí˜¸: #${prNumber}`);
            console.log(`   ë¹Œë“œ ë²ˆí˜¸: ${buildNumber}`);
            console.log(`   ë¸Œëœì¹˜: ${branchName}`);
            console.log(`   ì´ìŠˆ ë²ˆí˜¸: ${issueNumber || 'ì—†ìŒ'}`);

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'build-ios-app',
              client_payload: {
                pr_number: prNumber,
                build_number: buildNumber,
                branch_name: branchName,
                issue_number: issueNumber || '',
                triggered_by: 'pr-comment',
                comment_id: context.payload.comment.id.toString()
              }
            });

            console.log('âœ… iOS ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì™„ë£Œ');

      - name: íŠ¸ë¦¬ê±° ì™„ë£Œ ëŒ“ê¸€ ì‘ì„±
        if: steps.pr_info.outputs.isPR == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ steps.pr_info.outputs.prNumber }}';
            const branchName = '${{ steps.pr_info.outputs.branchName }}';
            const buildNumber = '${{ steps.build_number_calc.outputs.buildNumber }}';
            const buildCount = '${{ steps.build_number_calc.outputs.buildCount }}';

            const body = `ğŸš€ **ì•± ë¹Œë“œ íŠ¸ë¦¬ê±° ì™„ë£Œ**

            Androidì™€ iOS ë¹Œë“œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.

            - ì•± ë²„ì „: \`0.0.0(${buildNumber})\`
            - PR: **#${prNumber}** (${buildCount}ë²ˆì§¸ ë¹Œë“œ)
            - ë¸Œëœì¹˜: \`${branchName}\`

            â³ ë¹Œë“œê°€ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ê²°ê³¼ ëŒ“ê¸€ì´ ì‘ì„±ë©ë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber),
              body: body
            });

            console.log('âœ… íŠ¸ë¦¬ê±° ì™„ë£Œ ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ');