# ===================================================================
# PR/ì´ìŠˆ ëŒ“ê¸€ì„ í†µí•œ ì•± ë¹Œë“œ íŠ¸ë¦¬ê±° ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” PR ë˜ëŠ” ì´ìŠˆì— ëŒ“ê¸€ë¡œ "@suh-lab build app"ì„ ì‘ì„±í•˜ë©´
# Androidì™€ iOS ì•± ë¹Œë“œë¥¼ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.
#
# ì£¼ìš” íŠ¹ì§•:
# - PR/ì´ìŠˆ ëŒ“ê¸€ ê°ì§€: "@suh-lab build app" í‚¤ì›Œë“œ ê°ì§€
# - repository_dispatch ì´ë²¤íŠ¸ë¡œ ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
# - PR/ì´ìŠˆ ë²ˆí˜¸ + ë¹Œë“œ íšŸìˆ˜ë¡œ ê³ ìœ í•œ ë¹Œë“œ ë²ˆí˜¸ ìƒì„±
# - ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ìë™ ì¶”ì¶œ
#
# ì‚¬ìš© ë°©ë²•:
# - PRì— ëŒ“ê¸€ ì‘ì„±: "@suh-lab build app"
# - ì´ìŠˆì— ëŒ“ê¸€ ì‘ì„±: "@suh-lab build app" (Guide by SUH-LAB ëŒ“ê¸€ í•„ìš”)
#
# ===================================================================

name: ROMROM-PR-BUILD-TRIGGER

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  trigger-builds:
    name: ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
    # @suh-lab, build, app í‚¤ì›Œë“œê°€ ëª¨ë‘ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì‹¤í–‰
    if: |
      contains(github.event.comment.body, '@suh-lab') &&
      contains(github.event.comment.body, 'build') &&
      contains(github.event.comment.body, 'app')
    runs-on: ubuntu-latest

    steps:
      - name: ëŒ“ê¸€ì— ğŸ‘€ ë¦¬ì•¡ì…˜ ì¶”ê°€
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = context.payload.comment.id;

            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              content: 'eyes'
            });

            console.log('ğŸ‘€ ëŒ“ê¸€ì— í™•ì¸ ë¦¬ì•¡ì…˜ ì¶”ê°€ ì™„ë£Œ');

      - name: PR/ì´ìŠˆ ì •ë³´ í™•ì¸ ë° ì¶”ì¶œ
        id: source_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            let sourceType = '';
            let sourceNumber = '';
            let branchName = '';
            let headSha = '';
            let relatedIssueNumber = '';

            // 1. ë¨¼ì € PRì¸ì§€ í™•ì¸
            try {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: issueNumber
              });

              sourceType = 'PR';
              sourceNumber = pr.data.number.toString();
              branchName = pr.data.head.ref;
              headSha = pr.data.head.sha;

              console.log(`âœ… PR í™•ì¸: #${sourceNumber}`);
              console.log(`ğŸŒ¿ ë¸Œëœì¹˜ëª…: ${branchName}`);
              console.log(`ğŸ“ ì»¤ë°‹ í•´ì‹œ: ${headSha}`);

              // ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (#280 í˜•ì‹)
              const issueMatch = branchName.match(/#(\d+)/);
              relatedIssueNumber = issueMatch ? issueMatch[1] : '';

              if (relatedIssueNumber) {
                console.log(`ğŸ“Œ ì¶”ì¶œëœ ì´ìŠˆ ë²ˆí˜¸: #${relatedIssueNumber}`);
              }

            } catch (error) {
              console.log('â„¹ï¸ PRì´ ì•„ë‹™ë‹ˆë‹¤. ì´ìŠˆì—ì„œ ë¸Œëœì¹˜ ì •ë³´ë¥¼ ì°¾ìŠµë‹ˆë‹¤...');

              // 2. PRì´ ì•„ë‹ˆë©´ ì´ìŠˆì—ì„œ "Guide by SUH-LAB" ëŒ“ê¸€ ì°¾ê¸°
              sourceType = 'ISSUE';
              sourceNumber = issueNumber.toString();
              relatedIssueNumber = issueNumber.toString();

              try {
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  per_page: 100
                });

                // "Guide by SUH-LAB" ëŒ“ê¸€ ì°¾ê¸°
                const guideComment = comments.data.find(c =>
                  c.body.includes('Guide by SUH-LAB')
                );

                if (!guideComment) {
                  console.log('âŒ "Guide by SUH-LAB" ëŒ“ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                  core.setOutput('found', 'false');
                  core.setOutput('errorMessage', 'ì´ìŠˆì—ì„œ "Guide by SUH-LAB" ëŒ“ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œëœì¹˜ ì •ë³´ê°€ í¬í•¨ëœ ëŒ“ê¸€ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                  return;
                }

                console.log('âœ… "Guide by SUH-LAB" ëŒ“ê¸€ ë°œê²¬');

                // ë¸Œëœì¹˜ëª… ì¶”ì¶œ (### ë¸Œëœì¹˜ ë‹¤ìŒ ``` ë¸”ë¡ ë‚´ìš©)
                const branchMatch = guideComment.body.match(/### ë¸Œëœì¹˜\s*```\s*([\s\S]*?)\s*```/);

                if (!branchMatch) {
                  console.log('âŒ ë¸Œëœì¹˜ ì •ë³´ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                  core.setOutput('found', 'false');
                  core.setOutput('errorMessage', '"Guide by SUH-LAB" ëŒ“ê¸€ì—ì„œ ë¸Œëœì¹˜ ì •ë³´ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëŒ“ê¸€ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                  return;
                }

                branchName = branchMatch[1].trim();
                console.log(`ğŸŒ¿ ì¶”ì¶œëœ ë¸Œëœì¹˜ëª…: ${branchName}`);
                console.log(`âœ… ì´ìŠˆ #${sourceNumber}ì—ì„œ ë¹Œë“œ ì •ë³´ ì¶”ì¶œ ì™„ë£Œ`);

              } catch (commentError) {
                console.log('âŒ ì´ìŠˆ ëŒ“ê¸€ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', commentError.message);
                core.setOutput('found', 'false');
                core.setOutput('errorMessage', `ì´ìŠˆ ëŒ“ê¸€ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${commentError.message}`);
                return;
              }
            }

            // ê²°ê³¼ ì¶œë ¥
            core.setOutput('found', 'true');
            core.setOutput('sourceType', sourceType);
            core.setOutput('sourceNumber', sourceNumber);
            core.setOutput('branchName', branchName);
            core.setOutput('headSha', headSha);
            core.setOutput('relatedIssueNumber', relatedIssueNumber);

      - name: ë¸Œëœì¹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš° ì—ëŸ¬ ëŒ“ê¸€ ì‘ì„±
        if: steps.source_info.outputs.found != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const errorMessage = '${{ steps.source_info.outputs.errorMessage }}';

            const body = `âŒ **ì•± ë¹Œë“œ íŠ¸ë¦¬ê±° ì‹¤íŒ¨**

            ${errorMessage}

            **í•´ê²° ë°©ë²•:**
            - PRì—ì„œ ë¹Œë“œí•˜ëŠ” ê²½ìš°: PR í˜ì´ì§€ì—ì„œ ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
            - ì´ìŠˆì—ì„œ ë¹Œë“œí•˜ëŠ” ê²½ìš°: "Guide by SUH-LAB" ëŒ“ê¸€ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
              - ëŒ“ê¸€ì— \`### ë¸Œëœì¹˜\` ì„¹ì…˜ê³¼ ë¸Œëœì¹˜ëª…ì´ í¬í•¨ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

            core.setFailed(errorMessage);

      - name: ë¹Œë“œ íšŸìˆ˜ ì¡°íšŒ ë° ë¹Œë“œ ë²ˆí˜¸ ìƒì„±
        id: build_number_calc
        if: steps.source_info.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sourceNumber = parseInt('${{ steps.source_info.outputs.sourceNumber }}');
            const sourceType = '${{ steps.source_info.outputs.sourceType }}';

            console.log(`ğŸ“Š ${sourceType} #${sourceNumber}ì˜ ë¹Œë“œ íšŸìˆ˜ ì¡°íšŒ ì¤‘...`);

            // PR/ì´ìŠˆì˜ ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: sourceNumber,
              per_page: 100
            });

            // "@suh-lab" + "build" + "app" í¬í•¨ ëŒ“ê¸€ ê°œìˆ˜ = ì´ì „ ë¹Œë“œ íšŸìˆ˜
            // (í˜„ì¬ ìš”ì²­ ëŒ“ê¸€ì€ ì•„ì§ ì¹´ìš´íŠ¸ì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì •í™•íˆ "ì´ì „ ë¹Œë“œ íšŸìˆ˜")
            const buildCount = comments.data.filter(c =>
              c.body.includes('@suh-lab') &&
              c.body.toLowerCase().includes('build') &&
              c.body.toLowerCase().includes('app')
            ).length;

            // ë¹Œë“œ ë²ˆí˜¸: ì†ŒìŠ¤ë²ˆí˜¸ + 2ìë¦¬ ì¹´ìš´íŠ¸ (38800, 38801, 38802...)
            const buildNumber = `${sourceNumber}${String(buildCount).padStart(2, '0')}`;

            console.log(`ğŸ“Š ${sourceType} #${sourceNumber}: ${buildCount}ë²ˆì§¸ ë¹Œë“œ (ì´ì „ ë¹Œë“œ ${buildCount}íšŒ)`);
            console.log(`ğŸ“¦ ìƒì„±ëœ ë¹Œë“œ ë²ˆí˜¸: ${buildNumber}`);

            core.setOutput('buildCount', buildCount.toString());
            core.setOutput('buildNumber', buildNumber);

      - name: Android ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
        if: steps.source_info.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sourceType = '${{ steps.source_info.outputs.sourceType }}';
            const sourceNumber = '${{ steps.source_info.outputs.sourceNumber }}';
            const branchName = '${{ steps.source_info.outputs.branchName }}';
            const relatedIssueNumber = '${{ steps.source_info.outputs.relatedIssueNumber }}';
            const buildNumber = '${{ steps.build_number_calc.outputs.buildNumber }}';

            console.log(`ğŸš€ Android ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì‹œì‘...`);
            console.log(`   ${sourceType} ë²ˆí˜¸: #${sourceNumber}`);
            console.log(`   ë¹Œë“œ ë²ˆí˜¸: ${buildNumber}`);
            console.log(`   ë¸Œëœì¹˜: ${branchName}`);
            console.log(`   ê´€ë ¨ ì´ìŠˆ ë²ˆí˜¸: ${relatedIssueNumber || 'ì—†ìŒ'}`);

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'build-android-app',
              client_payload: {
                pr_number: sourceNumber,
                build_number: buildNumber,
                branch_name: branchName,
                issue_number: relatedIssueNumber || '',
                triggered_by: `${sourceType.toLowerCase()}-comment`,
                comment_id: context.payload.comment.id.toString(),
                source_type: sourceType
              }
            });

            console.log('âœ… Android ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì™„ë£Œ');

      - name: iOS ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
        if: steps.source_info.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sourceType = '${{ steps.source_info.outputs.sourceType }}';
            const sourceNumber = '${{ steps.source_info.outputs.sourceNumber }}';
            const branchName = '${{ steps.source_info.outputs.branchName }}';
            const relatedIssueNumber = '${{ steps.source_info.outputs.relatedIssueNumber }}';
            const buildNumber = '${{ steps.build_number_calc.outputs.buildNumber }}';

            console.log(`ğŸš€ iOS ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì‹œì‘...`);
            console.log(`   ${sourceType} ë²ˆí˜¸: #${sourceNumber}`);
            console.log(`   ë¹Œë“œ ë²ˆí˜¸: ${buildNumber}`);
            console.log(`   ë¸Œëœì¹˜: ${branchName}`);
            console.log(`   ê´€ë ¨ ì´ìŠˆ ë²ˆí˜¸: ${relatedIssueNumber || 'ì—†ìŒ'}`);

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'build-ios-app',
              client_payload: {
                pr_number: sourceNumber,
                build_number: buildNumber,
                branch_name: branchName,
                issue_number: relatedIssueNumber || '',
                triggered_by: `${sourceType.toLowerCase()}-comment`,
                comment_id: context.payload.comment.id.toString(),
                source_type: sourceType
              }
            });

            console.log('âœ… iOS ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì™„ë£Œ');

      # íŠ¸ë¦¬ê±° ì™„ë£Œ ëŒ“ê¸€ì€ ì œê±°ë¨ - Android/iOS ê°ê°ì˜ ì§„í–‰ìƒí™© ëŒ“ê¸€ì´ ì´ ì—­í• ì„ ëŒ€ì²´
      - name: íŠ¸ë¦¬ê±° ì™„ë£Œ ë¡œê·¸
        if: steps.source_info.outputs.found == 'true'
        run: |
          echo "âœ… Android ë° iOS ë¹Œë“œ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì™„ë£Œ"
          echo "ğŸ“¦ ë¹Œë“œ ë²ˆí˜¸: ${{ steps.build_number_calc.outputs.buildNumber }}"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ steps.source_info.outputs.branchName }}"
          echo "ğŸ“‹ ê° í”Œë«í¼ë³„ ì§„í–‰ìƒí™© ëŒ“ê¸€ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤."
