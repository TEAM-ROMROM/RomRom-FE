# ===================================================================
# ë²”ìš© í”„ë¡œì íŠ¸ ë²„ì „ ìë™ ê´€ë¦¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ë‹¤ì–‘í•œ í”„ë¡œì íŠ¸ íƒ€ì…(Spring, Flutter, React, Node.js ë“±)ì—ì„œ
# main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ patch ë²„ì „ì„ ìë™ìœ¼ë¡œ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.
#
# ì§€ì› í”„ë¡œì íŠ¸ íƒ€ì…:
# - spring: build.gradleì˜ version ê´€ë¦¬
# - flutter: pubspec.yamlì˜ version ê´€ë¦¬
# - react: package.jsonì˜ version ê´€ë¦¬
# - react-native: package.json + Android/iOS í”Œë«í¼ë³„ ë²„ì „ ê´€ë¦¬
# - node: package.jsonì˜ version ê´€ë¦¬
# - python: pyproject.tomlì˜ version ê´€ë¦¬
# - basic: version.ymlë§Œ ê´€ë¦¬í•˜ëŠ” ê¸°ë³¸ íƒ€ì…
#
# ì‚¬ìš© ë°©ë²•:
# 1. version.yml íŒŒì¼ì—ì„œ project_typeì„ ì„¤ì •í•˜ì„¸ìš”
# 2. í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ë²„ì „ íŒŒì¼ì´ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
# 3. main ë¸Œëœì¹˜ì— í‘¸ì‹œí•˜ë©´ ìë™ìœ¼ë¡œ patch ë²„ì „ì´ ì¦ê°€í•©ë‹ˆë‹¤
#
# ===================================================================

name: PROJECT-VERSION-CONTROL

on:
  push:
    branches: ["main"]
    paths-ignore:
      - 'CHANGELOG.md'
      - 'CHANGELOG.json'
      - 'version.yml'  # ë¬´í•œ ë£¨í”„ ë°©ì§€
  workflow_dispatch:

permissions:
  contents: write

jobs:
  version-bump:
    name: ë²„ì „ ìë™ ì¦ê°€
    runs-on: ubuntu-latest

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          chmod +x .github/scripts/version_manager.sh
          echo "ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"

      - name: í˜„ì¬ ë²„ì „ í™•ì¸
        id: current_version
        run: |
          CURRENT_VERSION=$(./.github/scripts/version_manager.sh get | tail -n 1)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: ìƒˆ ë²„ì „ ê³„ì‚° ë° ì—…ë°ì´íŠ¸ (patch ë²„ì „ ì¦ê°€)
        id: version
        run: |
          NEW_VERSION=$(./.github/scripts/version_manager.sh increment | tail -n 1)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: í”„ë¡œì íŠ¸ íƒ€ì… í™•ì¸
        id: project_info
        run: |
          if [ -f "version.yml" ]; then
            PROJECT_TYPE=$(grep "^project_type:" version.yml | sed 's/project_type: *"\([^"]*\)".*/\1/')
            echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
            echo "í”„ë¡œì íŠ¸ íƒ€ì…: $PROJECT_TYPE"
          else
            echo "project_type=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ version.yml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # ëª¨ë“  ë³€ê²½ ìŠ¤í…Œì´ì§• (ë£¨íŠ¸/í•˜ìœ„ ëª¨ë“ˆ í¬í•¨)
          git add -A

          # ë³€ê²½ì‚¬í•­ í™•ì¸ í›„ ì»¤ë°‹/í‘¸ì‹œ
          if git diff --staged --quiet; then
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            REPO_NAME=$(basename "${{ github.repository }}")
            COMMIT_MSG="$REPO_NAME ë²„ì „ ì •ë³´ ê´€ë¦¬ : chore: ë²„ì „ ${{ steps.version.outputs.new_version }} [skip ci]"
            git commit -m "$COMMIT_MSG" || exit 0
            git push
            echo "âœ… ë²„ì „ ì—…ë°ì´íŠ¸ ì»¤ë°‹ ì™„ë£Œ"
          fi

      - name: Git íƒœê·¸ ìƒì„±
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          TAG_NAME="v$NEW_VERSION"
          
          # íƒœê·¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git tag -l | grep -q "^$TAG_NAME$"; then
            echo "âš ï¸ íƒœê·¸ $TAG_NAMEì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            git tag "$TAG_NAME"
            git push origin "$TAG_NAME"
            echo "âœ… Git íƒœê·¸ ìƒì„± ì™„ë£Œ: $TAG_NAME"
          fi

      - name: ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ë²„ì „ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ ì—…ë°ì´íŠ¸ ì •ë³´:"
          echo "  â€¢ ì´ì „ ë²„ì „: ${{ steps.current_version.outputs.current_version }}"
          echo "  â€¢ ìƒˆ ë²„ì „: ${{ steps.version.outputs.new_version }}"
          echo "  â€¢ í”„ë¡œì íŠ¸ íƒ€ì…: ${{ steps.project_info.outputs.project_type }}"
          echo "  â€¢ ì»¤ë°‹: ${{ github.sha }}"
          echo "  â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"