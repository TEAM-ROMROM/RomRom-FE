# ===================================================================
# Android í…ŒìŠ¤íŠ¸ìš© APK ë¹Œë“œ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” test-deploy ë¸Œëžœì¹˜ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬
# í…ŒìŠ¤íŠ¸ìš© Android APKë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
#
# ì£¼ìš” íŠ¹ì§•:
# - workflow_dispatchë¡œ ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥
# - ë²„ì „ ê´€ë¦¬ ë¶ˆí•„ìš” (ì•ˆë“œë¡œì´ë“œëŠ” ë²„ì „ ì œì•½ ì—†ìŒ)
# - ë¸Œëžœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ìžë™ ì¶”ì¶œ (YYYYMMDD_#ì´ìŠˆë²ˆí˜¸_ë‚´ìš© í˜•ì‹)
# - GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì™€ì„œ ë¹Œë“œ ì •ë³´ì— í¬í•¨
# - APK íŒŒì¼ë§Œ ìƒì„± (Play Store ë°°í¬ ì œê±°)
# - ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œí•˜ì—¬ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ (ìµœëŒ€ 500MB/ì•„í‹°íŒ©íŠ¸)
#
# ë¸Œëžœì¹˜ëª… ì˜ˆì‹œ:
# - 20251208_#387_ë‚´ìš©
# - 20250115_#123_ë²„ê·¸ìˆ˜ì •
#
# ì‚¬ìš© ë°©ë²•:
# 1. test-deploy ë¸Œëžœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
# 2. GitHub Actionsì—ì„œ "ROMROM-ANDROID-TEST-APK" ì›Œí¬í”Œë¡œìš° ì„ íƒ
# 3. "Run workflow" ë²„íŠ¼ í´ë¦­
# 4. ë¹Œë“œ ì™„ë£Œ í›„ ì•„í‹°íŒ©íŠ¸ì—ì„œ APK ë‹¤ìš´ë¡œë“œ
#
# ì•„í‹°íŒ©íŠ¸ ìš©ëŸ‰ ì œí•œ:
# - ë¬´ë£Œ í”Œëžœ: 500MB/ì•„í‹°íŒ©íŠ¸, 10GB/ì €ìž¥ì†Œ ì „ì²´
# - APK íŒŒì¼ì€ ë³´í†µ 50-200MBì´ë¯€ë¡œ ë¬´ë£Œ í”Œëžœìœ¼ë¡œ ì¶©ë¶„
#
# ===================================================================

name: ROMROM-ANDROID-TEST-APK

on:
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.35.5"
  JAVA_VERSION: "17"

jobs:
  prepare-test-build:
    name: í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì¤€ë¹„
    runs-on: ubuntu-latest

    outputs:
      issue_url: ${{ steps.issue_info.outputs.issue_url }}
      issue_title: ${{ steps.issue_info.outputs.issue_title }}
      issue_number: ${{ steps.issue_info.outputs.issue_number }}
      commit_hash: ${{ steps.build_info.outputs.commit_hash }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      # ë¸Œëžœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ ë° GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: ë¸Œëžœì¹˜ëª…ì—ì„œ ì´ìŠˆ ì •ë³´ ì¶”ì¶œ
        id: issue_info
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "ðŸŒ¿ ë¸Œëžœì¹˜ëª…: $BRANCH_NAME"
          
          # ë¸Œëžœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (#387 í˜•ì‹)
          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oP '#\K\d+' || echo "")
          
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âš ï¸ ë¸Œëžœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "issue_url=" >> $GITHUB_OUTPUT
            echo "issue_title=" >> $GITHUB_OUTPUT
            echo "issue_number=" >> $GITHUB_OUTPUT
          else
            echo "âœ… ì¶”ì¶œëœ ì´ìŠˆ ë²ˆí˜¸: #$ISSUE_NUMBER"
            ISSUE_URL="https://github.com/${{ github.repository }}/issues/$ISSUE_NUMBER"
            echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            
            # GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            echo "ðŸ” GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ì¡°íšŒ ì¤‘..."
            ISSUE_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")
            
            # ì´ìŠˆ ì œëª© ì¶”ì¶œ
            ISSUE_TITLE=$(echo "$ISSUE_RESPONSE" | jq -r '.title // "ì´ìŠˆ ì •ë³´ ì—†ìŒ"')
            
            # ì´ìŠˆ ìƒíƒœ í™•ì¸
            ISSUE_STATE=$(echo "$ISSUE_RESPONSE" | jq -r '.state // "unknown"')
            
            if [ "$ISSUE_TITLE" = "null" ] || [ "$ISSUE_TITLE" = "ì´ìŠˆ ì •ë³´ ì—†ìŒ" ]; then
              echo "âš ï¸ ì´ìŠˆ #$ISSUE_NUMBERë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "issue_title=" >> $GITHUB_OUTPUT
            else
              echo "ðŸ“‹ ì´ìŠˆ ì œëª©: $ISSUE_TITLE"
              echo "ðŸ“Œ ì´ìŠˆ ìƒíƒœ: $ISSUE_STATE"
              echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
            fi
          fi

      # ë¹Œë“œ ì •ë³´ ìƒì„±
      - name: ë¹Œë“œ ì •ë³´ ìƒì„±
        id: build_info
        run: |
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)
          BUILD_NUMBER="${{ github.run_number }}"
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          echo "commit_hash=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ ë¹Œë“œ ì •ë³´:"
          echo "  ë¹Œë“œ ë²ˆí˜¸: #$BUILD_NUMBER"
          echo "  ì»¤ë°‹ í•´ì‹œ: $COMMIT_SHORT"
          echo "  ë¹Œë“œ ë‚ ì§œ: $BUILD_DATE"

  build-android-test:
    name: Android í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: prepare-test-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      # Debug Keystore ì„¤ì •
      - name: Setup Debug Keystore
        run: |
          mkdir -p ~/.android
          echo "${{ secrets.DEBUG_KEYSTORE }}" | base64 -d > ~/.android/debug.keystore || echo "Base64 decoding failed"
          echo "Debug Keystore created (for debugging)"
          ls -la ~/.android/

      # .env íŒŒì¼ ìƒì„±
      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created"

      # Keystoreì™€ key.properties ì„¤ì •
      - name: Setup Keystore and key.properties
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.DEBUG_KEYSTORE }}" | base64 -d > android/app/keystore/key.jks || echo "Base64 decoding failed"
          echo "Keystore created from DEBUG_KEYSTORE"
          ls -la android/app/keystore
          echo "storeFile=keystore/key.jks" > android/key.properties
          echo "storePassword=android" >> android/key.properties
          echo "keyAlias=androiddebugkey" >> android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "key.properties created"
          ls -la android/

      # google-services.json ìƒì„±
      - name: Create google-services.json
        shell: bash
        run: |
          mkdir -p android/app
          printf '%s' "${GOOGLE_SERVICES_JSON}" > android/app/google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}

      # Flutter ì„¤ì •
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Verify Flutter version
        run: |
          echo "Flutter setup completed"
          flutter --version

      # Flutter ë° Gradle ìºì‹œ
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: |
          flutter pub get
          echo "Dependencies installed"

      # Gradle ì…‹ì—…
      - name: Setup Gradle
        working-directory: android
        run: |
          chmod +x gradlew
          echo "Gradle wrapper permissions set"

      # Java ì„¤ì •
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Verify Java version
        run: |
          echo "Java setup completed"
          java -version

      # Android SDK ì„¤ì •
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Verify Android SDK setup
        run: echo "Android SDK setup completed"

      # Ruby ì„¤ì •
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"
          bundler-cache: true

      - name: Verify Ruby version
        run: |
          echo "Ruby setup completed"
          ruby -v

      # Fastlane ì„¤ì¹˜
      - name: Install Fastlane
        run: |
          gem install fastlane
          echo "Fastlane installed"
          fastlane --version

      # APK íŒŒì¼ëª… ìƒì„±
      - name: Generate APK filename
        id: apk_filename
        run: |
          COMMIT_SHORT="${{ needs.prepare-test-build.outputs.commit_hash }}"
          BUILD_NUMBER="${{ github.run_number }}"
          APK_NAME="romrom-test-${BUILD_NUMBER}-${COMMIT_SHORT}.apk"
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ APK íŒŒì¼ëª…: $APK_NAME"

      # Fastlaneì„ ì´ìš©í•˜ì—¬ APK ë¹Œë“œ
      - name: Build APK with Fastlane
        run: |
          cd android
          fastlane build --verbose
          ls -la ../build/app/outputs/flutter-apk/ || true
          echo "APK built with Fastlane"

      # APK íŒŒì¼ ì´ë¦„ ë³€ê²½ ë° ì¤€ë¹„
      - name: Rename and Prepare APK
        run: |
          mkdir -p ./android/app/build/outputs/apk/release/
          APK_NAME="${{ steps.apk_filename.outputs.apk_name }}"
          mv ./build/app/outputs/flutter-apk/app-release.apk ./android/app/build/outputs/apk/release/${APK_NAME}
          echo "APK renamed to ${APK_NAME}"
          ls -la ./android/app/build/outputs/apk/release/
          
          # APK íŒŒì¼ í¬ê¸° í™•ì¸
          APK_SIZE=$(stat -c%s "./android/app/build/outputs/apk/release/${APK_NAME}" 2>/dev/null || stat -f%z "./android/app/build/outputs/apk/release/${APK_NAME}" 2>/dev/null || echo "0")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
          echo "ðŸ“¦ APK íŒŒì¼ í¬ê¸°: ${APK_SIZE_MB}MB"
          
          # ì•„í‹°íŒ©íŠ¸ ìš©ëŸ‰ ì œí•œ í™•ì¸ (500MB)
          if [ "$APK_SIZE" -gt 524288000 ]; then
            echo "âš ï¸ ê²½ê³ : APK íŒŒì¼ í¬ê¸°ê°€ 500MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤ (${APK_SIZE_MB}MB)"
          else
            echo "âœ… APK íŒŒì¼ í¬ê¸°ê°€ ì•„í‹°íŒ©íŠ¸ ì œí•œ ë‚´ìž…ë‹ˆë‹¤ (${APK_SIZE_MB}MB / 500MB)"
          fi

      # ë¹Œë“œ ì •ë³´ íŒŒì¼ ìƒì„±
      - name: Create build info file
        run: |
          BUILD_NUMBER="${{ github.run_number }}"
          BRANCH_NAME="${{ github.ref_name }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT="${{ needs.prepare-test-build.outputs.commit_hash }}"
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          cat > build-info.txt << EOF
          í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ ì •ë³´
          
          ë¹Œë“œ ë²ˆí˜¸: #$BUILD_NUMBER
          ë¸Œëžœì¹˜: $BRANCH_NAME
          ì»¤ë°‹: $COMMIT_SHORT
          ì „ì²´ ì»¤ë°‹ í•´ì‹œ: $COMMIT_SHA
          ë¹Œë“œ ë‚ ì§œ: $BUILD_DATE
          
          EOF
          
          # ì´ìŠˆ ì •ë³´ê°€ ìžˆìœ¼ë©´ ì¶”ê°€
          if [ -n "${{ needs.prepare-test-build.outputs.issue_number }}" ]; then
            ISSUE_NUMBER="${{ needs.prepare-test-build.outputs.issue_number }}"
            ISSUE_TITLE="${{ needs.prepare-test-build.outputs.issue_title }}"
            ISSUE_URL="${{ needs.prepare-test-build.outputs.issue_url }}"
            
            cat >> build-info.txt << EOF
          ê´€ë ¨ ì´ìŠˆ:
          - #$ISSUE_NUMBER: $ISSUE_TITLE
          - URL: $ISSUE_URL
          
          EOF
          fi
          
          echo "ðŸ“‹ ë¹Œë“œ ì •ë³´ íŒŒì¼ ìƒì„± ì™„ë£Œ:"
          cat build-info.txt

      # APKì™€ ë¹Œë“œ ì •ë³´ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload APK and build info as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: romrom-test-apk
          path: |
            ./android/app/build/outputs/apk/release/*.apk
            build-info.txt
          retention-days: 7
          if-no-files-found: error

      # ì„±ê³µ ì•Œë¦¼
      - name: Notify Build Success
        if: success()
        run: |
          echo "âœ… Android í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ ì„±ê³µ!"
          echo "ë¹Œë“œ ë²ˆí˜¸: ${{ github.run_number }}"
          echo "ë¸Œëžœì¹˜: ${{ github.ref_name }}"
          echo "ì»¤ë°‹: ${{ needs.prepare-test-build.outputs.commit_hash }}"
          if [ -n "${{ needs.prepare-test-build.outputs.issue_url }}" ]; then
            echo "ê´€ë ¨ ì´ìŠˆ: ${{ needs.prepare-test-build.outputs.issue_url }}"
          fi
          echo ""
          echo "ðŸ“¦ ì•„í‹°íŒ©íŠ¸ì—ì„œ APK íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤."

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Android í…ŒìŠ¤íŠ¸ APK ë¹Œë“œ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."


