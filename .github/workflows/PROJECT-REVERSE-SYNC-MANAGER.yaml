# ===================================================================
# GitHub Projects Status â†’ Issue Label ì—­ë°©í–¥ ë™ê¸°í™” ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” GitHub Projectsì˜ Status ë³€ê²½ì„ Issue Labelë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.
#
# ì‘ë™ ë°©ì‹:
# 1. Projectsì—ì„œ Itemì˜ Statusê°€ ë³€ê²½ë˜ë©´ íŠ¸ë¦¬ê±°
# 2. GraphQL APIë¡œ ë³€ê²½ëœ Status ê°’ ì¡°íšŒ
# 3. í•´ë‹¹ Issueì˜ ê¸°ì¡´ Status Label ì œê±°
# 4. ìƒˆë¡œìš´ Status Label ì¶”ê°€
#
# ì§€ì› ê¸°ëŠ¥:
# - Projects Status ë³€ê²½ â†’ Issue Label ìë™ ë™ê¸°í™”
#   â€¢ ì‘ì—… ì „ â†’ ì‘ì—… ì „
#   â€¢ ì‘ì—… ì¤‘ â†’ ì‘ì—… ì¤‘
#   â€¢ í™•ì¸ ëŒ€ê¸° â†’ í™•ì¸ ëŒ€ê¸°
#   â€¢ í”¼ë“œë°± â†’ í”¼ë“œë°±
#   â€¢ ì‘ì—… ì™„ë£Œ â†’ ì‘ì—… ì™„ë£Œ
#   â€¢ ì·¨ì†Œ â†’ ì·¨ì†Œ
# - PRì€ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (Issueë§Œ ì²˜ë¦¬)
# - ë¬´í•œ ë£¨í”„ ë°©ì§€ ë¡œì§ í¬í•¨
#
# í•„ìˆ˜ ì„¤ì •:
# - Organization Secret: _GITHUB_PAT_TOKEN
#   â€¢ í•„ìš” ê¶Œí•œ: repo (ì „ì²´), project (read:project, write:project)
#   â€¢ Classic PAT í•„ìš” (Fine-grained tokenì€ GraphQL API ë¯¸ì§€ì›)
#
# í™˜ê²½ë³€ìˆ˜ ì„¤ì •:
# - PROJECT_NUMBER: GitHub Projects ë²ˆí˜¸ (í•„ìˆ˜)
# - STATUS_FIELD: Projectsì˜ Status í•„ë“œëª… (ê¸°ë³¸ê°’: "Status")
# - STATUS_LABELS: ë™ê¸°í™”í•  Status Label ëª©ë¡ (JSON ë°°ì—´)
#
# ê´€ë ¨ ì›Œí¬í”Œë¡œìš°:
# - PROJECT-COMMON-PROJECTS-SYNC-MANAGER.yaml: Label â†’ Status ë™ê¸°í™” (ì •ë°©í–¥)
# - ì´ ì›Œí¬í”Œë¡œìš°: Status â†’ Label ë™ê¸°í™” (ì—­ë°©í–¥)
#
# ===================================================================

name: PROJECT-REVERSE-SYNC-MANAGER

on:
  projects_v2_item:
    types: [edited]

# ===================================================================
# ì„¤ì • ë³€ìˆ˜
# ===================================================================
env:
  PROJECT_NUMBER: 6
  STATUS_FIELD: Status
  STATUS_LABELS: '["ì‘ì—… ì „","ì‘ì—… ì¤‘","í™•ì¸ ëŒ€ê¸°","í”¼ë“œë°±","ì‘ì—… ì™„ë£Œ","ì·¨ì†Œ"]'

permissions:
  issues: write
  contents: read

jobs:
  # ===================================================================
  # Job 1: Projects Status ë³€ê²½ ì‹œ Issue Label ë™ê¸°í™”
  # ===================================================================
  sync-status-to-label:
    name: Projects Statusë¥¼ Issue Labelë¡œ ë™ê¸°í™”
    # ë´‡ì´ íŠ¸ë¦¬ê±°í•œ ê²½ìš° ë¬´í•œ ë£¨í”„ ë°©ì§€
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Project Item ì •ë³´ ì¡°íšŒ ë° Label ë™ê¸°í™”
        uses: actions/github-script@v7
        env:
          PROJECT_NUMBER: ${{ env.PROJECT_NUMBER }}
          STATUS_FIELD: ${{ env.STATUS_FIELD }}
          STATUS_LABELS: ${{ env.STATUS_LABELS }}
        with:
          github-token: ${{ secrets._GITHUB_PAT_TOKEN }}
          script: |
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ”„ Projects Status â†’ Issue Label ë™ê¸°í™” ì‹œì‘');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            const itemNodeId = context.payload.projects_v2_item?.node_id;

            if (!itemNodeId) {
              console.log('âš ï¸ Project item node_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              console.log('   í˜ì´ë¡œë“œ:', JSON.stringify(context.payload, null, 2));
              return;
            }

            console.log(`ğŸ“Œ Project Item Node ID: ${itemNodeId}`);

            try {
              // ===== 1. Project Item ìƒì„¸ ì •ë³´ ì¡°íšŒ =====
              const itemQuery = `
                query($itemId: ID!, $statusField: String!) {
                  node(id: $itemId) {
                    ... on ProjectV2Item {
                      content {
                        ... on Issue {
                          number
                          title
                          repository {
                            name
                            owner {
                              login
                            }
                          }
                          labels(first: 20) {
                            nodes {
                              name
                            }
                          }
                        }
                        ... on PullRequest {
                          number
                          title
                        }
                      }
                      fieldValueByName(name: $statusField) {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                        }
                      }
                    }
                  }
                }
              `;

              const itemData = await github.graphql(itemQuery, {
                itemId: itemNodeId,
                statusField: process.env.STATUS_FIELD
              });

              console.log('ğŸ“‹ ì¡°íšŒëœ ë°ì´í„°:', JSON.stringify(itemData, null, 2));

              const content = itemData.node?.content;

              if (!content) {
                console.log('âš ï¸ Project itemì˜ contentë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }

              // PRì¸ ê²½ìš° ìŠ¤í‚µ
              if (!content.repository) {
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log('â„¹ï¸ Pull RequestëŠ” ì²˜ë¦¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                return;
              }

              const issueNumber = content.number;
              const repoName = content.repository.name;
              const repoOwner = content.repository.owner.login;
              const currentLabels = content.labels.nodes.map(l => l.name);
              const newStatus = itemData.node?.fieldValueByName?.name;

              console.log(`ğŸ“Œ Issue: ${repoOwner}/${repoName}#${issueNumber}`);
              console.log(`ğŸ“Œ í˜„ì¬ Labels: ${currentLabels.join(', ') || '(ì—†ìŒ)'}`);
              console.log(`ğŸ“Œ ìƒˆ Status: "${newStatus}"`);

              if (!newStatus) {
                console.log('âš ï¸ Status ê°’ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }

              // ===== 2. Status Labels íŒŒì‹± =====
              let statusLabels;
              try {
                statusLabels = JSON.parse(process.env.STATUS_LABELS);
              } catch (e) {
                console.error('âŒ STATUS_LABELS íŒŒì‹± ì‹¤íŒ¨:', e.message);
                statusLabels = ['ì‘ì—… ì „', 'ì‘ì—… ì¤‘', 'í™•ì¸ ëŒ€ê¸°', 'í”¼ë“œë°±', 'ì‘ì—… ì™„ë£Œ', 'ì·¨ì†Œ'];
              }

              console.log(`ğŸ“Š ê´€ë¦¬ ëŒ€ìƒ Status Labels: ${statusLabels.join(', ')}`);

              // ===== 3. ìƒˆ Statusê°€ ê´€ë¦¬ ëŒ€ìƒì¸ì§€ í™•ì¸ =====
              if (!statusLabels.includes(newStatus)) {
                console.log(`âš ï¸ "${newStatus}"ëŠ” ê´€ë¦¬ ëŒ€ìƒ Status Labelì´ ì•„ë‹™ë‹ˆë‹¤.`);
                console.log('   Label ë™ê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
                return;
              }

              // ===== 4. ì´ë¯¸ ë™ì¼í•œ Labelì´ ìˆëŠ”ì§€ í™•ì¸ (ë¬´í•œ ë£¨í”„ ë°©ì§€) =====
              if (currentLabels.includes(newStatus)) {
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                console.log(`âœ… ì´ë¯¸ "${newStatus}" Labelì´ ì¡´ì¬í•©ë‹ˆë‹¤.`);
                console.log('   ë™ê¸°í™”ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                return;
              }

              // ===== 5. ê¸°ì¡´ Status Label ì œê±° =====
              const labelsToRemove = currentLabels.filter(label =>
                statusLabels.includes(label) && label !== newStatus
              );

              console.log(`ğŸ—‘ï¸ ì œê±°í•  Labels: ${labelsToRemove.join(', ') || '(ì—†ìŒ)'}`);

              for (const label of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: repoOwner,
                    repo: repoName,
                    issue_number: issueNumber,
                    name: label
                  });
                  console.log(`   âœ… "${label}" Label ì œê±°ë¨`);
                } catch (e) {
                  // Labelì´ ì´ë¯¸ ì—†ëŠ” ê²½ìš° ë¬´ì‹œ
                  if (e.status !== 404) {
                    console.warn(`   âš ï¸ "${label}" Label ì œê±° ì‹¤íŒ¨:`, e.message);
                  }
                }
              }

              // ===== 6. ìƒˆ Status Label ì¶”ê°€ =====
              console.log(`â• ì¶”ê°€í•  Label: "${newStatus}"`);

              try {
                await github.rest.issues.addLabels({
                  owner: repoOwner,
                  repo: repoName,
                  issue_number: issueNumber,
                  labels: [newStatus]
                });
                console.log(`   âœ… "${newStatus}" Label ì¶”ê°€ë¨`);
              } catch (e) {
                console.error(`   âŒ "${newStatus}" Label ì¶”ê°€ ì‹¤íŒ¨:`, e.message);
                throw e;
              }

              console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
              console.log('ğŸ‰ Label ë™ê¸°í™” ì™„ë£Œ!');
              console.log(`  â€¢ Issue: ${repoOwner}/${repoName}#${issueNumber}`);
              console.log(`  â€¢ Status: "${newStatus}"`);
              console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            } catch (error) {
              console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
              console.error('âŒ Label ë™ê¸°í™” ì‹¤íŒ¨');
              console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

              const errorMessage = error.message || JSON.stringify(error);
              const errorStatus = error.status || (error.response && error.response.status);

              if (errorStatus === 401 || errorMessage.includes('401') || errorMessage.includes('Unauthorized')) {
                console.error('ğŸ” ì¸ì¦ ì˜¤ë¥˜ (401 Unauthorized)');
                console.error('');
                console.error('ì›ì¸:');
                console.error('  1. _GITHUB_PAT_TOKEN Secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                console.error('  2. PAT í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                console.error('  3. PAT í† í°ì— í•„ìš”í•œ ê¶Œí•œ(repo, project)ì´ ì—†ìŠµë‹ˆë‹¤.');
                console.error('');
                console.error('í•´ê²° ë°©ë²•:');
                console.error('  1. GitHub Settings > Developer settings > Personal access tokens');
                console.error('  2. Classic PAT ìƒì„± (Fine-grained tokenì€ GraphQL ë¯¸ì§€ì›)');
                console.error('  3. ê¶Œí•œ ë¶€ì—¬: repo (ì „ì²´), project (read:project, write:project)');
                console.error('  4. Organization Secretsì— _GITHUB_PAT_TOKENìœ¼ë¡œ ë“±ë¡');

              } else if (errorStatus === 404 || errorMessage.includes('404') || errorMessage.includes('Not Found')) {
                console.error('ğŸ” ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (404 Not Found)');
                console.error('');
                console.error('ì›ì¸:');
                console.error('  1. Issueê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                console.error('  2. Labelì´ ë¦¬í¬ì§€í† ë¦¬ì— ì •ì˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
                console.error('  3. PAT í† í°ì— í•´ë‹¹ ë¦¬í¬ì§€í† ë¦¬ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                console.error('');
                console.error('í•´ê²° ë°©ë²•:');
                console.error('  1. Issue ì¡´ì¬ ì—¬ë¶€ í™•ì¸');
                console.error('  2. ë¦¬í¬ì§€í† ë¦¬ Labels ì„¤ì •ì—ì„œ Status Label ì¡´ì¬ ì—¬ë¶€ í™•ì¸');
                console.error('  3. PAT í† í° ê¶Œí•œ í™•ì¸');

              } else if (errorMessage.includes('rate limit') || errorMessage.includes('429')) {
                console.error('â±ï¸ API Rate Limit ì´ˆê³¼ (429 Too Many Requests)');
                console.error('');
                console.error('í•´ê²° ë°©ë²•:');
                console.error('  ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');

              } else {
                console.error('â“ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
              }

              console.error('');
              console.error('ì „ì²´ ì—ëŸ¬ ë©”ì‹œì§€:');
              console.error(errorMessage);
              if (error.stack) {
                console.error('');
                console.error('Stack Trace:');
                console.error(error.stack);
              }
              console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

              throw error;
            }
