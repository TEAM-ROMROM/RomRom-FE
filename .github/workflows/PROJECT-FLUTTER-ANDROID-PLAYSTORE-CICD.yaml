name: PROJECT-FLUTTER-ANDROID-PLAYSTORE-INTERNAL-CICD

on:
  push:
    branches: ["deploy"]
  workflow_run:
    workflows: ["CHANGELOG ìë™ ì—…ë°ì´íŠ¸"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

# ============================================
# ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì • (ì•„ë˜ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”)
# ============================================
env:
  # í”„ë¡œì íŠ¸ ì´ë¦„
  PROJECT_NAME: "your-project"
  # Flutter/Java ë²„ì „
  FLUTTER_VERSION: "3.35.5"
  JAVA_VERSION: "17"
  PROJECT_TYPE: "flutter"

jobs:
  prepare-build:
    name: í™˜ê²½ ì„¤ì • ë° ì¤€ë¹„
    runs-on: ubuntu-latest
    # CHANGELOG ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}

    outputs:
      version: ${{ steps.current_version.outputs.version }}
      version_code: ${{ steps.current_version.outputs.version_code }}
      project_type: ${{ steps.current_version.outputs.project_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      # ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
      - name: ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          chmod +x ./.github/scripts/version_manager.sh
          chmod +x ./.github/scripts/changelog_manager.py

      # version_manager.shë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: í˜„ì¬ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: current_version
        run: |
          # VERSION ê°€ì ¸ì˜¤ê¸° (x.y.z í˜•ì‹)
          VERSION=$(./.github/scripts/version_manager.sh get | tail -n 1)

          # VERSION_CODE ê°€ì ¸ì˜¤ê¸° (version.ymlì—ì„œ ê´€ë¦¬ë˜ëŠ” ë‹¨ìˆœ ì¦ê°€ ë²ˆí˜¸)
          VERSION_CODE=$(./.github/scripts/version_manager.sh get-code)

          # ê²°ê³¼ ì¶œë ¥
          echo "âœ… VERSION: $VERSION"
          echo "âœ… VERSION_CODE: $VERSION_CODE"
          echo "ğŸ”§ í”„ë¡œì íŠ¸ íƒ€ì…: ${{ env.PROJECT_TYPE }}"

          # GitHub outputs ì„¤ì •
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "project_type=${{ env.PROJECT_TYPE }}" >> $GITHUB_OUTPUT

          # í™˜ê²½ë³€ìˆ˜ë¡œë„ ì„¤ì • (ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "PROJECT_TYPE=${{ env.PROJECT_TYPE }}" >> $GITHUB_ENV

      # CHANGELOG.jsonì—ì„œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ - changelog_manager.py ì‚¬ìš©
      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: release_notes
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"

          if [ -f "CHANGELOG.json" ]; then
            echo "ğŸ“„ CHANGELOG.jsonì—ì„œ v$VERSION ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì¤‘..."
            # CHANGELOG.md ìƒì„±
            python3 ./.github/scripts/changelog_manager.py generate-md

            # changelog_manager.py exportë¡œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ
            python3 ./.github/scripts/changelog_manager.py export --version $VERSION --output final_release_notes.txt

            if [ -s final_release_notes.txt ]; then
              echo "âœ… ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì„±ê³µ!"
              echo "ğŸ“‹ ì¶”ì¶œëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸:"
              echo "----------------------------------------"
              cat final_release_notes.txt
              echo "----------------------------------------"
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "âŒ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
            fi
          else
            echo "âš ï¸ CHANGELOG.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
            echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
            echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
          fi

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: final_release_notes.txt
          retention-days: 1

      # í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      # .envëŠ” ë³´ì•ˆìƒ ì•„í‹°íŒ©íŠ¸ì— í¬í•¨í•˜ì§€ ì•Šê³ , ê° jobì—ì„œ secretsë¡œ ì¬ìƒì„±
      - name: Upload project files
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: |
            pubspec.yaml
            lib/
            assets/
          retention-days: 1

  build-android:
    name: Android AAB ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: prepare-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      # í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ ë‹¤ìš´ë¡œë“œ
      - name: Download project files
        uses: actions/download-artifact@v4
        with:
          name: project-files
          path: .

      # .env íŒŒì¼ ìƒì„± (ë³´ì•ˆì„ ìœ„í•´ ì•„í‹°íŒ©íŠ¸ê°€ ì•„ë‹Œ ì‹œí¬ë¦¿ì—ì„œ ìƒì„±)
      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo "âœ… .env íŒŒì¼ ìƒì„±ë¨ (í¬ê¸°: $(wc -c < .env) bytes)"

      # Release Keystore ì„¤ì •
      - name: Setup Release Keystore
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore/key.jks
          echo "âœ… Release Keystore ìƒì„± ì™„ë£Œ"
          ls -la android/app/keystore/

      # key.properties ìƒì„± (Release ì„œëª… ì •ë³´)
      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storeFile=keystore/key.jks
          storePassword=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.RELEASE_KEY_ALIAS }}
          keyPassword=${{ secrets.RELEASE_KEY_PASSWORD }}
          EOF
          echo "âœ… key.properties ìƒì„± ì™„ë£Œ"
          cat android/key.properties

      # Google-services.json ìƒì„±
      - name: Create Google-services.json
        run: |
          cat << 'EOF' > android/app/google-services.json
          ${{ secrets.GOOGLE_SERVICES_JSON }}
          EOF
          echo "âœ… Google-services.json ìƒì„± ì™„ë£Œ"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Android build.gradle.kts ìˆ˜ì • (release ì„œëª… ì„¤ì •)
      - name: Configure Android build for release
        run: |
          # build.gradle.ktsì— release ì„œëª… ì„¤ì •ì´ ì—†ìœ¼ë©´ ì¶”ê°€
          if ! grep -q "signingConfigs" android/app/build.gradle.kts; then
            echo "âš ï¸ build.gradle.ktsì— ì„œëª… ì„¤ì • ì¶”ê°€ í•„ìš”"
            # ì„œëª… ì„¤ì •ì€ ì´ë¯¸ ë˜ì–´ìˆë‹¤ê³  ê°€ì • (ìˆ˜ë™ìœ¼ë¡œ ë¯¸ë¦¬ ì„¤ì •í•´ì•¼ í•¨)
          fi
          echo "âœ… Android ë¹Œë“œ ì„¤ì • í™•ì¸ ì™„ë£Œ"

      # pubspec.yamlì€ x.y.z í˜•ì‹ ê·¸ëŒ€ë¡œ ìœ ì§€
      # Flutter build ëª…ë ¹ì–´ì˜ --build-name, --build-number í”Œë˜ê·¸ê°€ pubspec.yamlì„ ì˜¤ë²„ë¼ì´ë“œí•¨

      # Flutter build appbundle (AAB ìƒì„±)
      - name: Build Android App Bundle (AAB)
        run: |
          VERSION_NAME="${{ needs.prepare-build.outputs.version }}"
          VERSION_CODE="${{ needs.prepare-build.outputs.version_code }}"

          echo "=========================================="
          echo "ğŸš€ AAB ë¹Œë“œ ì‹œì‘"
          echo "=========================================="
          echo "ğŸ¯ ë¹Œë“œ ë²„ì „: $VERSION_NAME"
          echo "ğŸ¯ ë¹Œë“œ ì½”ë“œ: $VERSION_CODE"

          # ì…ë ¥ ê²€ì¦
          if [ -z "$VERSION_NAME" ] || [ -z "$VERSION_CODE" ]; then
            echo "âŒ VERSION_NAME ë˜ëŠ” VERSION_CODEê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          # Flutter í™˜ê²½ ì •ë³´ ì¶œë ¥
          echo "ğŸ” Flutter í™˜ê²½ ì •ë³´:"
          flutter --version
          flutter doctor -v | head -20
          
          # ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë¦¬
          echo "ğŸ§¹ ì´ì „ ë¹Œë“œ ê²°ê³¼ë¬¼ ì •ë¦¬..."
          rm -rf build/app/outputs/bundle/release/
          mkdir -p build/app/outputs/bundle/release/
          
          # Flutter clean ë° pub get
          echo "ğŸ”„ Flutter clean ë° ì˜ì¡´ì„± ì¬ì„¤ì¹˜..."
          flutter clean
          flutter pub get

          # local.propertiesì— ë²„ì „ ì •ë³´ ì¶”ê°€ (Flutter í”Œë˜ê·¸ê°€ ë¬´ì‹œë˜ëŠ” ë¬¸ì œ í•´ê²°)
          echo "ğŸ”§ local.propertiesì— ë²„ì „ ì •ë³´ ì„¤ì •..."

          # ê¸°ì¡´ local.propertiesê°€ ìˆìœ¼ë©´ ë²„ì „ ì •ë³´ ì œê±°
          if [ -f "android/local.properties" ]; then
            grep -v "flutter.versionName\|flutter.versionCode" android/local.properties > android/local.properties.tmp || true
            mv android/local.properties.tmp android/local.properties
          else
            touch android/local.properties
          fi

          # ë²„ì „ ì •ë³´ ì¶”ê°€
          echo "flutter.versionName=$VERSION_NAME" >> android/local.properties
          echo "flutter.versionCode=$VERSION_CODE" >> android/local.properties

          echo "âœ… local.properties ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "ğŸ“‹ ë²„ì „ ì •ë³´: VERSION_NAME=$VERSION_NAME, VERSION_CODE=$VERSION_CODE"

          # Gradle ì„±ëŠ¥ ìµœì í™” ì„¤ì •
          export GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4"
          export JAVA_OPTS="-Xmx4g"
          echo "âœ… Gradle ìµœì í™” ì„¤ì • ì™„ë£Œ"

          # Flutter build ëª…ë ¹ì–´ì— ë²„ì „ ì •ë³´ ì „ë‹¬
          # --build-nameê³¼ --build-number í”Œë˜ê·¸ê°€ pubspec.yamlì˜ versionì„ ì˜¤ë²„ë¼ì´ë“œí•¨
          # pubspec.yamlì€ x.y.z í˜•ì‹ ìœ ì§€, VERSION_CODEëŠ” version.ymlì—ì„œ ìë™ ê´€ë¦¬
          echo "ğŸ”¨ Flutter build ì‹¤í–‰..."
          echo "ğŸ“‹ ëª…ë ¹ì–´: flutter build appbundle --release --build-name=$VERSION_NAME --build-number=$VERSION_CODE --verbose"
          echo "â±ï¸ ë¹Œë“œ ì‹œì‘ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"

          flutter build appbundle \
            --release \
            --build-name="$VERSION_NAME" \
            --build-number="$VERSION_CODE" \
            --verbose
          
          BUILD_EXIT_CODE=$?
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ Flutter build ì‹¤íŒ¨! Exit code: $BUILD_EXIT_CODE"
            echo "ğŸ” ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒíƒœ:"
            find build/ -name "*.aab" -o -name "*.apk" 2>/dev/null || echo "AAB/APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          echo "âœ… Flutter build ì„±ê³µ!"
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo "ğŸ” ë¹Œë“œ ê²°ê³¼ í™•ì¸:"
          ls -lah build/app/outputs/bundle/release/
          
          # AAB íŒŒì¼ ì¡´ì¬ í™•ì¸
          AAB_FILE="build/app/outputs/bundle/release/app-release.aab"
          if [ ! -f "$AAB_FILE" ]; then
            echo "âŒ AAB íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "ğŸ” ì „ì²´ ë¹Œë“œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            find build/ -type f -name "*.aab" -o -name "*.apk" 2>/dev/null || echo "AAB/APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "ğŸ” outputs ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
            find build/app/outputs/ -type f 2>/dev/null || echo "outputs ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          echo "âœ… AAB íŒŒì¼ ìƒì„± í™•ì¸"
          echo "ğŸ“± AAB íŒŒì¼ í¬ê¸°: $(du -h "$AAB_FILE" | cut -f1)"
          echo "ğŸ“‹ AAB íŒŒì¼ ì •ë³´: $(ls -lah "$AAB_FILE")"
          
          # bundletool ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
          echo "ğŸ“¦ bundletool ë‹¤ìš´ë¡œë“œ ì¤‘..."
          BUNDLETOOL_VERSION="1.15.6"
          BUNDLETOOL_URL="https://github.com/google/bundletool/releases/download/${BUNDLETOOL_VERSION}/bundletool-all-${BUNDLETOOL_VERSION}.jar"
          
          echo "ğŸ“‹ ë‹¤ìš´ë¡œë“œ URL: $BUNDLETOOL_URL"
          wget -q "$BUNDLETOOL_URL" -O bundletool.jar
          
          if [ ! -f "bundletool.jar" ]; then
            echo "âŒ bundletool ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            echo "ğŸ”„ ëŒ€ì²´ URLë¡œ ì¬ì‹œë„..."
            wget -q "https://github.com/google/bundletool/releases/latest/download/bundletool-all-1.15.6.jar" -O bundletool.jar
            
            if [ ! -f "bundletool.jar" ]; then
              echo "âŒ bundletool ë‹¤ìš´ë¡œë“œ ì™„ì „ ì‹¤íŒ¨"
              exit 1
            fi
          fi
          
          echo "âœ… bundletool ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          echo "ğŸ“‹ bundletool íŒŒì¼ í¬ê¸°: $(du -h bundletool.jar | cut -f1)"
          
          # Java í™˜ê²½ í™•ì¸
          echo "ğŸ” Java í™˜ê²½ í™•ì¸:"
          java -version
          
          # AAB íŒŒì¼ ë‚´ë¶€ì˜ ì‹¤ì œ ë²„ì „ ì •ë³´ í™•ì¸
          # Flutter CLI í”Œë˜ê·¸ë¡œ ì „ë‹¬í•œ VERSION_CODEê°€ ì œëŒ€ë¡œ ì ìš©ë˜ì—ˆëŠ”ì§€ ê²€ì¦
          echo "=========================================="
          echo "ğŸ” AAB íŒŒì¼ ë‚´ë¶€ ë²„ì „ ì •ë³´ ê²€ì¦"
          echo "=========================================="

          # AndroidManifest.xmlì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
          echo "ğŸ“‹ AABì—ì„œ ì‹¤ì œ ë²„ì „ ì •ë³´ ì¶”ì¶œ ì¤‘..."
          echo "ğŸ“‹ ì‹¤í–‰í•  ëª…ë ¹ì–´: java -jar bundletool.jar dump manifest --bundle='$AAB_FILE'"
          
          MANIFEST_OUTPUT=$(java -jar bundletool.jar dump manifest --bundle="$AAB_FILE" 2>&1)
          MANIFEST_EXIT_CODE=$?
          
          echo "ğŸ“‹ bundletool ì‹¤í–‰ ê²°ê³¼ (Exit code: $MANIFEST_EXIT_CODE):"
          echo "$MANIFEST_OUTPUT"
          
          if [ $MANIFEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… Manifest ì¶”ì¶œ ì„±ê³µ"
            
            # ì‹¤ì œ ë²„ì „ ì½”ë“œì™€ ë²„ì „ ì´ë¦„ ì¶”ì¶œ
            ACTUAL_VERSION_CODE=$(echo "$MANIFEST_OUTPUT" | grep -o 'android:versionCode="[0-9]*"' | grep -o '[0-9]*' | head -1)
            ACTUAL_VERSION_NAME=$(echo "$MANIFEST_OUTPUT" | grep -o 'android:versionName="[^"]*"' | sed 's/android:versionName="//;s/"//' | head -1)
            
            echo "ğŸ¯ ë²„ì „ ì •ë³´ ë¹„êµ:"
            echo "  ì˜ˆìƒ VERSION_CODE: '$VERSION_CODE'"
            echo "  ì‹¤ì œ VERSION_CODE: '$ACTUAL_VERSION_CODE'"
            echo "  ì˜ˆìƒ VERSION_NAME: '$VERSION_NAME'"
            echo "  ì‹¤ì œ VERSION_NAME: '$ACTUAL_VERSION_NAME'"
            
            # VERSION_CODE ê²€ì¦ - version.ymlì—ì„œ ê´€ë¦¬ë˜ëŠ” ë‹¨ìˆœ ì¦ê°€ ë²ˆí˜¸
            if [ -z "$ACTUAL_VERSION_CODE" ]; then
              echo "âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: AABì—ì„œ VERSION_CODEë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
              echo "ğŸ” ì „ì²´ Manifest ë‚´ìš©:"
              echo "$MANIFEST_OUTPUT"
              exit 1
            elif [ "$ACTUAL_VERSION_CODE" != "$VERSION_CODE" ]; then
              echo "âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: AABì˜ VERSION_CODEê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤!"
              echo "   ì´ëŠ” Google Playì—ì„œ 'ì´ë¯¸ ì‚¬ìš©ëœ ë²„ì „ ì½”ë“œ' ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤."
              echo ""
              echo "ğŸ” ë””ë²„ê¹… ì •ë³´:"
              echo "   version.ymlì˜ VERSION_CODE: $VERSION_CODE"
              echo "   AAB íŒŒì¼ ë‚´ë¶€ì˜ VERSION_CODE: $ACTUAL_VERSION_CODE"
              echo ""
              echo "   Flutter build ëª…ë ¹ì–´ì— ì „ë‹¬ëœ í”Œë˜ê·¸:"
              echo "   --build-name='$VERSION_NAME'"
              echo "   --build-number='$VERSION_CODE'"
              echo ""
              echo "   ì „ì²´ Manifest ë‚´ìš©:"
              echo "$MANIFEST_OUTPUT" | grep -E "versionCode|versionName|package"
              exit 1
            else
              echo "âœ… VERSION_CODE ê²€ì¦ ì„±ê³µ: $ACTUAL_VERSION_CODE"
            fi
            
            # ë²„ì „ ì´ë¦„ë„ í™•ì¸ (ê²½ê³ ë§Œ)
            if [ -z "$ACTUAL_VERSION_NAME" ]; then
              echo "âš ï¸ ê²½ê³ : AABì—ì„œ VERSION_NAMEì„ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            elif [ "$ACTUAL_VERSION_NAME" != "$VERSION_NAME" ]; then
              echo "âš ï¸ ê²½ê³ : VERSION_NAMEì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤ (ì¹˜ëª…ì ì´ì§€ ì•ŠìŒ)"
              echo "   ì˜ˆìƒ: '$VERSION_NAME', ì‹¤ì œ: '$ACTUAL_VERSION_NAME'"
            else
              echo "âœ… VERSION_NAME ê²€ì¦ ì„±ê³µ: $ACTUAL_VERSION_NAME"
            fi
            
          else
            echo "âŒ bundletoolë¡œ Manifest ì¶”ì¶œ ì‹¤íŒ¨"
            echo "ğŸ”„ ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ê²€ì¦ ì‹œë„..."
            
            # unzipìœ¼ë¡œ ì§ì ‘ í™•ì¸ ì‹œë„
            echo "ğŸ“‹ unzipì„ ì‚¬ìš©í•œ ì§ì ‘ ì¶”ì¶œ ì‹œë„..."
            UNZIP_OUTPUT=$(unzip -p "$AAB_FILE" base/manifest/AndroidManifest.xml 2>/dev/null | strings | grep -E "versionCode|versionName")
            
            if [ -n "$UNZIP_OUTPUT" ]; then
              echo "âœ… unzipìœ¼ë¡œ ë²„ì „ ì •ë³´ ì¶”ì¶œ ì„±ê³µ:"
              echo "$UNZIP_OUTPUT"
            else
              echo "âŒ unzipì„ ì‚¬ìš©í•œ ì§ì ‘ ì¶”ì¶œë„ ì‹¤íŒ¨"
              echo "âš ï¸ AAB ê²€ì¦ì„ ê±´ë„ˆë›°ê³  ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
            fi
          fi
          
          echo "=========================================="
          echo "âœ… AAB ë¹Œë“œ ë° ê²€ì¦ ì™„ë£Œ"
          echo "ğŸ¯ ìµœì¢… AAB: $AAB_FILE"
          echo "ğŸ“± íŒŒì¼ í¬ê¸°: $(du -h "$AAB_FILE" | cut -f1)"
          echo "=========================================="

      # AAB íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 1

  deploy-playstore:
    name: Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬
    runs-on: ubuntu-latest
    needs: [prepare-build, build-android]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      # Service Account JSON ì„¤ì •
      - name: Setup Google Play Service Account
        run: |
          mkdir -p ~/.config/gcloud
          echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}" | base64 --decode > ~/.config/gcloud/service-account.json
          echo "âœ… Service Account JSON ì„¤ì • ì™„ë£Œ"

      # AAB íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      # Ruby ë° Fastlane ì„¤ì¹˜
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"

      - name: Install Fastlane
        run: |
          gem install fastlane
          echo "âœ… Fastlane ì„¤ì¹˜ ì™„ë£Œ"
          fastlane --version

      # Fastfile ë³µì‚¬ (Play Store ë°°í¬ìš©)
      # android/fastlane/Fastfile.playstoreë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€
      - name: Copy Fastfile for Play Store
        run: |
          mkdir -p android/fastlane
          cp android/fastlane/Fastfile.playstore android/fastlane/Fastfile
          echo "âœ… Fastfile ë³µì‚¬ ì™„ë£Œ (Fastfile.playstore â†’ Fastfile)"
          echo "ğŸ“‹ Fastfile ë‚´ìš©:"
          cat android/fastlane/Fastfile

      # Play Storeì— ì—…ë¡œë“œ
      - name: Upload to Play Store Internal Testing
        run: |
          echo "=========================================="
          echo "ğŸš€ Play Store ë°°í¬ ì‹œì‘"
          echo "=========================================="
          echo "ğŸ• ë°°í¬ ì‹œì‘ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” GitHub Run Number: ${{ github.run_number }}"
          echo "ğŸ” GitHub SHA: ${{ github.sha }}"
          
          # í™˜ê²½ ë³€ìˆ˜ ì´ˆê¸°í™” ë° ê²€ì¦
          VERSION_CODE="${{ needs.prepare-build.outputs.version_code }}"
          VERSION_NAME="${{ needs.prepare-build.outputs.version }}"
          
          echo "ğŸ“‹ ë°°í¬ ëŒ€ìƒ ë²„ì „ ì •ë³´:"
          echo "  VERSION_NAME: '$VERSION_NAME'"
          echo "  VERSION_CODE: '$VERSION_CODE'"
          
          # ì…ë ¥ ê²€ì¦
          if [ -z "$VERSION_NAME" ] || [ -z "$VERSION_CODE" ]; then
            echo "âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: VERSION_NAME ë˜ëŠ” VERSION_CODEê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"
            echo "VERSION_NAME: '$VERSION_NAME'"
            echo "VERSION_CODE: '$VERSION_CODE'"
            echo "ì´ëŠ” prepare-build ì‘ì—…ì—ì„œ ì¶œë ¥ì´ ì œëŒ€ë¡œ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          # AAB íŒŒì¼ ì ˆëŒ€ ê²½ë¡œ ì°¾ê¸°
          AAB_PATH=$(realpath build/app/outputs/bundle/release/app-release.aab)
          echo "ğŸ“¦ AAB íŒŒì¼ ê²½ë¡œ: $AAB_PATH"

          if [ ! -f "$AAB_PATH" ]; then
            echo "âŒ AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "ğŸ” ë¹Œë“œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la build/app/outputs/bundle/release/ || echo "ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            echo "ğŸ” ì „ì²´ ë¹Œë“œ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
            find build/ -name "*.aab" -o -name "*.apk" 2>/dev/null || echo "AAB/APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          echo "âœ… AAB íŒŒì¼ ì¡´ì¬ í™•ì¸"
          echo "ğŸ“‹ AAB íŒŒì¼ ì •ë³´: $(ls -lah "$AAB_PATH")"
          echo "ğŸ“± AAB íŒŒì¼ í¬ê¸°: $(du -h "$AAB_PATH" | cut -f1)"
          
          # ë°°í¬ ì „ AAB ë²„ì „ ê²€ì¦
          echo "=========================================="
          echo "ğŸ” AAB ë²„ì „ ê²€ì¦ ì¤‘..."
          echo "=========================================="
          
          # bundletool ë‹¤ìš´ë¡œë“œ
          if [ ! -f "bundletool.jar" ]; then
            wget -q "https://github.com/google/bundletool/releases/download/1.15.6/bundletool-all-1.15.6.jar" -O bundletool.jar
          fi
          
          if [ -f "bundletool.jar" ]; then
            MANIFEST_OUTPUT=$(java -jar bundletool.jar dump manifest --bundle="$AAB_PATH" 2>&1)
            
            if [ $? -eq 0 ]; then
              FINAL_VERSION_CODE=$(echo "$MANIFEST_OUTPUT" | grep -o 'android:versionCode="[0-9]*"' | grep -o '[0-9]*' | head -1)
              FINAL_VERSION_NAME=$(echo "$MANIFEST_OUTPUT" | grep -o 'android:versionName="[^"]*"' | sed 's/android:versionName="//;s/"//' | head -1)
              
              echo "ğŸ“‹ AAB ë²„ì „: $FINAL_VERSION_NAME (ì½”ë“œ: $FINAL_VERSION_CODE)"
              
              # VERSION_CODE ê²€ì¦
              if [ "$FINAL_VERSION_CODE" != "$VERSION_CODE" ]; then
                echo "âŒ ì˜¤ë¥˜: AAB ë²„ì „ ì½”ë“œê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤! (ì˜ˆìƒ: $VERSION_CODE, ì‹¤ì œ: $FINAL_VERSION_CODE)"
                exit 1
              fi
              
              echo "âœ… ë²„ì „ ê²€ì¦ ì„±ê³µ"
            else
              echo "âš ï¸ ë²„ì „ ê²€ì¦ ì‹¤íŒ¨, ë°°í¬ ê³„ì† ì§„í–‰"
            fi
          fi

          # Release notes ì¤€ë¹„
          CHANGELOG_DIR="android/fastlane/metadata/android/ko-KR/changelogs"
          mkdir -p "$CHANGELOG_DIR"
          
          if [ -f "final_release_notes.txt" ]; then
            cp final_release_notes.txt "$CHANGELOG_DIR/${VERSION_CODE}.txt"
            echo "âœ… Changelog ì¤€ë¹„ ì™„ë£Œ (ë²„ì „ ì½”ë“œ: $VERSION_CODE)"
          else
            echo "v$VERSION_NAME ì—…ë°ì´íŠ¸" > "$CHANGELOG_DIR/${VERSION_CODE}.txt"
            echo "âš ï¸ ê¸°ë³¸ Changelog ìƒì„± (ë²„ì „ ì½”ë“œ: $VERSION_CODE)"
          fi
          
          # Service Account JSON íŒŒì¼ í™•ì¸
          GOOGLE_PLAY_JSON_KEY="$HOME/.config/gcloud/service-account.json"
          if [ ! -f "$GOOGLE_PLAY_JSON_KEY" ]; then
            echo "âŒ Service Account JSON íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export AAB_PATH="$AAB_PATH"
          export GOOGLE_PLAY_JSON_KEY="$GOOGLE_PLAY_JSON_KEY"
          export VERSION_NAME="$VERSION_NAME"
          export VERSION_CODE="$VERSION_CODE"
          
          # ë°°í¬ ì‹¤í–‰
          echo "=========================================="
          echo "ğŸš€ Play Store ë°°í¬ ì‹¤í–‰"
          echo "ğŸ¯ ë²„ì „: $VERSION_NAME (ì½”ë“œ: $VERSION_CODE)"
          echo "=========================================="
          
          cd android
          fastlane deploy_internal

      # ì„±ê³µ ì•Œë¦¼
      - name: Notify Play Store Upload Success
        if: success()
        run: |
          echo "âœ… Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì„±ê³µ!"
          echo "ë²„ì „: ${{ needs.prepare-build.outputs.version }} (${{ needs.prepare-build.outputs.version_code }})"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          echo ""
          echo "ğŸ“± í…ŒìŠ¤í„° í™•ì¸ ë°©ë²•:"
          echo "1. Play Console â†’ í…ŒìŠ¤íŠ¸ ë° ì¶œì‹œ â†’ ë‚´ë¶€ í…ŒìŠ¤íŠ¸"
          echo "2. í…ŒìŠ¤í„°ì—ê²Œ í…ŒìŠ¤íŠ¸ ë§í¬ ê³µìœ "
          # Play Console URLì€ í”„ë¡œì íŠ¸ë³„ë¡œ ë‹¤ë¥´ë¯€ë¡œ ë³„ë„ ì„¤ì • í•„ìš”

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Play Store ë°°í¬ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
