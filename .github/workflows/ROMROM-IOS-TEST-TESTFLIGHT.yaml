# ===================================================================
# iOS í…ŒìŠ¤íŠ¸ìš© TestFlight ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” test-deploy ë¸Œëœì¹˜ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬
# í…ŒìŠ¤íŠ¸ìš© iOS ë¹Œë“œë¥¼ TestFlightì— ë°°í¬í•©ë‹ˆë‹¤.
#
# ì£¼ìš” íŠ¹ì§•:
# - workflow_dispatchë¡œ ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥
# - ë²„ì „ì€ 0.0.0ìœ¼ë¡œ ê³ ì • (ìš´ì˜ ë²„ì „ê³¼ ë¶„ë¦¬)
# - ë¹Œë“œ ë²ˆí˜¸ëŠ” GITHUB_RUN_NUMBER ì‚¬ìš© (ì ˆëŒ€ ê²¹ì¹˜ì§€ ì•ŠìŒ)
# - ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ìë™ ì¶”ì¶œ (YYYYMMDD_#ì´ìŠˆë²ˆí˜¸_ë‚´ìš© í˜•ì‹)
# - GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì™€ì„œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ì— í¬í•¨
# - CHANGELOG ë¡œì§ ì œê±°, ë‹¨ìˆœí™”ëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì‚¬ìš©
#
# ë¸Œëœì¹˜ëª… ì˜ˆì‹œ:
# - 20251208_#387_ë‚´ìš©
# - 20250115_#123_ë²„ê·¸ìˆ˜ì •
#
# ì‚¬ìš© ë°©ë²•:
# 1. test-deploy ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
# 2. GitHub Actionsì—ì„œ "ROMROM-IOS-TEST-TESTFLIGHT" ì›Œí¬í”Œë¡œìš° ì„ íƒ
# 3. "Run workflow" ë²„íŠ¼ í´ë¦­
#
# ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ í˜•ì‹:
# í…ŒìŠ¤íŠ¸ ë¹Œë“œ #123
# ë¸Œëœì¹˜: 20251208_#387_ë‚´ìš©
# ì»¤ë°‹: abc1234...
# ë‚ ì§œ: 2025-12-08 10:30:00
# ê´€ë ¨ ì´ìŠˆ:
# - #387: [ì´ìŠˆ ì œëª©]
# - URL: https://github.com/TEAM-ROMROM/RomRom-FE/issues/387
#
# ===================================================================

name: ROMROM-IOS-TEST-TESTFLIGHT

on:
  workflow_dispatch:
  repository_dispatch:
    types: [build-ios-app]

env:
  FLUTTER_VERSION: "3.35.5"
  XCODE_VERSION: "16.4"
  PROJECT_TYPE: "flutter"

jobs:
  prepare-test-build:
    name: í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì¤€ë¹„
    runs-on: macos-15

    outputs:
      version: ${{ steps.test_version.outputs.version }}
      build_number: ${{ steps.test_version.outputs.build_number }}
      issue_url: ${{ steps.issue_info.outputs.issue_url }}
      issue_title: ${{ steps.issue_info.outputs.issue_title }}
      issue_number: ${{ steps.issue_info.outputs.issue_number }}
      branch_name: ${{ steps.issue_info.outputs.branch_name }}
      pr_number: ${{ steps.test_version.outputs.pr_number }}
      commit_hash: ${{ steps.release_notes.outputs.commit_hash }}
      progress_comment_id: ${{ steps.progress_comment.outputs.comment_id }}
      progress_start_time: ${{ steps.progress_comment.outputs.start_time }}
      step1_elapsed: ${{ steps.progress_step1.outputs.elapsed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created"

      - name: Create Secrets.xcconfig file
        run: |
          mkdir -p ios/Flutter
          if [ -n "${{ secrets.SECRETS_XCCONFIG }}" ]; then
            echo "${{ secrets.SECRETS_XCCONFIG }}" > ios/Flutter/Secrets.xcconfig
            echo "Secrets.xcconfig created"
          else
            echo "// No secrets provided" > ios/Flutter/Secrets.xcconfig
          fi

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install

      # í…ŒìŠ¤íŠ¸ ë¹Œë“œ ë²„ì „ ì„¤ì • (0.0.0 ê³ ì •)
      - name: í…ŒìŠ¤íŠ¸ ë¹Œë“œ ë²„ì „ ì„¤ì •
        id: test_version
        run: |
          echo "version=0.0.0" >> $GITHUB_OUTPUT
          
          # repository_dispatch ì´ë²¤íŠ¸ì¸ ê²½ìš° PR ë²ˆí˜¸ë¥¼ ë¹Œë“œ ë²ˆí˜¸ë¡œ ì‚¬ìš©
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BUILD_NUMBER="${{ github.event.client_payload.build_number }}"
            PR_NUMBER="${{ github.event.client_payload.pr_number }}"
            echo "ğŸ“‹ repository_dispatch ì´ë²¤íŠ¸ ê°ì§€"
            echo "  PR ë²ˆí˜¸: #$PR_NUMBER"
            echo "  ë¹Œë“œ ë²ˆí˜¸: $BUILD_NUMBER (PR ë²ˆí˜¸ ì‚¬ìš©)"
          else
            BUILD_NUMBER="${{ github.run_number }}"
            PR_NUMBER=""
            echo "ğŸ“‹ workflow_dispatch ì´ë²¤íŠ¸ ê°ì§€"
            echo "  ë¹Œë“œ ë²ˆí˜¸: $BUILD_NUMBER (ê¸°ë³¸ê°’)"
          fi
          
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ í…ŒìŠ¤íŠ¸ ë¹Œë“œ: ë²„ì „=0.0.0, ë¹Œë“œë²ˆí˜¸=$BUILD_NUMBER"

      # ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ ë° GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ì •ë³´ ì¶”ì¶œ
        id: issue_info
        run: |
          # repository_dispatchì¸ ê²½ìš° client_payloadì—ì„œ ë¸Œëœì¹˜ëª… ê°€ì ¸ì˜¤ê¸°
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BRANCH_NAME="${{ github.event.client_payload.branch_name }}"
            ISSUE_NUMBER="${{ github.event.client_payload.issue_number }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
            # ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (#387 í˜•ì‹) - sed ì‚¬ìš© (macOS/Linux í˜¸í™˜)
            ISSUE_NUMBER=$(echo "$BRANCH_NAME" | sed -n 's/.*#\([0-9]*\).*/\1/p')
          fi

          echo "ğŸŒ¿ ë¸Œëœì¹˜ëª…: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âš ï¸ ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "issue_url=" >> $GITHUB_OUTPUT
            echo "issue_title=" >> $GITHUB_OUTPUT
            echo "issue_number=" >> $GITHUB_OUTPUT
          else
            echo "âœ… ì¶”ì¶œëœ ì´ìŠˆ ë²ˆí˜¸: #$ISSUE_NUMBER"
            ISSUE_URL="https://github.com/${{ github.repository }}/issues/$ISSUE_NUMBER"
            echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

            # GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ” GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ì¡°íšŒ ì¤‘..."
            ISSUE_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")

            # ì´ìŠˆ ì œëª© ì¶”ì¶œ
            ISSUE_TITLE=$(echo "$ISSUE_RESPONSE" | jq -r '.title // "ì´ìŠˆ ì •ë³´ ì—†ìŒ"')

            # ì´ìŠˆ ìƒíƒœ í™•ì¸
            ISSUE_STATE=$(echo "$ISSUE_RESPONSE" | jq -r '.state // "unknown"')

            if [ "$ISSUE_TITLE" = "null" ] || [ "$ISSUE_TITLE" = "ì´ìŠˆ ì •ë³´ ì—†ìŒ" ]; then
              echo "âš ï¸ ì´ìŠˆ #$ISSUE_NUMBERë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "issue_title=" >> $GITHUB_OUTPUT
            else
              echo "ğŸ“‹ ì´ìŠˆ ì œëª©: $ISSUE_TITLE"
              echo "ğŸ“Œ ì´ìŠˆ ìƒíƒœ: $ISSUE_STATE"
              echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
            fi
          fi

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: release_notes
        run: |
          BUILD_NUMBER="${{ steps.test_version.outputs.build_number }}"
          BRANCH_NAME="${{ steps.issue_info.outputs.branch_name }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')

          # commit_hash output ì €ì¥
          echo "commit_hash=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          
          # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
          cat > final_release_notes.txt << EOF
          í…ŒìŠ¤íŠ¸ ë¹Œë“œ #$BUILD_NUMBER
          
          ë¸Œëœì¹˜: $BRANCH_NAME
          ì»¤ë°‹: $COMMIT_SHORT
          ë‚ ì§œ: $BUILD_DATE
          
          EOF
          
          # ì´ìŠˆ ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€
          if [ -n "${{ steps.issue_info.outputs.issue_number }}" ]; then
            ISSUE_NUMBER="${{ steps.issue_info.outputs.issue_number }}"
            ISSUE_TITLE="${{ steps.issue_info.outputs.issue_title }}"
            ISSUE_URL="${{ steps.issue_info.outputs.issue_url }}"
          
            cat >> final_release_notes.txt << EOF
          ê´€ë ¨ ì´ìŠˆ:
          - #$ISSUE_NUMBER: $ISSUE_TITLE
          - URL: $ISSUE_URL
          
          EOF
          fi
          
          echo "ğŸ“‹ ìƒì„±ëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸:"
          echo "----------------------------------------"
          cat final_release_notes.txt
          echo "----------------------------------------"

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: final_release_notes.txt
          retention-days: 1

      # í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload project files
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: |
            .env
            ios/Flutter/Secrets.xcconfig
            pubspec.yaml
            lib/
            assets/
          retention-days: 1

      # ì§„í–‰ìƒí™© ëŒ“ê¸€ ìƒì„± (repository_dispatchë¡œ íŠ¸ë¦¬ê±°ëœ ê²½ìš°ì—ë§Œ)
      - name: ì§„í–‰ìƒí™© ëŒ“ê¸€ ìƒì„±
        id: progress_comment
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ github.event.client_payload.pr_number }}');
            const buildNumber = '${{ steps.test_version.outputs.build_number }}';
            const branchName = '${{ steps.issue_info.outputs.branch_name }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const startTime = Date.now();

            const body = [
              '## ğŸ iOS TestFlight ë¹Œë“œ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              '| ğŸ”§ ì¤€ë¹„ | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸ”¨ IPA ë¹Œë“œ | â¸ï¸ ëŒ€ê¸° | - |',
              '| ğŸ“¤ TestFlight ë°°í¬ | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `ğŸ“‹ **[ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`
            ].join('\n');

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`âœ… ì§„í–‰ìƒí™© ëŒ“ê¸€ ìƒì„± ì™„ë£Œ (ID: ${comment.id})`);
            core.setOutput('comment_id', comment.id.toString());
            core.setOutput('start_time', startTime.toString());

      # ì§„í–‰ìƒí™© - ì¤€ë¹„ ì™„ë£Œ
      - name: ì§„í–‰ìƒí™© - ì¤€ë¹„ ì™„ë£Œ
        id: progress_step1
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ steps.progress_comment.outputs.comment_id }}');
            const startTime = parseInt('${{ steps.progress_comment.outputs.start_time }}');
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const elapsed = Math.round((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const elapsedStr = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const body = [
              '## ğŸ iOS TestFlight ë¹Œë“œ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”§ ì¤€ë¹„ | âœ… ì™„ë£Œ | ${elapsedStr} |`,
              '| ğŸ”¨ IPA ë¹Œë“œ | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸ“¤ TestFlight ë°°í¬ | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              `ğŸ“‹ **[ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            console.log(`âœ… ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸: ì¤€ë¹„ ì™„ë£Œ (${elapsedStr})`);
            core.setOutput('elapsed', elapsedStr);

  build-ios-test:
    name: iOS í…ŒìŠ¤íŠ¸ ë¹Œë“œ
    runs-on: macos-15
    needs: prepare-test-build

    outputs:
      step2_elapsed: ${{ steps.progress_step2.outputs.elapsed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      # í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ ë‹¤ìš´ë¡œë“œ
      - name: Download project files
        uses: actions/download-artifact@v4
        with:
          name: project-files
          path: .

      # .env íŒŒì¼ í™•ì¸ ë° ì¬ìƒì„±
      - name: Ensure .env file exists
        run: |
          if [ ! -f .env ]; then
            echo "âš ï¸ .env íŒŒì¼ì´ ì•„í‹°íŒ©íŠ¸ì—ì„œ ë³µì›ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¬ìƒì„±í•©ë‹ˆë‹¤."
            echo "${{ secrets.ENV_FILE }}" > .env
          fi
          echo "âœ… .env íŒŒì¼ í™•ì¸ë¨ (í¬ê¸°: $(wc -c < .env) bytes)"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install

      # Apple ì¸ì¦ì„œ ì„¤ì •
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profile
        run: |
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          uuid=$(grep -A1 -a "UUID" profile.mobileprovision | grep string | sed -e "s/<string>//" -e "s/<\/string>//" -e "s/[[:space:]]//g")
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision

      # ExportOptions.plist íŒŒì¼ ìƒì„±
      - name: Create ExportOptions.plist
        run: |
          cd ios
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>CUK22HY6YC</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.alom.romrom</key>
                  <string>RomRom Distribution</string>
              </dict>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Create GoogleService-Info.plist (safe heredoc)
        shell: bash
        run: |
          mkdir -p ios/Runner
          cat > ios/Runner/GoogleService-Info.plist << 'PLIST'
          ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
          PLIST
              echo "GoogleService-Info.plist created"
              /usr/bin/plutil -lint ios/Runner/GoogleService-Info.plist

      # Flutter build (no codesign) - í…ŒìŠ¤íŠ¸ ë²„ì „ 0.0.0 ì‚¬ìš©
      - name: Flutter build (no codesign)
        run: |
          flutter build ios --release --no-codesign \
            --build-name="0.0.0" \
            --build-number="${{ needs.prepare-test-build.outputs.build_number }}"

      # Archive ìƒì„± (manual signing)
      - name: Create Archive
        run: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -archivePath build/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            archive \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="RomRom Distribution" \
            CODE_SIGN_IDENTITY="Apple Distribution"

      # IPA ìƒì„±
      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist

      # ë¹Œë“œ ë©”íƒ€ë°ì´í„° íŒŒì¼ ìƒì„± (ëŒ“ê¸€ ì‘ì„± ì›Œí¬í”Œë¡œìš°ìš©)
      - name: Create build metadata file
        run: |
          cat > build-metadata.json << EOF
          {
            "pr_number": "${{ needs.prepare-test-build.outputs.pr_number }}",
            "build_number": "${{ needs.prepare-test-build.outputs.build_number }}",
            "issue_number": "${{ needs.prepare-test-build.outputs.issue_number }}",
            "branch_name": "${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          }
          EOF
          cat build-metadata.json

      # IPA íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: |
            ios/build/ipa/*.ipa
            build-metadata.json
          retention-days: 1

      # ì§„í–‰ìƒí™© - IPA ë¹Œë“œ ì™„ë£Œ
      - name: ì§„í–‰ìƒí™© - IPA ë¹Œë“œ ì™„ë£Œ
        id: progress_step2
        if: github.event_name == 'repository_dispatch' && needs.prepare-test-build.outputs.progress_comment_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ needs.prepare-test-build.outputs.progress_comment_id }}');
            const startTime = parseInt('${{ needs.prepare-test-build.outputs.progress_start_time }}');
            const step1Elapsed = '${{ needs.prepare-test-build.outputs.step1_elapsed }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const elapsed = Math.round((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const elapsedStr = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const body = [
              '## ğŸ iOS TestFlight ë¹Œë“œ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”§ ì¤€ë¹„ | âœ… ì™„ë£Œ | ${step1Elapsed} |`,
              `| ğŸ”¨ IPA ë¹Œë“œ | âœ… ì™„ë£Œ | ${elapsedStr} |`,
              '| ğŸ“¤ TestFlight ë°°í¬ | â³ ì§„í–‰ ì¤‘... | - |',
              '',
              `ğŸ“‹ **[ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            console.log(`âœ… ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸: IPA ë¹Œë“œ ì™„ë£Œ (${elapsedStr})`);
            core.setOutput('elapsed', elapsedStr);

  deploy-testflight-test:
    name: TestFlight í…ŒìŠ¤íŠ¸ ë°°í¬
    runs-on: macos-15
    needs: [prepare-test-build, build-ios-test]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      # App Store Connect API Key ì„¤ì •
      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      # IPA íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/ipa/

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      # Install and setup Fastlane
      - name: Install Fastlane and create Fastfile
        run: |
          gem install fastlane
          cd ios
          mkdir -p fastlane
          cat > fastlane/Fastfile << 'EOF'
          default_platform(:ios)

          platform :ios do
            lane :upload_testflight do
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                key_filepath: ENV["API_KEY_PATH"]
              )
          
              # ì—…ë¡œë“œ + ì•”í˜¸í™” ê·œì • ìë™ ì„¤ì •
              pilot(
                api_key: api_key,
                ipa: ENV["IPA_PATH"],
                changelog: ENV["RELEASE_NOTES"],
                skip_waiting_for_build_processing: true,  # ë¹ ë¥´ê²Œ ì—…ë¡œë“œë§Œ
                distribute_external: false,
                notify_external_testers: false,
                uses_non_exempt_encryption: false  # ì•”í˜¸í™” ê·œì • ìë™ ì„¤ì •
              )
          
              puts "âœ… TESTFLIGHT ìë™ ì—…ë¡œë“œ ì™„ë£Œ!"
            end
          end
          EOF

      # Upload to TestFlight with Fastlane
      - name: Upload to TestFlight with Fastlane
        run: |
          # ì ˆëŒ€ ê²½ë¡œë¡œ IPA íŒŒì¼ ì°¾ê¸°
          IPA_PATH=$(find $GITHUB_WORKSPACE/ios/build/ipa -name "*.ipa" | head -1)
          echo "Found IPA at: $IPA_PATH"

          if [ ! -f "$IPA_PATH" ]; then
            echo "âŒ IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "ë¹Œë“œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la ios/build/ipa/
            exit 1
          fi

          # Release notes ì¤€ë¹„
          if [ -f "final_release_notes.txt" ]; then
            RELEASE_NOTES=$(cat final_release_notes.txt)
            echo "Release Notes í¬í•¨í•˜ì—¬ ì—…ë¡œë“œ:"
            echo "$RELEASE_NOTES"
          else
            RELEASE_NOTES="í…ŒìŠ¤íŠ¸ ë¹Œë“œ #${{ needs.prepare-test-build.outputs.build_number }}"
            echo "ê¸°ë³¸ Release Notesë¡œ ì—…ë¡œë“œ: $RELEASE_NOTES"
          fi

          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export APP_STORE_CONNECT_API_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}"
          export APP_STORE_CONNECT_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
          export API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          export IPA_PATH="$IPA_PATH"
          export RELEASE_NOTES="$RELEASE_NOTES"

          # ë””ë²„ê¹… ì •ë³´
          echo "Working directory: $(pwd)"
          echo "IPA_PATH: $IPA_PATH"
          echo "API_KEY_PATH: $API_KEY_PATH"

          # Fastlane ì‹¤í–‰
          cd ios
          fastlane upload_testflight || echo "âš ï¸ ê¶Œí•œ ì—ëŸ¬ ë°œìƒí–ˆì§€ë§Œ ì—…ë¡œë“œëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë¨"

      # ì§„í–‰ìƒí™© - ë¹Œë“œ ì„±ê³µ (ìµœì¢…)
      - name: ì§„í–‰ìƒí™© - ë¹Œë“œ ì„±ê³µ (ìµœì¢…)
        if: success() && github.event_name == 'repository_dispatch' && needs.prepare-test-build.outputs.progress_comment_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ needs.prepare-test-build.outputs.progress_comment_id }}');
            const startTime = parseInt('${{ needs.prepare-test-build.outputs.progress_start_time }}');
            const prNumber = parseInt('${{ github.event.client_payload.pr_number }}');
            const buildNumber = '${{ needs.prepare-test-build.outputs.build_number }}';
            const branchName = '${{ needs.prepare-test-build.outputs.branch_name }}';
            const commitHash = '${{ needs.prepare-test-build.outputs.commit_hash }}';
            const issueNumber = '${{ needs.prepare-test-build.outputs.issue_number }}';
            const step1Elapsed = '${{ needs.prepare-test-build.outputs.step1_elapsed }}';
            const step2Elapsed = '${{ needs.build-ios-test.outputs.step2_elapsed }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const elapsed = Math.round((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const elapsedStr = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const body = [
              '## ğŸ âœ… iOS TestFlight ë¹Œë“œ ì™„ë£Œ!',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”§ ì¤€ë¹„ | âœ… ì™„ë£Œ | ${step1Elapsed || '-'} |`,
              `| ğŸ”¨ IPA ë¹Œë“œ | âœ… ì™„ë£Œ | ${step2Elapsed || '-'} |`,
              `| ğŸ“¤ TestFlight ë°°í¬ | âœ… ì™„ë£Œ | ${elapsedStr} |`,
              '',
              '### ğŸ“¦ ë¹Œë“œ ê²°ê³¼',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì•± ë²„ì „** | \`0.0.0(${buildNumber})\` |`,
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              `| **ì»¤ë°‹** | \`${commitHash}\` |`,
              `| **ì´ ì†Œìš” ì‹œê°„** | ${elapsedStr} |`,
              '',
              'ğŸ“± **TestFlightì—ì„œ í…ŒìŠ¤íŠ¸ ì•±ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**',
              `ğŸ”— **[ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸](${runUrl})**`
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            console.log(`âœ… ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸: ë¹Œë“œ ì„±ê³µ (ì´ ${elapsedStr})`);

            // PRê³¼ ì—°ê²°ëœ ì´ìŠˆê°€ ìˆê³ , PR ë²ˆí˜¸ì™€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì´ìŠˆì—ë„ ëŒ“ê¸€
            if (issueNumber && issueNumber !== '' && parseInt(issueNumber) !== prNumber) {
              const issueBody = [
                'ğŸ âœ… **iOS TestFlight ë¹Œë“œ ì™„ë£Œ**',
                '',
                `- ì•± ë²„ì „: \`0.0.0(${buildNumber})\``,
                `- ì»¤ë°‹: \`${commitHash}\``,
                '',
                'ğŸ“± **TestFlightì—ì„œ í…ŒìŠ¤íŠ¸ ì•±ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: issueBody
              });
              console.log(`âœ… ì´ìŠˆ #${issueNumber}ì—ë„ ë¹Œë“œ ì„±ê³µ ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ`);
            }

      # ì§„í–‰ìƒí™© - ë¹Œë“œ ì‹¤íŒ¨ (ìµœì¢…)
      - name: ì§„í–‰ìƒí™© - ë¹Œë“œ ì‹¤íŒ¨ (ìµœì¢…)
        if: failure() && github.event_name == 'repository_dispatch' && needs.prepare-test-build.outputs.progress_comment_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ needs.prepare-test-build.outputs.progress_comment_id }}');
            const startTime = parseInt('${{ needs.prepare-test-build.outputs.progress_start_time }}');
            const prNumber = parseInt('${{ github.event.client_payload.pr_number }}');
            const buildNumber = '${{ needs.prepare-test-build.outputs.build_number }}';
            const branchName = '${{ needs.prepare-test-build.outputs.branch_name }}';
            const issueNumber = '${{ needs.prepare-test-build.outputs.issue_number }}';
            const step1Elapsed = '${{ needs.prepare-test-build.outputs.step1_elapsed }}';
            const step2Elapsed = '${{ needs.build-ios-test.outputs.step2_elapsed }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const elapsed = Math.round((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const elapsedStr = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const body = [
              '## ğŸ âŒ iOS TestFlight ë¹Œë“œ ì‹¤íŒ¨',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”§ ì¤€ë¹„ | âœ… ì™„ë£Œ | ${step1Elapsed || '-'} |`,
              `| ğŸ”¨ IPA ë¹Œë“œ | ${step2Elapsed ? 'âœ… ì™„ë£Œ' : 'âŒ ì‹¤íŒ¨'} | ${step2Elapsed || elapsedStr} |`,
              `| ğŸ“¤ TestFlight ë°°í¬ | ${step2Elapsed ? 'âŒ ì‹¤íŒ¨' : 'â¸ï¸ ê±´ë„ˆëœ€'} | ${step2Elapsed ? elapsedStr : '-'} |`,
              '',
              `- ì•± ë²„ì „: \`0.0.0(${buildNumber})\``,
              `- ë¸Œëœì¹˜: \`${branchName}\``,
              '',
              'âŒ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
              '',
              `ğŸ”— **[ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸ í™•ì¸](${runUrl})**`
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            console.log(`âŒ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸: ë¹Œë“œ ì‹¤íŒ¨ (${elapsedStr})`);

            // PRê³¼ ì—°ê²°ëœ ì´ìŠˆê°€ ìˆê³ , PR ë²ˆí˜¸ì™€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì´ìŠˆì—ë„ ëŒ“ê¸€
            if (issueNumber && issueNumber !== '' && parseInt(issueNumber) !== prNumber) {
              const issueBody = [
                'ğŸ âŒ **iOS TestFlight ë¹Œë“œ ì‹¤íŒ¨**',
                '',
                `- ì•± ë²„ì „: \`0.0.0(${buildNumber})\``,
                '',
                'âŒ ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
                '',
                `ğŸ”— **[ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸ í™•ì¸](${runUrl})**`
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: issueBody
              });
              console.log(`âŒ ì´ìŠˆ #${issueNumber}ì—ë„ ë¹Œë“œ ì‹¤íŒ¨ ëŒ“ê¸€ ì‘ì„± ì™„ë£Œ`);
            }

      # ì½˜ì†” ì•Œë¦¼ (workflow_dispatchìš©)
      - name: Notify TestFlight Upload Success (Console)
        if: success()
        run: |
          echo "âœ… TestFlight í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì—…ë¡œë“œ ì„±ê³µ!"
          echo "ë²„ì „: 0.0.0"
          echo "ë¹Œë“œ ë²ˆí˜¸: ${{ needs.prepare-test-build.outputs.build_number }}"
          echo "ë¸Œëœì¹˜: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"

      - name: Notify on Failure (Console)
        if: failure()
        run: |
          echo "âŒ TestFlight í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì—…ë¡œë“œ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
