# ===================================================================
# iOS ÌÖåÏä§Ìä∏Ïö© TestFlight Î∞∞Ìè¨ ÏõåÌÅ¨ÌîåÎ°úÏö∞
# ===================================================================
#
# Ïù¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞Îäî test-deploy Î∏åÎûúÏπòÏóêÏÑú ÏàòÎèôÏúºÎ°ú Ïã§ÌñâÌïòÏó¨
# ÌÖåÏä§Ìä∏Ïö© iOS ÎπåÎìúÎ•º TestFlightÏóê Î∞∞Ìè¨Ìï©ÎãàÎã§.
#
# Ï£ºÏöî ÌäπÏßï:
# - workflow_dispatchÎ°ú ÏàòÎèô Ïã§ÌñâÎßå Í∞ÄÎä•
# - Î≤ÑÏ†ÑÏùÄ 0.0.0ÏúºÎ°ú Í≥†Ï†ï (Ïö¥ÏòÅ Î≤ÑÏ†ÑÍ≥º Î∂ÑÎ¶¨)
# - ÎπåÎìú Î≤àÌò∏Îäî GITHUB_RUN_NUMBER ÏÇ¨Ïö© (Ï†àÎåÄ Í≤πÏπòÏßÄ ÏïäÏùå)
# - Î∏åÎûúÏπòÎ™ÖÏóêÏÑú Ïù¥Ïäà Î≤àÌò∏ ÏûêÎèô Ï∂îÏ∂ú (YYYYMMDD_#Ïù¥ÏäàÎ≤àÌò∏_ÎÇ¥Ïö© ÌòïÏãù)
# - GitHub APIÎ°ú Ïù¥Ïäà Ï†ïÎ≥¥ Í∞ÄÏ†∏ÏôÄÏÑú Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏Ïóê Ìè¨Ìï®
# - CHANGELOG Î°úÏßÅ Ï†úÍ±∞, Îã®ÏàúÌôîÎêú Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ ÏÇ¨Ïö©
#
# Î∏åÎûúÏπòÎ™Ö ÏòàÏãú:
# - 20251208_#387_ÎÇ¥Ïö©
# - 20250115_#123_Î≤ÑÍ∑∏ÏàòÏ†ï
#
# ÏÇ¨Ïö© Î∞©Î≤ï:
# 1. test-deploy Î∏åÎûúÏπòÎ°ú Ï≤¥ÌÅ¨ÏïÑÏõÉ
# 2. GitHub ActionsÏóêÏÑú "ROMROM-IOS-TEST-TESTFLIGHT" ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÑ†ÌÉù
# 3. "Run workflow" Î≤ÑÌäº ÌÅ¥Î¶≠
#
# Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ ÌòïÏãù:
# ÌÖåÏä§Ìä∏ ÎπåÎìú #123
# Î∏åÎûúÏπò: 20251208_#387_ÎÇ¥Ïö©
# Ïª§Î∞ã: abc1234...
# ÎÇ†Ïßú: 2025-12-08 10:30:00
# Í¥ÄÎ†® Ïù¥Ïäà:
# - #387: [Ïù¥Ïäà Ï†úÎ™©]
# - URL: https://github.com/TEAM-ROMROM/RomRom-FE/issues/387
#
# ===================================================================

name: ROMROM-IOS-TEST-TESTFLIGHT

on:
  workflow_dispatch:
  repository_dispatch:
    types: [build-ios-app]

env:
  FLUTTER_VERSION: "3.35.5"
  XCODE_VERSION: "16.3"
  PROJECT_TYPE: "flutter"

jobs:
  prepare-test-build:
    name: ÌÖåÏä§Ìä∏ ÎπåÎìú Ï§ÄÎπÑ
    runs-on: macos-15

    outputs:
      version: ${{ steps.test_version.outputs.version }}
      build_number: ${{ steps.test_version.outputs.build_number }}
      issue_url: ${{ steps.issue_info.outputs.issue_url }}
      issue_title: ${{ steps.issue_info.outputs.issue_title }}
      issue_number: ${{ steps.issue_info.outputs.issue_number }}
      branch_name: ${{ steps.issue_info.outputs.branch_name }}
      pr_number: ${{ steps.test_version.outputs.pr_number }}
      commit_hash: ${{ steps.release_notes.outputs.commit_hash }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created"

      - name: Create Secrets.xcconfig file
        run: |
          mkdir -p ios/Flutter
          if [ -n "${{ secrets.SECRETS_XCCONFIG }}" ]; then
            echo "${{ secrets.SECRETS_XCCONFIG }}" > ios/Flutter/Secrets.xcconfig
            echo "Secrets.xcconfig created"
          else
            echo "// No secrets provided" > ios/Flutter/Secrets.xcconfig
          fi

      # ÌÖåÏä§Ìä∏ ÎπåÎìú Î≤ÑÏ†Ñ ÏÑ§Ï†ï (0.0.0 Í≥†Ï†ï)
      - name: ÌÖåÏä§Ìä∏ ÎπåÎìú Î≤ÑÏ†Ñ ÏÑ§Ï†ï
        id: test_version
        run: |
          echo "version=0.0.0" >> $GITHUB_OUTPUT
          
          # repository_dispatch Ïù¥Î≤§Ìä∏Ïù∏ Í≤ΩÏö∞ PR Î≤àÌò∏Î•º ÎπåÎìú Î≤àÌò∏Î°ú ÏÇ¨Ïö©
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BUILD_NUMBER="${{ github.event.client_payload.build_number }}"
            PR_NUMBER="${{ github.event.client_payload.pr_number }}"
            echo "üìã repository_dispatch Ïù¥Î≤§Ìä∏ Í∞êÏßÄ"
            echo "  PR Î≤àÌò∏: #$PR_NUMBER"
            echo "  ÎπåÎìú Î≤àÌò∏: $BUILD_NUMBER (PR Î≤àÌò∏ ÏÇ¨Ïö©)"
          else
            BUILD_NUMBER="${{ github.run_number }}"
            PR_NUMBER=""
            echo "üìã workflow_dispatch Ïù¥Î≤§Ìä∏ Í∞êÏßÄ"
            echo "  ÎπåÎìú Î≤àÌò∏: $BUILD_NUMBER (Í∏∞Î≥∏Í∞í)"
          fi
          
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "üìã ÌÖåÏä§Ìä∏ ÎπåÎìú: Î≤ÑÏ†Ñ=0.0.0, ÎπåÎìúÎ≤àÌò∏=$BUILD_NUMBER"

      # Î∏åÎûúÏπòÎ™ÖÏóêÏÑú Ïù¥Ïäà Î≤àÌò∏ Ï∂îÏ∂ú Î∞è GitHub APIÎ°ú Ïù¥Ïäà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      - name: Î∏åÎûúÏπòÎ™ÖÏóêÏÑú Ïù¥Ïäà Ï†ïÎ≥¥ Ï∂îÏ∂ú
        id: issue_info
        run: |
          # repository_dispatchÏù∏ Í≤ΩÏö∞ client_payloadÏóêÏÑú Î∏åÎûúÏπòÎ™Ö Í∞ÄÏ†∏Ïò§Í∏∞
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BRANCH_NAME="${{ github.event.client_payload.branch_name }}"
            ISSUE_NUMBER="${{ github.event.client_payload.issue_number }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
            # Î∏åÎûúÏπòÎ™ÖÏóêÏÑú Ïù¥Ïäà Î≤àÌò∏ Ï∂îÏ∂ú (#387 ÌòïÏãù) - sed ÏÇ¨Ïö© (macOS/Linux Ìò∏Ìôò)
            ISSUE_NUMBER=$(echo "$BRANCH_NAME" | sed -n 's/.*#\([0-9]*\).*/\1/p')
          fi

          echo "üåø Î∏åÎûúÏπòÎ™Ö: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ö†Ô∏è Î∏åÎûúÏπòÎ™ÖÏóêÏÑú Ïù¥Ïäà Î≤àÌò∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
            echo "issue_url=" >> $GITHUB_OUTPUT
            echo "issue_title=" >> $GITHUB_OUTPUT
            echo "issue_number=" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Ï∂îÏ∂úÎêú Ïù¥Ïäà Î≤àÌò∏: #$ISSUE_NUMBER"
            ISSUE_URL="https://github.com/${{ github.repository }}/issues/$ISSUE_NUMBER"
            echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

            # GitHub APIÎ°ú Ïù¥Ïäà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            echo "üîç GitHub APIÎ°ú Ïù¥Ïäà Ï†ïÎ≥¥ Ï°∞Ìöå Ï§ë..."
            ISSUE_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")

            # Ïù¥Ïäà Ï†úÎ™© Ï∂îÏ∂ú
            ISSUE_TITLE=$(echo "$ISSUE_RESPONSE" | jq -r '.title // "Ïù¥Ïäà Ï†ïÎ≥¥ ÏóÜÏùå"')

            # Ïù¥Ïäà ÏÉÅÌÉú ÌôïÏù∏
            ISSUE_STATE=$(echo "$ISSUE_RESPONSE" | jq -r '.state // "unknown"')

            if [ "$ISSUE_TITLE" = "null" ] || [ "$ISSUE_TITLE" = "Ïù¥Ïäà Ï†ïÎ≥¥ ÏóÜÏùå" ]; then
              echo "‚ö†Ô∏è Ïù¥Ïäà #$ISSUE_NUMBERÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
              echo "issue_title=" >> $GITHUB_OUTPUT
            else
              echo "üìã Ïù¥Ïäà Ï†úÎ™©: $ISSUE_TITLE"
              echo "üìå Ïù¥Ïäà ÏÉÅÌÉú: $ISSUE_STATE"
              echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
            fi
          fi

      # Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ ÏÉùÏÑ±
      - name: Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ ÏÉùÏÑ±
        id: release_notes
        run: |
          BUILD_NUMBER="${{ steps.test_version.outputs.build_number }}"
          BRANCH_NAME="${{ steps.issue_info.outputs.branch_name }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')

          # commit_hash output Ï†ÄÏû•
          echo "commit_hash=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          
          # Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ ÏÉùÏÑ±
          cat > final_release_notes.txt << EOF
          ÌÖåÏä§Ìä∏ ÎπåÎìú #$BUILD_NUMBER
          
          Î∏åÎûúÏπò: $BRANCH_NAME
          Ïª§Î∞ã: $COMMIT_SHORT
          ÎÇ†Ïßú: $BUILD_DATE
          
          EOF
          
          # Ïù¥Ïäà Ï†ïÎ≥¥Í∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
          if [ -n "${{ steps.issue_info.outputs.issue_number }}" ]; then
            ISSUE_NUMBER="${{ steps.issue_info.outputs.issue_number }}"
            ISSUE_TITLE="${{ steps.issue_info.outputs.issue_title }}"
            ISSUE_URL="${{ steps.issue_info.outputs.issue_url }}"
            
            cat >> final_release_notes.txt << EOF
          Í¥ÄÎ†® Ïù¥Ïäà:
          - #$ISSUE_NUMBER: $ISSUE_TITLE
          - URL: $ISSUE_URL
          
          EOF
          fi
          
          echo "üìã ÏÉùÏÑ±Îêú Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏:"
          echo "----------------------------------------"
          cat final_release_notes.txt
          echo "----------------------------------------"

      # Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏Î•º ÏïÑÌã∞Ìå©Ìä∏Î°ú ÏóÖÎ°úÎìú
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: final_release_notes.txt
          retention-days: 1

      # ÌîÑÎ°úÏ†ùÌä∏ ÌååÏùºÎì§ÏùÑ ÏïÑÌã∞Ìå©Ìä∏Î°ú ÏóÖÎ°úÎìú
      - name: Upload project files
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: |
            .env
            ios/Flutter/Secrets.xcconfig
            pubspec.yaml
            lib/
            assets/
          retention-days: 1

  build-ios-test:
    name: iOS ÌÖåÏä§Ìä∏ ÎπåÎìú
    runs-on: macos-15
    needs: prepare-test-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      # ÌîÑÎ°úÏ†ùÌä∏ ÌååÏùºÎì§ Îã§Ïö¥Î°úÎìú
      - name: Download project files
        uses: actions/download-artifact@v4
        with:
          name: project-files
          path: .

      # .env ÌååÏùº ÌôïÏù∏ Î∞è Ïû¨ÏÉùÏÑ±
      - name: Ensure .env file exists
        run: |
          if [ ! -f .env ]; then
            echo "‚ö†Ô∏è .env ÌååÏùºÏù¥ ÏïÑÌã∞Ìå©Ìä∏ÏóêÏÑú Î≥µÏõêÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû¨ÏÉùÏÑ±Ìï©ÎãàÎã§."
            echo "${{ secrets.ENV_FILE }}" > .env
          fi
          echo "‚úÖ .env ÌååÏùº ÌôïÏù∏Îê® (ÌÅ¨Í∏∞: $(wc -c < .env) bytes)"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install

      # Apple Ïù∏Ï¶ùÏÑú ÏÑ§Ï†ï
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profile
        run: |
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          uuid=$(grep -A1 -a "UUID" profile.mobileprovision | grep string | sed -e "s/<string>//" -e "s/<\/string>//" -e "s/[[:space:]]//g")
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision

      # ExportOptions.plist ÌååÏùº ÏÉùÏÑ±
      - name: Create ExportOptions.plist
        run: |
          cd ios
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>CUK22HY6YC</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.alom.romrom</key>
                  <string>RomRom Distribution</string>
              </dict>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Apple Distribution</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Create GoogleService-Info.plist (safe heredoc)
        shell: bash
        run: |
          mkdir -p ios/Runner
          cat > ios/Runner/GoogleService-Info.plist << 'PLIST'
          ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
          PLIST
              echo "GoogleService-Info.plist created"
              /usr/bin/plutil -lint ios/Runner/GoogleService-Info.plist

      # Flutter build (no codesign) - ÌÖåÏä§Ìä∏ Î≤ÑÏ†Ñ 0.0.0 ÏÇ¨Ïö©
      - name: Flutter build (no codesign)
        run: |
          flutter build ios --release --no-codesign \
            --build-name="0.0.0" \
            --build-number="${{ needs.prepare-test-build.outputs.build_number }}"

      # Archive ÏÉùÏÑ± (manual signing)
      - name: Create Archive
        run: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -archivePath build/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            archive \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="RomRom Distribution" \
            CODE_SIGN_IDENTITY="Apple Distribution"

      # IPA ÏÉùÏÑ±
      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist

      # ÎπåÎìú Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÌååÏùº ÏÉùÏÑ± (ÎåìÍ∏Ä ÏûëÏÑ± ÏõåÌÅ¨ÌîåÎ°úÏö∞Ïö©)
      - name: Create build metadata file
        run: |
          cat > build-metadata.json << EOF
          {
            "pr_number": "${{ needs.prepare-test-build.outputs.pr_number }}",
            "build_number": "${{ needs.prepare-test-build.outputs.build_number }}",
            "issue_number": "${{ needs.prepare-test-build.outputs.issue_number }}",
            "branch_name": "${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          }
          EOF
          cat build-metadata.json

      # IPA ÌååÏùºÏùÑ ÏïÑÌã∞Ìå©Ìä∏Î°ú ÏóÖÎ°úÎìú
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: |
            ios/build/ipa/*.ipa
            build-metadata.json
          retention-days: 1

  deploy-testflight-test:
    name: TestFlight ÌÖåÏä§Ìä∏ Î∞∞Ìè¨
    runs-on: macos-15
    needs: [prepare-test-build, build-ios-test]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      # App Store Connect API Key ÏÑ§Ï†ï
      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      # IPA ÌååÏùº Îã§Ïö¥Î°úÎìú
      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/ipa/

      # Î¶¥Î¶¨Ï¶à ÎÖ∏Ìä∏ Îã§Ïö¥Î°úÎìú
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      # Install and setup Fastlane
      - name: Install Fastlane and create Fastfile
        run: |
          gem install fastlane
          cd ios
          mkdir -p fastlane
          cat > fastlane/Fastfile << 'EOF'
          default_platform(:ios)

          platform :ios do
            lane :upload_testflight do
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                key_filepath: ENV["API_KEY_PATH"]
              )
          
              # ÏóÖÎ°úÎìú + ÏïîÌò∏Ìôî Í∑úÏ†ï ÏûêÎèô ÏÑ§Ï†ï
              pilot(
                api_key: api_key,
                ipa: ENV["IPA_PATH"],
                changelog: ENV["RELEASE_NOTES"],
                skip_waiting_for_build_processing: true,  # Îπ†Î•¥Í≤å ÏóÖÎ°úÎìúÎßå
                distribute_external: false,
                notify_external_testers: false,
                uses_non_exempt_encryption: false  # ÏïîÌò∏Ìôî Í∑úÏ†ï ÏûêÎèô ÏÑ§Ï†ï
              )
          
              puts "‚úÖ TESTFLIGHT ÏûêÎèô ÏóÖÎ°úÎìú ÏôÑÎ£å!"
            end
          end
          EOF

      # Upload to TestFlight with Fastlane
      - name: Upload to TestFlight with Fastlane
        run: |
          # Ï†àÎåÄ Í≤ΩÎ°úÎ°ú IPA ÌååÏùº Ï∞æÍ∏∞
          IPA_PATH=$(find $GITHUB_WORKSPACE/ios/build/ipa -name "*.ipa" | head -1)
          echo "Found IPA at: $IPA_PATH"

          if [ ! -f "$IPA_PATH" ]; then
            echo "‚ùå IPA ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!"
            echo "ÎπåÎìú ÎîîÎ†âÌÜ†Î¶¨ ÎÇ¥Ïö©:"
            ls -la ios/build/ipa/
            exit 1
          fi

          # Release notes Ï§ÄÎπÑ
          if [ -f "final_release_notes.txt" ]; then
            RELEASE_NOTES=$(cat final_release_notes.txt)
            echo "Release Notes Ìè¨Ìï®ÌïòÏó¨ ÏóÖÎ°úÎìú:"
            echo "$RELEASE_NOTES"
          else
            RELEASE_NOTES="ÌÖåÏä§Ìä∏ ÎπåÎìú #${{ needs.prepare-test-build.outputs.build_number }}"
            echo "Í∏∞Î≥∏ Release NotesÎ°ú ÏóÖÎ°úÎìú: $RELEASE_NOTES"
          fi

          # ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï
          export APP_STORE_CONNECT_API_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}"
          export APP_STORE_CONNECT_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
          export API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          export IPA_PATH="$IPA_PATH"
          export RELEASE_NOTES="$RELEASE_NOTES"

          # ÎîîÎ≤ÑÍπÖ Ï†ïÎ≥¥
          echo "Working directory: $(pwd)"
          echo "IPA_PATH: $IPA_PATH"
          echo "API_KEY_PATH: $API_KEY_PATH"

          # Fastlane Ïã§Ìñâ
          cd ios
          fastlane upload_testflight || echo "‚ö†Ô∏è Í∂åÌïú ÏóêÎü¨ Î∞úÏÉùÌñàÏßÄÎßå ÏóÖÎ°úÎìúÎäî ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎê®"

      # ÏÑ±Í≥µ ÏïåÎ¶º
      - name: Notify TestFlight Upload Success
        if: success()
        run: |
          echo "‚úÖ TestFlight ÌÖåÏä§Ìä∏ ÎπåÎìú ÏóÖÎ°úÎìú ÏÑ±Í≥µ!"
          echo "Î≤ÑÏ†Ñ: 0.0.0"
          echo "ÎπåÎìú Î≤àÌò∏: ${{ needs.prepare-test-build.outputs.build_number }}"
          if [ -n "${{ needs.prepare-test-build.outputs.pr_number }}" ]; then
            echo "PR Î≤àÌò∏: ${{ needs.prepare-test-build.outputs.pr_number }}"
          fi
          echo "Î∏åÎûúÏπò: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          echo "Ïª§Î∞ã: ${{ github.sha }}"
          if [ -n "${{ needs.prepare-test-build.outputs.issue_url }}" ]; then
            echo "Í¥ÄÎ†® Ïù¥Ïäà: ${{ needs.prepare-test-build.outputs.issue_url }}"
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå TestFlight ÌÖåÏä§Ìä∏ ÎπåÎìú ÏóÖÎ°úÎìú Ïã§Ìå®!"
          echo "Î°úÍ∑∏Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî."

      # PRÏóê ÎπåÎìú ÏôÑÎ£å ÎåìÍ∏Ä ÏûëÏÑ± (repository_dispatchÎ°ú Ìä∏Î¶¨Í±∞Îêú Í≤ΩÏö∞)
      - name: PRÏóê ÎπåÎìú ÏÑ±Í≥µ ÎåìÍ∏Ä ÏûëÏÑ±
        if: success() && github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ github.event.client_payload.pr_number }}');
            const buildNumber = '${{ needs.prepare-test-build.outputs.build_number }}';
            const commitHash = '${{ needs.prepare-test-build.outputs.commit_hash }}';
            const branchName = '${{ needs.prepare-test-build.outputs.branch_name }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const body = `üçé ‚úÖ **iOS TestFlight ÎπåÎìú ÏôÑÎ£å**

- Ïï± Î≤ÑÏ†Ñ: \`0.0.0\`
- ÎπåÎìú Î≤àÌò∏: **#${buildNumber}**
- Î∏åÎûúÏπò: \`${branchName}\`
- Ïª§Î∞ã: \`${commitHash}\`

üì± **TestFlightÏóêÏÑú ÌÖåÏä§Ìä∏ Ïï±ÏùÑ Îã§Ïö¥Î°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.**

üîó [ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ Î°úÍ∑∏](${runUrl})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`‚úÖ PR #${prNumber}Ïóê ÎπåÎìú ÏÑ±Í≥µ ÎåìÍ∏Ä ÏûëÏÑ± ÏôÑÎ£å`);

      - name: PRÏóê ÎπåÎìú Ïã§Ìå® ÎåìÍ∏Ä ÏûëÏÑ±
        if: failure() && github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ github.event.client_payload.pr_number }}');
            const buildNumber = '${{ needs.prepare-test-build.outputs.build_number }}';
            const branchName = '${{ needs.prepare-test-build.outputs.branch_name }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const body = `üçé ‚ùå **iOS TestFlight ÎπåÎìú Ïã§Ìå®**

- ÎπåÎìú Î≤àÌò∏: **#${buildNumber}**
- Î∏åÎûúÏπò: \`${branchName}\`

‚ùå ÎπåÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.

üîó [ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ Î°úÍ∑∏ ÌôïÏù∏](${runUrl})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`‚úÖ PR #${prNumber}Ïóê ÎπåÎìú Ïã§Ìå® ÎåìÍ∏Ä ÏûëÏÑ± ÏôÑÎ£å`);

      # Ïù¥ÏäàÏóê ÎπåÎìú ÏôÑÎ£å ÎåìÍ∏Ä ÏûëÏÑ±
      - name: Ïù¥ÏäàÏóê ÎπåÎìú ÏÑ±Í≥µ ÎåìÍ∏Ä ÏûëÏÑ±
        if: success() && needs.prepare-test-build.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ needs.prepare-test-build.outputs.issue_number }}');
            const buildNumber = '${{ needs.prepare-test-build.outputs.build_number }}';
            const commitHash = '${{ needs.prepare-test-build.outputs.commit_hash }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const body = `üçé ‚úÖ **iOS TestFlight ÎπåÎìú ÏôÑÎ£å**

- Ïï± Î≤ÑÏ†Ñ: \`0.0.0\`
- ÎπåÎìú Î≤àÌò∏: **#${buildNumber}**
- Ïª§Î∞ã: \`${commitHash}\`

üì± **TestFlightÏóêÏÑú ÌÖåÏä§Ìä∏ Ïï±ÏùÑ Îã§Ïö¥Î°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.**`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

            console.log(`‚úÖ Ïù¥Ïäà #${issueNumber}Ïóê ÎπåÎìú ÏÑ±Í≥µ ÎåìÍ∏Ä ÏûëÏÑ± ÏôÑÎ£å`);
