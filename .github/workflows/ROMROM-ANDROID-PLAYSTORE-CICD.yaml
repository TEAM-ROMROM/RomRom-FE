name: Android-PlayStore-Internal-Deploy

on:
  push:
    branches: ["deploy"]
  workflow_run:
    workflows: ["CHANGELOG ìë™ ì—…ë°ì´íŠ¸"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.27.3"
  JAVA_VERSION: "17"
  PROJECT_TYPE: "flutter"

jobs:
  prepare-build:
    name: í™˜ê²½ ì„¤ì • ë° ì¤€ë¹„
    runs-on: ubuntu-latest
    # CHANGELOG ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}

    outputs:
      version: ${{ steps.current_version.outputs.version }}
      version_code: ${{ steps.current_version.outputs.version_code }}
      project_type: ${{ steps.current_version.outputs.project_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      # ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
      - name: ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          chmod +x ./.github/scripts/version_manager.sh
          chmod +x ./.github/scripts/changelog_manager.py

      # version_manager.shë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: í˜„ì¬ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: current_version
        run: |
          # ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          VERSION=$(./.github/scripts/version_manager.sh get | tail -n 1)
          echo "ğŸ“‹ ë²„ì „ ì •ë³´: $VERSION"

          # Flutter ë²„ì „ì´ x.x.x+y í˜•ì‹ì¸ì§€ í™•ì¸
          if [[ "$VERSION" == *"+"* ]]; then
            # ê¸°ì¡´ x.x.x+y í˜•ì‹ì—ì„œ ë¹Œë“œ ë²ˆí˜¸ ì¶”ì¶œ
            VERSION_NAME=$(echo "$VERSION" | cut -d'+' -f1)
            VERSION_CODE=$(echo "$VERSION" | cut -d'+' -f2)
            echo "ğŸ“‹ ê¸°ì¡´ í˜•ì‹ ê°ì§€: ë²„ì „=$VERSION_NAME, ë¹Œë“œì½”ë“œ=$VERSION_CODE"
          else
            # x.x.x í˜•ì‹ì—ì„œëŠ” ë³„ë„ ë¹Œë“œ ì½”ë“œ ì‚¬ìš©
            VERSION_NAME=$VERSION
          
            # Android ë¹Œë“œë¥¼ ìœ„í•œ ë²„ì „ ì½”ë“œ ìƒì„± (CI í™˜ê²½ì—ì„œëŠ” GITHUB_RUN_NUMBER í™œìš©)
            if [ -n "$GITHUB_RUN_NUMBER" ]; then
              VERSION_CODE=$GITHUB_RUN_NUMBER
            else
              # CI í™˜ê²½ì´ ì•„ë‹Œ ê²½ìš° íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ëŒ€ì²´
              VERSION_CODE=$(date +%s | tail -c 6)
            fi
          fi

          # ê²°ê³¼ ì¶œë ¥
          echo "version=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "project_type=${{ env.PROJECT_TYPE }}" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ í˜„ì¬ ë²„ì „: $VERSION_NAME (ë²„ì „ì½”ë“œ: $VERSION_CODE)"
          echo "ğŸ”§ í”„ë¡œì íŠ¸ íƒ€ì…: ${{ env.PROJECT_TYPE }}"

          # í™˜ê²½ë³€ìˆ˜ë¡œë„ ì„¤ì • (ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©)
          echo "VERSION=$VERSION_NAME" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "PROJECT_TYPE=${{ env.PROJECT_TYPE }}" >> $GITHUB_ENV

      # CHANGELOG.jsonì—ì„œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ - changelog_manager.py ì‚¬ìš©
      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: release_notes
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"

          if [ -f "CHANGELOG.json" ]; then
            echo "ğŸ“„ CHANGELOG.jsonì—ì„œ v$VERSION ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì¤‘..."
            # CHANGELOG.md ìƒì„±
            python3 ./.github/scripts/changelog_manager.py generate-md

            # changelog_manager.py exportë¡œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ
            python3 ./.github/scripts/changelog_manager.py export --version $VERSION --output final_release_notes.txt

            if [ -s final_release_notes.txt ]; then
              echo "âœ… ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì„±ê³µ!"
              echo "ğŸ“‹ ì¶”ì¶œëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸:"
              echo "----------------------------------------"
              cat final_release_notes.txt
              echo "----------------------------------------"
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "âŒ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
            fi
          else
            echo "âš ï¸ CHANGELOG.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
            echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
            echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
          fi

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: final_release_notes.txt
          retention-days: 1

      # í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload project files
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: |
            .env
            pubspec.yaml
            lib/
            assets/
          retention-days: 1

  build-android:
    name: Android AAB ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: prepare-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      # í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ ë‹¤ìš´ë¡œë“œ
      - name: Download project files
        uses: actions/download-artifact@v4
        with:
          name: project-files
          path: .

      # .env íŒŒì¼ í™•ì¸ ë° ì¬ìƒì„± (ë³µêµ¬ ë¡œì§)
      - name: Ensure .env file exists
        run: |
          if [ ! -f .env ]; then
            echo "âš ï¸ .env íŒŒì¼ì´ ì•„í‹°íŒ©íŠ¸ì—ì„œ ë³µì›ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¬ìƒì„±í•©ë‹ˆë‹¤."
            echo "${{ secrets.ENV_FILE }}" > .env
          fi
          echo "âœ… .env íŒŒì¼ í™•ì¸ë¨ (í¬ê¸°: $(wc -c < .env) bytes)"

      # Release Keystore ì„¤ì •
      - name: Setup Release Keystore
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore/key.jks
          echo "âœ… Release Keystore ìƒì„± ì™„ë£Œ"
          ls -la android/app/keystore/

      # key.properties ìƒì„± (Release ì„œëª… ì •ë³´)
      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storeFile=keystore/key.jks
          storePassword=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.RELEASE_KEY_ALIAS }}
          keyPassword=${{ secrets.RELEASE_KEY_PASSWORD }}
          EOF
          echo "âœ… key.properties ìƒì„± ì™„ë£Œ"
          cat android/key.properties

      # Google-services.json ìƒì„±
      - name: Create Google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > android/app/google-services.json
          echo "âœ… Google-services.json ìƒì„± ì™„ë£Œ"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Android build.gradle.kts ìˆ˜ì • (release ì„œëª… ì„¤ì •)
      - name: Configure Android build for release
        run: |
          # build.gradle.ktsì— release ì„œëª… ì„¤ì •ì´ ì—†ìœ¼ë©´ ì¶”ê°€
          if ! grep -q "signingConfigs" android/app/build.gradle.kts; then
            echo "âš ï¸ build.gradle.ktsì— ì„œëª… ì„¤ì • ì¶”ê°€ í•„ìš”"
            # ì„œëª… ì„¤ì •ì€ ì´ë¯¸ ë˜ì–´ìˆë‹¤ê³  ê°€ì • (ìˆ˜ë™ìœ¼ë¡œ ë¯¸ë¦¬ ì„¤ì •í•´ì•¼ í•¨)
          fi
          echo "âœ… Android ë¹Œë“œ ì„¤ì • í™•ì¸ ì™„ë£Œ"

      # pubspec.yaml ë²„ì „ ì—…ë°ì´íŠ¸ (ë²„ì „ì •ë³´+ëŸ°íƒ€ì„ë²ˆí˜¸ ë¡œ ìˆ˜ì •í•˜ì—¬ ë¹Œë“œ)
      - name: Update pubspec.yaml version
        run: |
          VERSION_NAME="${{ needs.prepare-build.outputs.version }}"
          VERSION_CODE="${{ needs.prepare-build.outputs.version_code }}"
          
          echo "======================================"
          echo "ğŸ“ pubspec.yaml ë²„ì „ ì—…ë°ì´íŠ¸ ì‹œì‘"
          echo "======================================"
          echo "ëª©í‘œ ë²„ì „: ${VERSION_NAME}+${VERSION_CODE}"
          echo "VERSION_NAME: $VERSION_NAME"
          echo "VERSION_CODE: $VERSION_CODE"
          
          echo "ğŸ” ìˆ˜ì • ì „ pubspec.yaml:"
          grep "^version:" pubspec.yaml || echo "version í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
          
          # pubspec.yamlì˜ version í•„ë“œ ì—…ë°ì´íŠ¸ (ë” ì•ˆì „í•œ ë°©ë²•)
          cp pubspec.yaml pubspec.yaml.bak
          
          # sedë¥¼ ì‚¬ìš©í•œ ë” ì§ì ‘ì ì¸ ë°©ë²•ìœ¼ë¡œ ë³€ê²½
          sed -i.tmp "s/^version:.*/version: ${VERSION_NAME}+${VERSION_CODE}/" pubspec.yaml
          
          echo "âœ… ìˆ˜ì • í›„ pubspec.yaml:"
          grep "^version:" pubspec.yaml
          
          # ìˆ˜ì •ì´ ì œëŒ€ë¡œ ë˜ì—ˆëŠ”ì§€ ê²€ì¦
          UPDATED_VERSION=$(grep "^version:" pubspec.yaml | cut -d' ' -f2)
          EXPECTED_VERSION="${VERSION_NAME}+${VERSION_CODE}"
          
          echo "ğŸ” ë²„ì „ ê²€ì¦:"
          echo "  ì˜ˆìƒ: $EXPECTED_VERSION"
          echo "  ì‹¤ì œ: $UPDATED_VERSION"
          
          if [ "$UPDATED_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: pubspec.yaml ë²„ì „ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!"
            echo "ìˆ˜ë™ìœ¼ë¡œ ë‹¤ì‹œ ì‹œë„..."
            
            # ìˆ˜ë™ìœ¼ë¡œ íŒŒì¼ ì¬ì‘ì„±
            awk -v new_version="${VERSION_NAME}+${VERSION_CODE}" '
            /^version:/ {print "version: " new_version; next} 
            {print}
            ' pubspec.yaml.bak > pubspec.yaml.new
            mv pubspec.yaml.new pubspec.yaml
            
            echo "ğŸ”„ ì¬ì‹œë„ í›„ ë²„ì „:"
            grep "^version:" pubspec.yaml
            
            RETRY_VERSION=$(grep "^version:" pubspec.yaml | cut -d' ' -f2)
            if [ "$RETRY_VERSION" != "$EXPECTED_VERSION" ]; then
              echo "âŒ ì¬ì‹œë„ë„ ì‹¤íŒ¨! ë¹Œë“œ ì¤‘ë‹¨"
              exit 1
            fi
          fi
          
          echo "âœ… pubspec.yaml ë²„ì „ ì—…ë°ì´íŠ¸ ì„±ê³µ!"
          
          # Flutter ì˜ì¡´ì„± ì¬ì„¤ì¹˜
          echo "ğŸ”„ Flutter ì˜ì¡´ì„± ì¬ì„¤ì¹˜..."
          flutter pub get
          flutter analyze --no-fatal-infos || echo "ë¶„ì„ ê²½ê³  ë¬´ì‹œ"
          
          echo "======================================"

      # Flutter build appbundle (AAB ìƒì„±)
      - name: Build Android App Bundle (AAB)
        run: |
          VERSION_NAME="${{ needs.prepare-build.outputs.version }}"
          VERSION_CODE="${{ needs.prepare-build.outputs.version_code }}"
          
          echo "======================================"
          echo "ğŸš€ AAB ë¹Œë“œ ì‹œì‘"
          echo "======================================"
          echo "ë¹Œë“œ ë²„ì „: $VERSION_NAME"
          echo "ë¹Œë“œ ì½”ë“œ: $VERSION_CODE"
          
          # Flutter build ëª…ë ¹ì–´ì— ëª…ì‹œì ìœ¼ë¡œ ë²„ì „ ì •ë³´ ì „ë‹¬
          echo "ğŸ”¨ Flutter build ì‹¤í–‰ (ëª…ì‹œì  ë²„ì „ ì§€ì •)..."
          flutter build appbundle \
            --release \
            --build-name="$VERSION_NAME" \
            --build-number="$VERSION_CODE" \
            --verbose
          
          echo "âœ… AAB ë¹Œë“œ ì™„ë£Œ"
          ls -lh build/app/outputs/bundle/release/
          
          # AAB íŒŒì¼ ì¡´ì¬ í™•ì¸
          AAB_FILE="build/app/outputs/bundle/release/app-release.aab"
          if [ ! -f "$AAB_FILE" ]; then
            echo "âŒ AAB íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "ë¹Œë“œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            find build/ -name "*.aab" -o -name "*.apk" 2>/dev/null || echo "AAB/APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          echo "ğŸ“± AAB íŒŒì¼ í¬ê¸°: $(du -h "$AAB_FILE" | cut -f1)"
          
          # bundletool ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
          echo "ğŸ“¦ bundletool ë‹¤ìš´ë¡œë“œ ì¤‘..."
          BUNDLETOOL_VERSION="1.15.6"
          wget -q "https://github.com/google/bundletool/releases/download/${BUNDLETOOL_VERSION}/bundletool-all-${BUNDLETOOL_VERSION}.jar" -O bundletool.jar
          
          if [ ! -f "bundletool.jar" ]; then
            echo "âŒ bundletool ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          fi
          
          echo "âœ… bundletool ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          
          # AAB íŒŒì¼ ë‚´ë¶€ì˜ ì‹¤ì œ ë²„ì „ ì •ë³´ í™•ì¸ (ì¤‘ìš”!)
          echo "======================================"
          echo "ğŸ” AAB íŒŒì¼ ë‚´ë¶€ ë²„ì „ ì •ë³´ ê²€ì¦"
          echo "======================================"
          
          # AndroidManifest.xmlì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
          echo "ğŸ“‹ AABì—ì„œ ì‹¤ì œ ë²„ì „ ì •ë³´ ì¶”ì¶œ ì¤‘..."
          MANIFEST_OUTPUT=$(java -jar bundletool.jar dump manifest --bundle="$AAB_FILE" 2>/dev/null)
          
          if [ $? -eq 0 ]; then
            echo "âœ… Manifest ì¶”ì¶œ ì„±ê³µ"
            
            # ì‹¤ì œ ë²„ì „ ì½”ë“œì™€ ë²„ì „ ì´ë¦„ ì¶”ì¶œ
            ACTUAL_VERSION_CODE=$(echo "$MANIFEST_OUTPUT" | grep -o 'android:versionCode="[0-9]*"' | grep -o '[0-9]*' | head -1)
            ACTUAL_VERSION_NAME=$(echo "$MANIFEST_OUTPUT" | grep -o 'android:versionName="[^"]*"' | sed 's/android:versionName="//;s/"//' | head -1)
            
            echo "ğŸ¯ ë²„ì „ ì •ë³´ ë¹„êµ:"
            echo "  ì˜ˆìƒ VERSION_CODE: $VERSION_CODE"
            echo "  ì‹¤ì œ VERSION_CODE: $ACTUAL_VERSION_CODE"
            echo "  ì˜ˆìƒ VERSION_NAME: $VERSION_NAME"
            echo "  ì‹¤ì œ VERSION_NAME: $ACTUAL_VERSION_NAME"
            
            # ë²„ì „ ì½”ë“œ ê²€ì¦ (ê°€ì¥ ì¤‘ìš”!)
            if [ "$ACTUAL_VERSION_CODE" != "$VERSION_CODE" ]; then
              echo "âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: AABì˜ VERSION_CODEê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤!"
              echo "   ì´ëŠ” Google Playì—ì„œ 'ì´ë¯¸ ì‚¬ìš©ëœ ë²„ì „ ì½”ë“œ' ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤."
              echo "   pubspec.yaml ìˆ˜ì •ì´ë‚˜ Flutter build ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              echo ""
              echo "ğŸ” ë””ë²„ê¹… ì •ë³´:"
              echo "   í˜„ì¬ pubspec.yaml ë²„ì „:"
              grep "^version:" pubspec.yaml || echo "   version í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
              echo ""
              echo "   ì „ì²´ Manifest ë‚´ìš©:"
              echo "$MANIFEST_OUTPUT" | grep -E "versionCode|versionName|package"
              exit 1
            else
              echo "âœ… VERSION_CODE ê²€ì¦ ì„±ê³µ: $ACTUAL_VERSION_CODE"
            fi
            
            # ë²„ì „ ì´ë¦„ë„ í™•ì¸ (ê²½ê³ ë§Œ)
            if [ "$ACTUAL_VERSION_NAME" != "$VERSION_NAME" ]; then
              echo "âš ï¸ ê²½ê³ : VERSION_NAMEì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤ (ì¹˜ëª…ì ì´ì§€ ì•ŠìŒ)"
              echo "   ì˜ˆìƒ: $VERSION_NAME, ì‹¤ì œ: $ACTUAL_VERSION_NAME"
            else
              echo "âœ… VERSION_NAME ê²€ì¦ ì„±ê³µ: $ACTUAL_VERSION_NAME"
            fi
            
          else
            echo "âŒ bundletoolë¡œ Manifest ì¶”ì¶œ ì‹¤íŒ¨"
            echo "ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ê²€ì¦ ì‹œë„..."
            
            # unzipìœ¼ë¡œ ì§ì ‘ í™•ì¸ ì‹œë„
            unzip -p "$AAB_FILE" base/manifest/AndroidManifest.xml 2>/dev/null | strings | grep -E "versionCode|versionName" || echo "ì§ì ‘ ì¶”ì¶œë„ ì‹¤íŒ¨"
          fi
          
          echo "======================================"
          echo "âœ… AAB ë¹Œë“œ ë° ê²€ì¦ ì™„ë£Œ"
          echo "======================================"

      # AAB íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 1

  deploy-playstore:
    name: Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬
    runs-on: ubuntu-latest
    needs: [prepare-build, build-android]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      # Service Account JSON ì„¤ì •
      - name: Setup Google Play Service Account
        run: |
          mkdir -p ~/.config/gcloud
          echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}" | base64 --decode > ~/.config/gcloud/service-account.json
          echo "âœ… Service Account JSON ì„¤ì • ì™„ë£Œ"

      # AAB íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      # Ruby ë° Fastlane ì„¤ì¹˜
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"

      - name: Install Fastlane
        run: |
          gem install fastlane
          echo "âœ… Fastlane ì„¤ì¹˜ ì™„ë£Œ"
          fastlane --version

      # Fastfile ìƒì„± (Play Store ë°°í¬ìš©)
      - name: Create Fastfile for Play Store
        run: |
          mkdir -p android/fastlane
          cat > android/fastlane/Fastfile << 'EOF'
          default_platform(:android)

          platform :android do
            lane :deploy_internal do
              # Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— ì—…ë¡œë“œ
              # ChangelogëŠ” ì´ë¯¸ metadata/android/ko-KR/changelogs/[VERSION_CODE].txtì— ì¤€ë¹„ë¨
              # version_codeëŠ” AAB íŒŒì¼ì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ì§€ì • ë¶ˆí•„ìš”
              upload_to_play_store(
                package_name: 'com.alom.romrom',        # Android íŒ¨í‚¤ì§€ ì´ë¦„
                track: 'internal',                      # ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™
                aab: ENV["AAB_PATH"],                   # AAB íŒŒì¼ ê²½ë¡œ (ë²„ì „ ì •ë³´ í¬í•¨)
                json_key: ENV["GOOGLE_PLAY_JSON_KEY"],  # Service Account JSON ê²½ë¡œ
                skip_upload_apk: true,                  # APK ì—…ë¡œë“œ ì•ˆí•¨
                skip_upload_metadata: true,             # ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì•ˆí•¨
                skip_upload_images: true,               # ì´ë¯¸ì§€ ì—…ë¡œë“œ ì•ˆí•¨
                skip_upload_screenshots: true,          # ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ ì•ˆí•¨
                skip_upload_changelogs: false,          # Changelog ì—…ë¡œë“œ (metadata ë””ë ‰í† ë¦¬ì—ì„œ ìë™ ì¸ì‹)
                release_status: 'completed',            # ì¦‰ì‹œ ë°°í¬
                rollout: '1.0'                          # 100% ë°°í¬
              )

              puts "âœ… Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì™„ë£Œ!"
              puts "ë²„ì „: #{ENV['VERSION_NAME']}"
            end
          end
          EOF
          
          echo "âœ… Fastfile ìƒì„± ì™„ë£Œ"
          cat android/fastlane/Fastfile

      # Play Storeì— ì—…ë¡œë“œ
      - name: Upload to Play Store Internal Testing
        run: |
          echo "======================================"
          echo "ğŸš€ Play Store ë°°í¬ ì‹œì‘"
          echo "======================================"
          
          # AAB íŒŒì¼ ì ˆëŒ€ ê²½ë¡œ ì°¾ê¸°
          AAB_PATH=$(realpath build/app/outputs/bundle/release/app-release.aab)
          echo "ğŸ“¦ AAB íŒŒì¼ ê²½ë¡œ: $AAB_PATH"

          if [ ! -f "$AAB_PATH" ]; then
            echo "âŒ AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "ë¹Œë“œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la build/app/outputs/bundle/release/
            exit 1
          fi
          
          echo "âœ… AAB íŒŒì¼ ì¡´ì¬ í™•ì¸"
          ls -lh "$AAB_PATH"
          
          # ë°°í¬ ì „ ìµœì¢… AAB ê²€ì¦ (ì¤‘ìš”!)
          echo "======================================"
          echo "ğŸ” ë°°í¬ ì „ ìµœì¢… AAB ê²€ì¦"
          echo "======================================"
          
          VERSION_CODE="${{ needs.prepare-build.outputs.version_code }}"
          VERSION_NAME="${{ needs.prepare-build.outputs.version }}"
          
          # bundletoolì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ë‹¤ìš´ë¡œë“œ
          if [ ! -f "bundletool.jar" ]; then
            echo "ğŸ“¦ bundletool ì¬ë‹¤ìš´ë¡œë“œ ì¤‘..."
            BUNDLETOOL_VERSION="1.15.6"
            wget -q "https://github.com/google/bundletool/releases/download/${BUNDLETOOL_VERSION}/bundletool-all-${BUNDLETOOL_VERSION}.jar" -O bundletool.jar
          fi
          
          if [ -f "bundletool.jar" ]; then
            echo "ğŸ” ìµœì¢… AAB ë²„ì „ ê²€ì¦ ì¤‘..."
            MANIFEST_OUTPUT=$(java -jar bundletool.jar dump manifest --bundle="$AAB_PATH" 2>/dev/null)
            
            if [ $? -eq 0 ]; then
              FINAL_VERSION_CODE=$(echo "$MANIFEST_OUTPUT" | grep -o 'android:versionCode="[0-9]*"' | grep -o '[0-9]*' | head -1)
              FINAL_VERSION_NAME=$(echo "$MANIFEST_OUTPUT" | grep -o 'android:versionName="[^"]*"' | sed 's/android:versionName="//;s/"//' | head -1)
              
              echo "ğŸ¯ ìµœì¢… ë²„ì „ ê²€ì¦:"
              echo "  ê¸°ëŒ€ VERSION_CODE: $VERSION_CODE"
              echo "  AABì˜ VERSION_CODE: $FINAL_VERSION_CODE"
              echo "  ê¸°ëŒ€ VERSION_NAME: $VERSION_NAME"
              echo "  AABì˜ VERSION_NAME: $FINAL_VERSION_NAME"
              
              if [ "$FINAL_VERSION_CODE" != "$VERSION_CODE" ]; then
                echo "âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: ìµœì¢… AAB íŒŒì¼ì˜ VERSION_CODEê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤!"
                echo "   Google Playì—ì„œ 'ë²„ì „ ì½”ë“œ $FINAL_VERSION_CODEì´ ì´ë¯¸ ì‚¬ìš©ë¨' ì˜¤ë¥˜ê°€ ë°œìƒí•  ê²ƒì…ë‹ˆë‹¤."
                echo "   ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                exit 1
              else
                echo "âœ… ìµœì¢… VERSION_CODE ê²€ì¦ ì„±ê³µ: $FINAL_VERSION_CODE"
              fi
            else
              echo "âš ï¸ bundletool ê²€ì¦ ì‹¤íŒ¨, ë°°í¬ ê³„ì† ì§„í–‰..."
            fi
          else
            echo "âš ï¸ bundletool ì—†ìŒ, ê²€ì¦ ìƒëµí•˜ê³  ë°°í¬ ê³„ì† ì§„í–‰..."
          fi

          # Release notes ì¤€ë¹„
          if [ -f "final_release_notes.txt" ]; then
            RELEASE_NOTES=$(cat final_release_notes.txt)
            echo "ğŸ“ Release Notes í¬í•¨í•˜ì—¬ ì—…ë¡œë“œ:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "$RELEASE_NOTES"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          else
            RELEASE_NOTES="v$VERSION_NAME ì—…ë°ì´íŠ¸"
            echo "âš ï¸ ê¸°ë³¸ Release Notesë¡œ ì—…ë¡œë“œ: $RELEASE_NOTES"
          fi

          # Fastlaneì´ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ changelog íŒŒì¼ ì¤€ë¹„
          CHANGELOG_DIR="android/fastlane/metadata/android/ko-KR/changelogs"
          mkdir -p "$CHANGELOG_DIR"
          
          echo "ğŸ“‹ ë°°í¬ ë²„ì „ ì •ë³´:"
          echo "  - VERSION_NAME: $VERSION_NAME"
          echo "  - VERSION_CODE: $VERSION_CODE"
          echo "  - AAB íŒŒì¼ í¬ê¸°: $(du -h "$AAB_PATH" | cut -f1)"
          
          # ì´ë¯¸ ë§Œë“¤ì–´ì§„ final_release_notes.txtë¥¼ Fastlane ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
          if [ -f "final_release_notes.txt" ]; then
            cp final_release_notes.txt "$CHANGELOG_DIR/${VERSION_CODE}.txt"
            echo "âœ… Changelog ë³µì‚¬ ì™„ë£Œ: $CHANGELOG_DIR/${VERSION_CODE}.txt"
          else
            echo "$RELEASE_NOTES" > "$CHANGELOG_DIR/${VERSION_CODE}.txt"
            echo "âœ… Changelog ìƒì„± ì™„ë£Œ: $CHANGELOG_DIR/${VERSION_CODE}.txt"
          fi
          
          echo "ğŸ“„ ìƒì„±ëœ Changelog ë‚´ìš©:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat "$CHANGELOG_DIR/${VERSION_CODE}.txt"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export AAB_PATH="$AAB_PATH"
          export GOOGLE_PLAY_JSON_KEY="$HOME/.config/gcloud/service-account.json"
          export RELEASE_NOTES="$RELEASE_NOTES"
          export VERSION_NAME="$VERSION_NAME"
          export VERSION_CODE="$VERSION_CODE"
          
          # ë””ë²„ê¹… ì •ë³´ (ìµœì¢… í™•ì¸)
          echo "======================================"
          echo "ğŸ” ìµœì¢… ë°°í¬ í™˜ê²½ í™•ì¸"
          echo "======================================"
          echo "ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "AAB ê²½ë¡œ: $AAB_PATH"
          echo "Service Account: $GOOGLE_PLAY_JSON_KEY"
          echo "ë°°í¬ ë²„ì „: $VERSION_NAME (ì½”ë“œ: $VERSION_CODE)"
          echo "Changelog íŒŒì¼: $CHANGELOG_DIR/${VERSION_CODE}.txt"
          echo "í˜„ì¬ ì‹œê°„: $(date)"
          echo "GitHub Run Number: ${{ github.run_number }}"
          echo "======================================"
          
          # Fastlane ì‹¤í–‰
          echo "ğŸš€ Fastlane ë°°í¬ ì‹œì‘..."
          cd android
          
          # Fastlane ì‹¤í–‰ ì „ ë§ˆì§€ë§‰ í™•ì¸
          echo "ğŸ“‹ Fastlane ì‹¤í–‰ ì „ í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          echo "  AAB_PATH: $AAB_PATH"
          echo "  VERSION_CODE: $VERSION_CODE"
          echo "  VERSION_NAME: $VERSION_NAME"
          
          fastlane deploy_internal

      # ì„±ê³µ ì•Œë¦¼
      - name: Notify Play Store Upload Success
        if: success()
        run: |
          echo "âœ… Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì„±ê³µ!"
          echo "ë²„ì „: ${{ needs.prepare-build.outputs.version }} (${{ needs.prepare-build.outputs.version_code }})"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          echo ""
          echo "ğŸ“± í…ŒìŠ¤í„° í™•ì¸ ë°©ë²•:"
          echo "1. Play Console â†’ í…ŒìŠ¤íŠ¸ ë° ì¶œì‹œ â†’ ë‚´ë¶€ í…ŒìŠ¤íŠ¸"
          echo "2. í…ŒìŠ¤í„°ì—ê²Œ í…ŒìŠ¤íŠ¸ ë§í¬ ê³µìœ "
          echo "3. https://play.google.com/console/u/0/developers/4736601601401567973/app/4972112751122062243/tracks/internal"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Play Store ë°°í¬ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."

