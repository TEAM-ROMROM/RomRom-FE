name: Android-PlayStore-Internal-Deploy

on:
  push:
    branches: ["deploy"]
  workflow_run:
    workflows: ["CHANGELOG ìë™ ì—…ë°ì´íŠ¸"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  FLUTTER_VERSION: "3.27.3"
  JAVA_VERSION: "17"
  PROJECT_TYPE: "flutter"

jobs:
  prepare-build:
    name: í™˜ê²½ ì„¤ì • ë° ì¤€ë¹„
    runs-on: ubuntu-latest
    # CHANGELOG ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}

    outputs:
      version: ${{ steps.current_version.outputs.version }}
      version_code: ${{ steps.current_version.outputs.version_code }}
      project_type: ${{ steps.current_version.outputs.project_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo ".env file created"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      # ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
      - name: ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          chmod +x ./.github/scripts/version_manager.sh
          chmod +x ./.github/scripts/changelog_manager.py

      # version_manager.shë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: í˜„ì¬ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: current_version
        run: |
          # ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          VERSION=$(./.github/scripts/version_manager.sh get | tail -n 1)
          echo "ğŸ“‹ ë²„ì „ ì •ë³´: $VERSION"

          # Flutter ë²„ì „ì´ x.x.x+y í˜•ì‹ì¸ì§€ í™•ì¸
          if [[ "$VERSION" == *"+"* ]]; then
            # ê¸°ì¡´ x.x.x+y í˜•ì‹ì—ì„œ ë¹Œë“œ ë²ˆí˜¸ ì¶”ì¶œ
            VERSION_NAME=$(echo "$VERSION" | cut -d'+' -f1)
            VERSION_CODE=$(echo "$VERSION" | cut -d'+' -f2)
            echo "ğŸ“‹ ê¸°ì¡´ í˜•ì‹ ê°ì§€: ë²„ì „=$VERSION_NAME, ë¹Œë“œì½”ë“œ=$VERSION_CODE"
          else
            # x.x.x í˜•ì‹ì—ì„œëŠ” ë³„ë„ ë¹Œë“œ ì½”ë“œ ì‚¬ìš©
            VERSION_NAME=$VERSION
          
            # Android ë¹Œë“œë¥¼ ìœ„í•œ ë²„ì „ ì½”ë“œ ìƒì„± (CI í™˜ê²½ì—ì„œëŠ” GITHUB_RUN_NUMBER í™œìš©)
            if [ -n "$GITHUB_RUN_NUMBER" ]; then
              VERSION_CODE=$GITHUB_RUN_NUMBER
            else
              # CI í™˜ê²½ì´ ì•„ë‹Œ ê²½ìš° íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ëŒ€ì²´
              VERSION_CODE=$(date +%s | tail -c 6)
            fi
          fi

          # ê²°ê³¼ ì¶œë ¥
          echo "version=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "project_type=${{ env.PROJECT_TYPE }}" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ í˜„ì¬ ë²„ì „: $VERSION_NAME (ë²„ì „ì½”ë“œ: $VERSION_CODE)"
          echo "ğŸ”§ í”„ë¡œì íŠ¸ íƒ€ì…: ${{ env.PROJECT_TYPE }}"

          # í™˜ê²½ë³€ìˆ˜ë¡œë„ ì„¤ì • (ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©)
          echo "VERSION=$VERSION_NAME" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "TODAY=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "PROJECT_TYPE=${{ env.PROJECT_TYPE }}" >> $GITHUB_ENV

      # CHANGELOG.jsonì—ì„œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ - changelog_manager.py ì‚¬ìš©
      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: release_notes
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"

          if [ -f "CHANGELOG.json" ]; then
            echo "ğŸ“„ CHANGELOG.jsonì—ì„œ v$VERSION ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì¤‘..."
            # CHANGELOG.md ìƒì„±
            python3 ./.github/scripts/changelog_manager.py generate-md

            # changelog_manager.py exportë¡œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ
            python3 ./.github/scripts/changelog_manager.py export --version $VERSION --output final_release_notes.txt

            if [ -s final_release_notes.txt ]; then
              echo "âœ… ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì„±ê³µ!"
              echo "ğŸ“‹ ì¶”ì¶œëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸:"
              echo "----------------------------------------"
              cat final_release_notes.txt
              echo "----------------------------------------"
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "âŒ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
            fi
          else
            echo "âš ï¸ CHANGELOG.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
            echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
            echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
          fi

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: final_release_notes.txt
          retention-days: 1

      # í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload project files
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: |
            .env
            pubspec.yaml
            lib/
            assets/
          retention-days: 1

  build-android:
    name: Android AAB ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: prepare-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      # í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ ë‹¤ìš´ë¡œë“œ
      - name: Download project files
        uses: actions/download-artifact@v4
        with:
          name: project-files
          path: .

      # .env íŒŒì¼ í™•ì¸ ë° ì¬ìƒì„± (ë³µêµ¬ ë¡œì§)
      - name: Ensure .env file exists
        run: |
          if [ ! -f .env ]; then
            echo "âš ï¸ .env íŒŒì¼ì´ ì•„í‹°íŒ©íŠ¸ì—ì„œ ë³µì›ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¬ìƒì„±í•©ë‹ˆë‹¤."
            echo "${{ secrets.ENV_FILE }}" > .env
          fi
          echo "âœ… .env íŒŒì¼ í™•ì¸ë¨ (í¬ê¸°: $(wc -c < .env) bytes)"

      # Release Keystore ì„¤ì •
      - name: Setup Release Keystore
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore/key.jks
          echo "âœ… Release Keystore ìƒì„± ì™„ë£Œ"
          ls -la android/app/keystore/

      # key.properties ìƒì„± (Release ì„œëª… ì •ë³´)
      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storeFile=keystore/key.jks
          storePassword=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.RELEASE_KEY_ALIAS }}
          keyPassword=${{ secrets.RELEASE_KEY_PASSWORD }}
          EOF
          echo "âœ… key.properties ìƒì„± ì™„ë£Œ"
          cat android/key.properties

      # Google-services.json ìƒì„±
      - name: Create Google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > android/app/google-services.json
          echo "âœ… Google-services.json ìƒì„± ì™„ë£Œ"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Android build.gradle.kts ìˆ˜ì • (release ì„œëª… ì„¤ì •)
      - name: Configure Android build for release
        run: |
          # build.gradle.ktsì— release ì„œëª… ì„¤ì •ì´ ì—†ìœ¼ë©´ ì¶”ê°€
          if ! grep -q "signingConfigs" android/app/build.gradle.kts; then
            echo "âš ï¸ build.gradle.ktsì— ì„œëª… ì„¤ì • ì¶”ê°€ í•„ìš”"
            # ì„œëª… ì„¤ì •ì€ ì´ë¯¸ ë˜ì–´ìˆë‹¤ê³  ê°€ì • (ìˆ˜ë™ìœ¼ë¡œ ë¯¸ë¦¬ ì„¤ì •í•´ì•¼ í•¨)
          fi
          echo "âœ… Android ë¹Œë“œ ì„¤ì • í™•ì¸ ì™„ë£Œ"

      # pubspec.yaml ë²„ì „ ì—…ë°ì´íŠ¸ (ë²„ì „ì •ë³´+ëŸ°íƒ€ì„ë²ˆí˜¸ ë¡œ ìˆ˜ì •í•˜ì—¬ ë¹Œë“œ)
      - name: Update pubspec.yaml version
        run: |
          VERSION_NAME="${{ needs.prepare-build.outputs.version }}"
          VERSION_CODE="${{ needs.prepare-build.outputs.version_code }}"
          
          echo "ğŸ“ pubspec.yaml ë²„ì „ ì—…ë°ì´íŠ¸: ${VERSION_NAME}+${VERSION_CODE}"
          echo "ğŸ” ìˆ˜ì • ì „ pubspec.yaml:"
          grep "^version:" pubspec.yaml
          
          # pubspec.yamlì˜ version í•„ë“œ ì—…ë°ì´íŠ¸
          cp pubspec.yaml pubspec.yaml.bak
          awk -v new_version="${VERSION_NAME}+${VERSION_CODE}" '/^version:/ {print "version: " new_version; next} {print}' pubspec.yaml.bak > pubspec.yaml
          
          echo "âœ… ìˆ˜ì • í›„ pubspec.yaml:"
          grep "^version:" pubspec.yaml
          
          # ê²€ì¦: AAB ë¹Œë“œ ì‹œ ì‚¬ìš©ë  ë²„ì „ í™•ì¸
          echo "ğŸ¯ Flutterê°€ ì¸ì‹í•  ë²„ì „:"
          flutter --version
          flutter pub get --offline || flutter pub get
          flutter analyze --no-fatal-infos || echo "ë¶„ì„ ê²½ê³  ë¬´ì‹œ"

      # Flutter build appbundle (AAB ìƒì„±)
      - name: Build Android App Bundle (AAB)
        run: |
          echo "ğŸš€ AAB ë¹Œë“œ ì‹œì‘..."
          echo "ğŸ“¦ ë¹Œë“œì— ì‚¬ìš©ë  ë²„ì „: ${{ needs.prepare-build.outputs.version }}+${{ needs.prepare-build.outputs.version_code }}"
          
          flutter build appbundle --release --verbose
          
          echo "âœ… AAB ë¹Œë“œ ì™„ë£Œ"
          ls -lh build/app/outputs/bundle/release/
          
          # AAB íŒŒì¼ ë‚´ë¶€ì˜ ì‹¤ì œ ë²„ì „ ì •ë³´ í™•ì¸ (ì¤‘ìš”!)
          echo "ğŸ” AAB íŒŒì¼ ë‚´ë¶€ ë²„ì „ ì •ë³´ í™•ì¸:"
          if command -v aapt2 &> /dev/null; then
            aapt2 dump badging build/app/outputs/bundle/release/app-release.aab 2>/dev/null | grep -E "package:|versionCode|versionName" || echo "aapt2ë¡œ í™•ì¸ ë¶ˆê°€"
          else
            echo "âš ï¸ aapt2ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. bundletoolë¡œ í™•ì¸ ì‹œë„..."
          fi
          
          # bundletoolë¡œ ë²„ì „ í™•ì¸ (ë” ì •í™•í•¨)
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "ğŸ“± AAB íŒŒì¼ ì¡´ì¬ í™•ì¸: OK"
            unzip -p build/app/outputs/bundle/release/app-release.aab base/manifest/AndroidManifest.xml | strings | grep -E "versionCode|versionName" || echo "Manifest ì§ì ‘ ì¶”ì¶œ ì‹œë„..."
          fi

      # AAB íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 1

  deploy-playstore:
    name: Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬
    runs-on: ubuntu-latest
    needs: [prepare-build, build-android]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      # Service Account JSON ì„¤ì •
      - name: Setup Google Play Service Account
        run: |
          mkdir -p ~/.config/gcloud
          echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}" | base64 --decode > ~/.config/gcloud/service-account.json
          echo "âœ… Service Account JSON ì„¤ì • ì™„ë£Œ"

      # AAB íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      # Ruby ë° Fastlane ì„¤ì¹˜
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.1"

      - name: Install Fastlane
        run: |
          gem install fastlane
          echo "âœ… Fastlane ì„¤ì¹˜ ì™„ë£Œ"
          fastlane --version

      # Fastfile ìƒì„± (Play Store ë°°í¬ìš©)
      - name: Create Fastfile for Play Store
        run: |
          mkdir -p android/fastlane
          cat > android/fastlane/Fastfile << 'EOF'
          default_platform(:android)

          platform :android do
            lane :deploy_internal do
              # Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™ì— ì—…ë¡œë“œ
              # ChangelogëŠ” ì´ë¯¸ metadata/android/ko-KR/changelogs/[VERSION_CODE].txtì— ì¤€ë¹„ë¨
              # version_codeëŠ” AAB íŒŒì¼ì— ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ì§€ì • ë¶ˆí•„ìš”
              upload_to_play_store(
                package_name: 'com.alom.romrom',        # Android íŒ¨í‚¤ì§€ ì´ë¦„
                track: 'internal',                      # ë‚´ë¶€ í…ŒìŠ¤íŠ¸ íŠ¸ë™
                aab: ENV["AAB_PATH"],                   # AAB íŒŒì¼ ê²½ë¡œ (ë²„ì „ ì •ë³´ í¬í•¨)
                json_key: ENV["GOOGLE_PLAY_JSON_KEY"],  # Service Account JSON ê²½ë¡œ
                skip_upload_apk: true,                  # APK ì—…ë¡œë“œ ì•ˆí•¨
                skip_upload_metadata: true,             # ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì•ˆí•¨
                skip_upload_images: true,               # ì´ë¯¸ì§€ ì—…ë¡œë“œ ì•ˆí•¨
                skip_upload_screenshots: true,          # ìŠ¤í¬ë¦°ìƒ· ì—…ë¡œë“œ ì•ˆí•¨
                skip_upload_changelogs: false,          # Changelog ì—…ë¡œë“œ (metadata ë””ë ‰í† ë¦¬ì—ì„œ ìë™ ì¸ì‹)
                release_status: 'completed',            # ì¦‰ì‹œ ë°°í¬
                rollout: '1.0'                          # 100% ë°°í¬
              )

              puts "âœ… Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì™„ë£Œ!"
              puts "ë²„ì „: #{ENV['VERSION_NAME']}"
            end
          end
          EOF
          
          echo "âœ… Fastfile ìƒì„± ì™„ë£Œ"
          cat android/fastlane/Fastfile

      # Play Storeì— ì—…ë¡œë“œ
      - name: Upload to Play Store Internal Testing
        run: |
          echo "======================================"
          echo "ğŸš€ Play Store ë°°í¬ ì‹œì‘"
          echo "======================================"
          
          # AAB íŒŒì¼ ì ˆëŒ€ ê²½ë¡œ ì°¾ê¸°
          AAB_PATH=$(realpath build/app/outputs/bundle/release/app-release.aab)
          echo "ğŸ“¦ AAB íŒŒì¼ ê²½ë¡œ: $AAB_PATH"

          if [ ! -f "$AAB_PATH" ]; then
            echo "âŒ AAB íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            echo "ë¹Œë“œ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la build/app/outputs/bundle/release/
            exit 1
          fi
          
          echo "âœ… AAB íŒŒì¼ ì¡´ì¬ í™•ì¸"
          ls -lh "$AAB_PATH"

          # Release notes ì¤€ë¹„
          if [ -f "final_release_notes.txt" ]; then
            RELEASE_NOTES=$(cat final_release_notes.txt)
            echo "ğŸ“ Release Notes í¬í•¨í•˜ì—¬ ì—…ë¡œë“œ:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "$RELEASE_NOTES"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          else
            RELEASE_NOTES="v${{ needs.prepare-build.outputs.version }} ì—…ë°ì´íŠ¸"
            echo "âš ï¸ ê¸°ë³¸ Release Notesë¡œ ì—…ë¡œë“œ: $RELEASE_NOTES"
          fi

          # Fastlaneì´ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ changelog íŒŒì¼ ì¤€ë¹„
          VERSION_CODE="${{ needs.prepare-build.outputs.version_code }}"
          VERSION_NAME="${{ needs.prepare-build.outputs.version }}"
          CHANGELOG_DIR="android/fastlane/metadata/android/ko-KR/changelogs"
          mkdir -p "$CHANGELOG_DIR"
          
          echo "ğŸ“‹ ë²„ì „ ì •ë³´:"
          echo "  - VERSION_NAME: $VERSION_NAME"
          echo "  - VERSION_CODE: $VERSION_CODE"
          
          # ì´ë¯¸ ë§Œë“¤ì–´ì§„ final_release_notes.txtë¥¼ Fastlane ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
          if [ -f "final_release_notes.txt" ]; then
            cp final_release_notes.txt "$CHANGELOG_DIR/${VERSION_CODE}.txt"
            echo "âœ… Changelog ë³µì‚¬ ì™„ë£Œ: $CHANGELOG_DIR/${VERSION_CODE}.txt"
          else
            echo "$RELEASE_NOTES" > "$CHANGELOG_DIR/${VERSION_CODE}.txt"
            echo "âœ… Changelog ìƒì„± ì™„ë£Œ: $CHANGELOG_DIR/${VERSION_CODE}.txt"
          fi
          
          echo "ğŸ“„ ìƒì„±ëœ Changelog ë‚´ìš©:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          cat "$CHANGELOG_DIR/${VERSION_CODE}.txt"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export AAB_PATH="$AAB_PATH"
          export GOOGLE_PLAY_JSON_KEY="$HOME/.config/gcloud/service-account.json"
          export RELEASE_NOTES="$RELEASE_NOTES"
          export VERSION_NAME="$VERSION_NAME"
          export VERSION_CODE="$VERSION_CODE"
          
          # ë””ë²„ê¹… ì •ë³´ (ìµœì¢… í™•ì¸)
          echo "======================================"
          echo "ğŸ” ìµœì¢… ë°°í¬ í™˜ê²½ í™•ì¸"
          echo "======================================"
          echo "ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "AAB ê²½ë¡œ: $AAB_PATH"
          echo "Service Account: $GOOGLE_PLAY_JSON_KEY"
          echo "ë²„ì „: $VERSION_NAME (ì½”ë“œ: $VERSION_CODE)"
          echo "Changelog íŒŒì¼: $CHANGELOG_DIR/${VERSION_CODE}.txt"
          echo "======================================"
          
          # Fastlane ì‹¤í–‰
          echo "ğŸš€ Fastlane ë°°í¬ ì‹œì‘..."
          cd android
          fastlane deploy_internal

      # ì„±ê³µ ì•Œë¦¼
      - name: Notify Play Store Upload Success
        if: success()
        run: |
          echo "âœ… Play Store ë‚´ë¶€ í…ŒìŠ¤íŠ¸ ë°°í¬ ì„±ê³µ!"
          echo "ë²„ì „: ${{ needs.prepare-build.outputs.version }} (${{ needs.prepare-build.outputs.version_code }})"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          echo ""
          echo "ğŸ“± í…ŒìŠ¤í„° í™•ì¸ ë°©ë²•:"
          echo "1. Play Console â†’ í…ŒìŠ¤íŠ¸ ë° ì¶œì‹œ â†’ ë‚´ë¶€ í…ŒìŠ¤íŠ¸"
          echo "2. í…ŒìŠ¤í„°ì—ê²Œ í…ŒìŠ¤íŠ¸ ë§í¬ ê³µìœ "
          echo "3. https://play.google.com/console/u/0/developers/4736601601401567973/app/4972112751122062243/tracks/internal"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Play Store ë°°í¬ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."

