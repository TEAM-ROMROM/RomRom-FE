# ===================================================================
# í…œí”Œë¦¿ Util ëª¨ë“ˆ ë²„ì „ ë™ê¸°í™” ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” SUH-DEVOPS-TEMPLATE ì „ìš©ìœ¼ë¡œ,
# .github/util/ í•˜ìœ„ì˜ version.json íŒŒì¼ì´ ë³€ê²½ë  ë•Œ ìë™ìœ¼ë¡œ
# í•´ë‹¹ ë””ë ‰í† ë¦¬ì˜ version-sync.sh ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬
# HTML íŒŒì¼ì˜ ë²„ì „ ì •ë³´ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤.
#
# íŠ¸ë¦¬ê±° ì¡°ê±´:
# - .github/util/**/version.json íŒŒì¼ ë³€ê²½ ì‹œ
# - ìˆ˜ë™ ì‹¤í–‰ (workflow_dispatch)
#
# ë™ì‘ ë°©ì‹:
# 1. .github/util/ í•˜ìœ„ì˜ ëª¨ë“  version-sync.sh ìŠ¤í¬ë¦½íŠ¸ë¥¼ íƒìƒ‰
# 2. ê° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (version.json â†’ HTML ë™ê¸°í™”)
# 3. ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ìë™ ì»¤ë°‹ & í‘¸ì‹œ
#
# ì£¼ì˜ì‚¬í•­:
# - VERSION-CONTROL ì›Œí¬í”Œë¡œìš°ì™€ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ concurrency ì„¤ì •
# - [skip ci] ì»¤ë°‹ ë©”ì‹œì§€ë¡œ ë¬´í•œ ë£¨í”„ ë°©ì§€
#
# ===================================================================

name: TEMPLATE-UTIL-VERSION-SYNC

on:
  push:
    branches: [ main ]
    paths:
      - '.github/util/**/version.json'
  workflow_dispatch:

# VERSION-CONTROL ì›Œí¬í”Œë¡œìš°ì™€ ì¶©ëŒ ë°©ì§€
concurrency:
  group: version-sync
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  version-sync:
    name: Sync Version JSON to HTML
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Find and Execute All version-sync.sh Scripts
      run: |
        echo "ğŸ” .github/util/ í•˜ìœ„ì˜ version-sync.sh ìŠ¤í¬ë¦½íŠ¸ íƒìƒ‰ ì¤‘..."

        # version-sync.sh ìŠ¤í¬ë¦½íŠ¸ ëª©ë¡ ì°¾ê¸°
        SYNC_SCRIPTS=$(find .github/util -name "version-sync.sh" -type f 2>/dev/null || true)

        if [ -z "$SYNC_SCRIPTS" ]; then
          echo "âš ï¸ version-sync.sh ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          exit 0
        fi

        echo "ğŸ“‹ ë°œê²¬ëœ ìŠ¤í¬ë¦½íŠ¸:"
        echo "$SYNC_SCRIPTS"
        echo ""

        # ê° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        SCRIPT_COUNT=0
        SUCCESS_COUNT=0

        for SCRIPT in $SYNC_SCRIPTS; do
          SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
          SCRIPT_DIR=$(dirname "$SCRIPT")
          SCRIPT_NAME=$(basename "$SCRIPT_DIR")

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ [$SCRIPT_COUNT] $SCRIPT_NAME ë™ê¸°í™” ì‹¤í–‰"
          echo "   ê²½ë¡œ: $SCRIPT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x "$SCRIPT"

          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if bash "$SCRIPT"; then
            echo "âœ… $SCRIPT_NAME ë™ê¸°í™” ì„±ê³µ"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          else
            echo "âŒ $SCRIPT_NAME ë™ê¸°í™” ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          fi

          echo ""
        done

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š ì‹¤í–‰ ê²°ê³¼: $SUCCESS_COUNT / $SCRIPT_COUNT ì„±ê³µ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Check for Changes
      id: changes
      run: |
        git diff --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT

    - name: Commit and Push Changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add .
        git commit -m "chore: github workflow util module version sync [skip ci]"

        # Race Condition ë°©ì§€: pull-rebase í›„ push (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
        MAX_RETRIES=3
        RETRY_COUNT=0
        PUSH_SUCCESS=false

        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          RETRY_COUNT=$((RETRY_COUNT + 1))
          echo "ğŸ”„ Push ì‹œë„ $RETRY_COUNT/$MAX_RETRIES..."

          if git push; then
            PUSH_SUCCESS=true
            echo "âœ… ë³€ê²½ì‚¬í•­ì´ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤."
            break
          else
            echo "âš ï¸ Push ì‹¤íŒ¨, remote ë³€ê²½ì‚¬í•­ ë™ê¸°í™” ì¤‘..."

            if git pull --rebase origin ${{ github.ref_name }}; then
              echo "âœ… Rebase ì„±ê³µ, ë‹¤ì‹œ push ì‹œë„..."
            else
              echo "âŒ Rebase ì‹¤íŒ¨, ì¶©ëŒ í•´ê²° í•„ìš”"
              git rebase --abort 2>/dev/null || true
              exit 1
            fi
          fi
        done

        if [ "$PUSH_SUCCESS" = false ]; then
          echo "âŒ $MAX_RETRIESíšŒ ì‹œë„ í›„ì—ë„ push ì‹¤íŒ¨"
          exit 1
        fi

    - name: No Changes
      if: steps.changes.outputs.has_changes != 'true'
      run: |
        echo "â„¹ï¸ ë™ê¸°í™”í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. (ì´ë¯¸ ë™ê¸°í™”ë¨)"

    - name: Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ‰ ë²„ì „ ë™ê¸°í™” ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
        echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "ğŸ“Œ ì»¤ë°‹: ${{ github.sha }}"
        echo "ğŸ• ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
