# ===================================================================
# Flutter iOS í…ŒìŠ¤íŠ¸ìš© TestFlight ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ê¸°ëŠ¥ ë¸Œëœì¹˜ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬
# í…ŒìŠ¤íŠ¸ìš© iOS ë¹Œë“œë¥¼ TestFlightì— ë°°í¬í•©ë‹ˆë‹¤.
#
# â˜… ë§ˆë²•ì‚¬ ìš°ì„  ì•„í‚¤í…ì²˜ â˜…
# - ë¹Œë“œì— í•„ìš”í•œ ì„¤ì • íŒŒì¼ë“¤ì€ ì›¹ ë§ˆë²•ì‚¬ê°€ ìƒì„±í•©ë‹ˆë‹¤
# - ì›Œí¬í”Œë¡œìš°ëŠ” ë§ˆë²•ì‚¬ê°€ ìƒì„±í•œ íŒŒì¼ë“¤ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤
# - ë§ˆë²•ì‚¬ ê²½ë¡œ: .github/util/flutter/ios-testflight-setup-wizard/index.html
#
# ì£¼ìš” íŠ¹ì§•:
# - workflow_dispatchë¡œ ìˆ˜ë™ ì‹¤í–‰ ë˜ëŠ” repository_dispatchë¡œ íŠ¸ë¦¬ê±°
# - ë²„ì „ì€ 0.0.0ìœ¼ë¡œ ê³ ì • (ìš´ì˜ ë²„ì „ê³¼ ë¶„ë¦¬)
# - ë¹Œë“œ ë²ˆí˜¸ëŠ” PRë²ˆí˜¸ + ì¹´ìš´íŠ¸ ë˜ëŠ” GITHUB_RUN_NUMBER ì‚¬ìš©
# - ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ìë™ ì¶”ì¶œ (YYYYMMDD_#ì´ìŠˆë²ˆí˜¸_ë‚´ìš© í˜•ì‹)
# - GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì™€ì„œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ì— í¬í•¨
#
# ë¹Œë“œ íŒŒì´í”„ë¼ì¸:
#   1. flutter build ios --no-codesign (Flutter ë¹Œë“œ)
#   2. xcodebuild archive (Xcode ì•„ì¹´ì´ë¸Œ ìƒì„±)
#   3. xcodebuild -exportArchive (IPA ìƒì„±, ExportOptions.plist ì‚¬ìš©)
#   4. fastlane upload_testflight (ë§ˆë²•ì‚¬ ìƒì„± Fastfile ì‚¬ìš©)
#
# ===================================================================
# ğŸ“‹ í•„ìš”í•œ GitHub Secrets
# ===================================================================
#
# ğŸ” Apple ì¸ì¦ì„œ & í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ (í•„ìˆ˜):
#   - APPLE_CERTIFICATE_BASE64        : .p12 ì¸ì¦ì„œ (base64 ì¸ì½”ë”©)
#   - APPLE_CERTIFICATE_PASSWORD      : .p12 ì¸ì¦ì„œ ë¹„ë°€ë²ˆí˜¸
#   - APPLE_PROVISIONING_PROFILE_BASE64 : .mobileprovision íŒŒì¼ (base64 ì¸ì½”ë”©)
#   - IOS_PROVISIONING_PROFILE_NAME   : í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì´ë¦„ (ì˜ˆ: "MyApp Distribution")
#
# ğŸ”‘ App Store Connect API (í•„ìˆ˜):
#   - APP_STORE_CONNECT_API_KEY_ID    : API Key ID (10ìë¦¬, ì˜ˆ: ABC123DEF4)
#   - APP_STORE_CONNECT_ISSUER_ID     : Issuer ID (UUID í˜•ì‹)
#   - APP_STORE_CONNECT_API_KEY_BASE64: AuthKey_XXXXXX.p8 íŒŒì¼ (base64 ì¸ì½”ë”©)
#
# ğŸ“ í™˜ê²½ ì„¤ì • (ì„ íƒ):
#   - ENV_FILE (ë˜ëŠ” ENV)             : .env íŒŒì¼ ë‚´ìš© (ì•±ì—ì„œ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ë³€ìˆ˜)
#   - SECRETS_XCCONFIG                : ios/Flutter/Secrets.xcconfig ë‚´ìš© (ì„ íƒ)
#
# ===================================================================

name: PROJECT-Flutter-iOS-Test-TestFlight

on:
  workflow_dispatch:
  repository_dispatch:
    types: [build-ios-app]

# ============================================
# ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì • (ì•„ë˜ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”)
# ============================================
env:
  FLUTTER_VERSION: "3.35.5"
  XCODE_VERSION: "16.3"
  PROJECT_TYPE: "flutter"
  ENV_FILE_PATH: ".env"

jobs:
  prepare-test-build:
    name: í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì¤€ë¹„
    runs-on: macos-15

    outputs:
      version: ${{ steps.test_version.outputs.version }}
      build_number: ${{ steps.test_version.outputs.build_number }}
      issue_url: ${{ steps.issue_info.outputs.issue_url }}
      issue_title: ${{ steps.issue_info.outputs.issue_title }}
      issue_number: ${{ steps.issue_info.outputs.issue_number }}
      branch_name: ${{ steps.issue_info.outputs.branch_name }}
      pr_number: ${{ steps.test_version.outputs.pr_number }}
      commit_hash: ${{ steps.release_notes.outputs.commit_hash }}
      progress_comment_id: ${{ steps.progress.outputs.comment_id }}
      prepare_start: ${{ steps.progress.outputs.start_time }}

    steps:
      - name: ë¸Œëœì¹˜ ì¡´ì¬ ì—¬ë¶€ ì‚¬ì „ í™•ì¸
        id: verify_branch
        if: github.event_name == 'repository_dispatch'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ github.event.client_payload.branch_name }}';
            const prNumber = '${{ github.event.client_payload.pr_number }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            console.log(`ğŸ” ë¸Œëœì¹˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸: ${branchName}`);

            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName
              });
              console.log(`âœ… ë¸Œëœì¹˜ ì¡´ì¬ í™•ì¸ë¨: ${branchName}`);
            } catch (error) {
              if (error.status === 404) {
                console.log(`âŒ ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${branchName}`);

                // ì—ëŸ¬ ëŒ“ê¸€ ì‘ì„±
                const body = [
                  'ğŸ âŒ **iOS TestFlight ë¹Œë“œ ì‹¤íŒ¨ - ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤**',
                  '',
                  '| í•­ëª© | ê°’ |',
                  '|------|-----|',
                  `| **ìš”ì²­ëœ ë¸Œëœì¹˜** | \`${branchName}\` |`,
                  `| **ì´ìŠˆ/PR** | #${prNumber} |`,
                  '',
                  '### ğŸ’¡ í™•ì¸ ì‚¬í•­',
                  '1. ë¸Œëœì¹˜ê°€ ì›ê²© ì €ì¥ì†Œì— pushë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
                  '2. "Guide by SUH-LAB" ëŒ“ê¸€ì˜ ë¸Œëœì¹˜ëª…ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”',
                  '3. ë¸Œëœì¹˜ëª…ì— ì˜¤íƒ€ê°€ ì—†ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”',
                  '',
                  `ğŸ”— [ì›Œí¬í”Œë¡œìš° ë¡œê·¸](${runUrl})`
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                  body: body
                });

                core.setFailed(`ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${branchName}`);
              } else {
                core.setFailed(`ë¸Œëœì¹˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
              }
            }

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ì§„í–‰ ìƒí™© ëŒ“ê¸€ ì‹œìŠ¤í…œ
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„±
        id: progress
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ github.event.client_payload.pr_number }}');
            const branchName = '${{ github.event.client_payload.branch_name }}';
            const buildNumber = '${{ github.event.client_payload.build_number }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const startTime = Date.now();

            const body = [
              '## ğŸ iOS TestFlight ë¹Œë“œ ì§„í–‰ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              '| ğŸ”§ ì¤€ë¹„ | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸ”¨ IPA ë¹Œë“œ | â¸ï¸ ëŒ€ê¸° | - |',
              '| ğŸ“¤ TestFlight ë°°í¬ | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì•± ë²„ì „** | \`0.0.0(${buildNumber})\` |`,
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`âœ… ì§„í–‰ ìƒí™© ëŒ“ê¸€ ìƒì„± ì™„ë£Œ: #${comment.id}`);
            core.setOutput('comment_id', comment.id);
            core.setOutput('start_time', startTime);

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Create .env file
        run: |
          cat << 'EOF' > ${{ env.ENV_FILE_PATH }}
          ${{ secrets.ENV_FILE || secrets.ENV }}
          EOF
          echo "âœ… ${{ env.ENV_FILE_PATH }} file created"

      - name: Create Secrets.xcconfig file
        run: |
          mkdir -p ios/Flutter
          if [ -n "${{ secrets.SECRETS_XCCONFIG }}" ]; then
            echo "${{ secrets.SECRETS_XCCONFIG }}" > ios/Flutter/Secrets.xcconfig
            echo "âœ… Secrets.xcconfig created"
          else
            echo "// No secrets provided" > ios/Flutter/Secrets.xcconfig
            echo "â„¹ï¸ Empty Secrets.xcconfig created (no secrets provided)"
          fi

      # í…ŒìŠ¤íŠ¸ ë¹Œë“œ ë²„ì „ ì„¤ì • (0.0.0 ê³ ì •)
      - name: í…ŒìŠ¤íŠ¸ ë¹Œë“œ ë²„ì „ ì„¤ì •
        id: test_version
        run: |
          echo "version=0.0.0" >> $GITHUB_OUTPUT

          # repository_dispatch ì´ë²¤íŠ¸ì¸ ê²½ìš° PR ë²ˆí˜¸ë¥¼ ë¹Œë“œ ë²ˆí˜¸ë¡œ ì‚¬ìš©
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BUILD_NUMBER="${{ github.event.client_payload.build_number }}"
            PR_NUMBER="${{ github.event.client_payload.pr_number }}"
            echo "ğŸ“‹ repository_dispatch ì´ë²¤íŠ¸ ê°ì§€"
            echo "  PR ë²ˆí˜¸: #$PR_NUMBER"
            echo "  ë¹Œë“œ ë²ˆí˜¸: $BUILD_NUMBER (PR ë²ˆí˜¸ ì‚¬ìš©)"
          else
            BUILD_NUMBER="${{ github.run_number }}"
            PR_NUMBER=""
            echo "ğŸ“‹ workflow_dispatch ì´ë²¤íŠ¸ ê°ì§€"
            echo "  ë¹Œë“œ ë²ˆí˜¸: $BUILD_NUMBER (ê¸°ë³¸ê°’)"
          fi

          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ í…ŒìŠ¤íŠ¸ ë¹Œë“œ: ë²„ì „=0.0.0, ë¹Œë“œë²ˆí˜¸=$BUILD_NUMBER"

      # ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ ë° GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ì •ë³´ ì¶”ì¶œ
        id: issue_info
        run: |
          # repository_dispatchì¸ ê²½ìš° client_payloadì—ì„œ ë¸Œëœì¹˜ëª… ê°€ì ¸ì˜¤ê¸°
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            BRANCH_NAME="${{ github.event.client_payload.branch_name }}"
            ISSUE_NUMBER="${{ github.event.client_payload.issue_number }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
            # ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (#387 í˜•ì‹)
            ISSUE_NUMBER=$(echo "$BRANCH_NAME" | sed -n 's/.*#\([0-9]*\).*/\1/p')
          fi

          echo "ğŸŒ¿ ë¸Œëœì¹˜ëª…: $BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âš ï¸ ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "issue_url=" >> $GITHUB_OUTPUT
            echo "issue_title=" >> $GITHUB_OUTPUT
            echo "issue_number=" >> $GITHUB_OUTPUT
          else
            echo "âœ… ì¶”ì¶œëœ ì´ìŠˆ ë²ˆí˜¸: #$ISSUE_NUMBER"
            ISSUE_URL="https://github.com/${{ github.repository }}/issues/$ISSUE_NUMBER"
            echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

            # GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ” GitHub APIë¡œ ì´ìŠˆ ì •ë³´ ì¡°íšŒ ì¤‘..."
            ISSUE_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")

            ISSUE_TITLE=$(echo "$ISSUE_RESPONSE" | jq -r '.title // "ì´ìŠˆ ì •ë³´ ì—†ìŒ"')
            ISSUE_STATE=$(echo "$ISSUE_RESPONSE" | jq -r '.state // "unknown"')

            if [ "$ISSUE_TITLE" = "null" ] || [ "$ISSUE_TITLE" = "ì´ìŠˆ ì •ë³´ ì—†ìŒ" ]; then
              echo "âš ï¸ ì´ìŠˆ #$ISSUE_NUMBERë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "issue_title=" >> $GITHUB_OUTPUT
            else
              echo "ğŸ“‹ ì´ìŠˆ ì œëª©: $ISSUE_TITLE"
              echo "ğŸ“Œ ì´ìŠˆ ìƒíƒœ: $ISSUE_STATE"
              echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
            fi
          fi

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: release_notes
        run: |
          BUILD_NUMBER="${{ steps.test_version.outputs.build_number }}"
          BRANCH_NAME="${{ steps.issue_info.outputs.branch_name }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_SHORT=$(echo "$COMMIT_SHA" | cut -c1-7)
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')

          echo "commit_hash=$COMMIT_SHORT" >> $GITHUB_OUTPUT

          cat > final_release_notes.txt << EOF
          í…ŒìŠ¤íŠ¸ ë¹Œë“œ #$BUILD_NUMBER

          ë¸Œëœì¹˜: $BRANCH_NAME
          ì»¤ë°‹: $COMMIT_SHORT
          ë‚ ì§œ: $BUILD_DATE

          EOF

          # ì´ìŠˆ ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€
          if [ -n "${{ steps.issue_info.outputs.issue_number }}" ]; then
            ISSUE_NUMBER="${{ steps.issue_info.outputs.issue_number }}"
            ISSUE_TITLE="${{ steps.issue_info.outputs.issue_title }}"
            ISSUE_URL="${{ steps.issue_info.outputs.issue_url }}"

            cat >> final_release_notes.txt << EOF
          ê´€ë ¨ ì´ìŠˆ:
          - #$ISSUE_NUMBER: $ISSUE_TITLE
          - URL: $ISSUE_URL

          EOF
          fi

          echo "ğŸ“‹ ìƒì„±ëœ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸:"
          echo "----------------------------------------"
          cat final_release_notes.txt
          echo "----------------------------------------"

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: final_release_notes.txt
          retention-days: 1

      - name: Upload project files
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: |
            ${{ env.ENV_FILE_PATH }}
            ios/Flutter/Secrets.xcconfig
            pubspec.yaml
            lib/
            assets/
          retention-days: 1

      # ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ - ì¤€ë¹„ ì™„ë£Œ
      - name: ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ - ì¤€ë¹„ ì™„ë£Œ
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != '' && steps.progress.outputs.comment_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ steps.progress.outputs.comment_id }}');
            const startTime = parseInt('${{ steps.progress.outputs.start_time }}');
            const branchName = '${{ github.event.client_payload.branch_name }}';
            const buildNumber = '${{ github.event.client_payload.build_number }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const now = Date.now();
            const elapsed = now - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const duration = minutes > 0 ? `${minutes}ë¶„ ${seconds}ì´ˆ` : `${seconds}ì´ˆ`;

            const body = [
              '## ğŸ iOS TestFlight ë¹Œë“œ ì§„í–‰ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”§ ì¤€ë¹„ | âœ… ì™„ë£Œ | ${duration} |`,
              '| ğŸ”¨ IPA ë¹Œë“œ | â³ ì§„í–‰ ì¤‘... | - |',
              '| ğŸ“¤ TestFlight ë°°í¬ | â¸ï¸ ëŒ€ê¸° | - |',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì•± ë²„ì „** | \`0.0.0(${buildNumber})\` |`,
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            console.log(`âœ… ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì¤€ë¹„ ì™„ë£Œ (${duration})`);

  # ============================================
  # iOS ë¹Œë“œ (xcodebuild ì§ì ‘ ì‚¬ìš©)
  # ============================================
  build-ios-test:
    name: iOS í…ŒìŠ¤íŠ¸ ë¹Œë“œ
    runs-on: macos-15
    needs: prepare-test-build

    outputs:
      build_start: ${{ steps.build_start.outputs.time }}

    steps:
      # ë¹Œë“œ ì‹œì‘ ì‹œê°„ ê¸°ë¡ (JavaScriptë¡œ ë°€ë¦¬ì´ˆ ë‹¨ìœ„ ê¸°ë¡)
      - name: ë¹Œë“œ ì‹œì‘ ì‹œê°„ ê¸°ë¡
        id: build_start
        uses: actions/github-script@v7
        with:
          script: |
            core.setOutput('time', Date.now().toString());

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Download project files
        uses: actions/download-artifact@v4
        with:
          name: project-files
          path: .

      - name: Ensure .env file exists
        run: |
          if [ ! -f "${{ env.ENV_FILE_PATH }}" ]; then
            cat << 'EOF' > ${{ env.ENV_FILE_PATH }}
          ${{ secrets.ENV_FILE || secrets.ENV }}
          EOF
            echo "âœ… ${{ env.ENV_FILE_PATH }} file created (fallback)"
          fi

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install

      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profile
        run: |
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          uuid=$(grep -A1 -a "UUID" profile.mobileprovision | grep string | sed -e "s/<string>//" -e "s/<\/string>//" -e "s/[[:space:]]//g")
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision

      - name: Verify ExportOptions.plist
        run: |
          cd ios
          if [ ! -f "ExportOptions.plist" ]; then
            echo "âŒ ios/ExportOptions.plistì´ ì—†ìŠµë‹ˆë‹¤!"
            echo "ì›¹ ë§ˆë²•ì‚¬ë¥¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì • íŒŒì¼ì„ ìƒì„±í•˜ì„¸ìš”:"
            echo "  ë¸Œë¼ìš°ì €ì—ì„œ .github/util/flutter/ios-testflight-setup-wizard/index.html ì—´ê¸°"
            exit 1
          fi
          echo "âœ… ExportOptions.plist í™•ì¸ë¨"

      - name: Flutter build (no codesign)
        run: |
          flutter build ios --release --no-codesign \
            --build-name="0.0.0" \
            --build-number="${{ needs.prepare-test-build.outputs.build_number }}"

      - name: Create Archive
        env:
          IOS_PROVISIONING_PROFILE_NAME: ${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}
        run: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -archivePath build/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            archive \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$IOS_PROVISIONING_PROFILE_NAME" \
            CODE_SIGN_IDENTITY="Apple Distribution"

      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist

      - name: Create build metadata file
        run: |
          cat > build-metadata.json << EOF
          {
            "pr_number": "${{ needs.prepare-test-build.outputs.pr_number }}",
            "build_number": "${{ needs.prepare-test-build.outputs.build_number }}",
            "issue_number": "${{ needs.prepare-test-build.outputs.issue_number }}",
            "branch_name": "${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          }
          EOF
          cat build-metadata.json

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: |
            ios/build/ipa/*.ipa
            build-metadata.json
          retention-days: 1

      # ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ - IPA ë¹Œë“œ ì™„ë£Œ
      - name: ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ - IPA ë¹Œë“œ ì™„ë£Œ
        if: success() && github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != '' && needs.prepare-test-build.outputs.progress_comment_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ needs.prepare-test-build.outputs.progress_comment_id }}');
            const prepareStart = parseInt('${{ needs.prepare-test-build.outputs.prepare_start }}');
            const buildStart = parseInt('${{ steps.build_start.outputs.time }}');
            const branchName = '${{ github.event.client_payload.branch_name }}';
            const buildNumber = '${{ github.event.client_payload.build_number }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const now = Date.now();

            // ì¤€ë¹„ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const prepareElapsed = buildStart - prepareStart;
            const prepareMin = Math.floor(prepareElapsed / 60000);
            const prepareSec = Math.floor((prepareElapsed % 60000) / 1000);
            const prepareDuration = prepareMin > 0 ? `${prepareMin}ë¶„ ${prepareSec}ì´ˆ` : `${prepareSec}ì´ˆ`;

            // ë¹Œë“œ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const buildElapsed = now - buildStart;
            const buildMin = Math.floor(buildElapsed / 60000);
            const buildSec = Math.floor((buildElapsed % 60000) / 1000);
            const buildDuration = buildMin > 0 ? `${buildMin}ë¶„ ${buildSec}ì´ˆ` : `${buildSec}ì´ˆ`;

            const body = [
              '## ğŸ iOS TestFlight ë¹Œë“œ ì§„í–‰ ì¤‘...',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”§ ì¤€ë¹„ | âœ… ì™„ë£Œ | ${prepareDuration} |`,
              `| ğŸ”¨ IPA ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              '| ğŸ“¤ TestFlight ë°°í¬ | â³ ì§„í–‰ ì¤‘... | - |',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì•± ë²„ì „** | \`0.0.0(${buildNumber})\` |`,
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              '',
              `**[ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°](${runUrl})**`,
              '',
              '---',
              '*ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*'
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            console.log(`âœ… ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì™„ë£Œ: IPA ë¹Œë“œ ì™„ë£Œ (${buildDuration})`);

      # ë¹Œë“œ ì‹¤íŒ¨ ì‹œ progress ëŒ“ê¸€ ì—…ë°ì´íŠ¸
      - name: ë¹Œë“œ ì‹¤íŒ¨ ì‹œ progress ëŒ“ê¸€ ì—…ë°ì´íŠ¸
        if: failure() && github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != '' && needs.prepare-test-build.outputs.progress_comment_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ needs.prepare-test-build.outputs.progress_comment_id }}');
            const prepareStart = parseInt('${{ needs.prepare-test-build.outputs.prepare_start }}');
            const buildStart = parseInt('${{ steps.build_start.outputs.time }}');
            const branchName = '${{ github.event.client_payload.branch_name }}';
            const buildNumber = '${{ github.event.client_payload.build_number }}';
            const commitHash = '${{ needs.prepare-test-build.outputs.commit_hash }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const now = Date.now();

            // ì¤€ë¹„ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const prepareElapsed = buildStart - prepareStart;
            const prepareMin = Math.floor(prepareElapsed / 60000);
            const prepareSec = Math.floor((prepareElapsed % 60000) / 1000);
            const prepareDuration = prepareMin > 0 ? `${prepareMin}ë¶„ ${prepareSec}ì´ˆ` : `${prepareSec}ì´ˆ`;

            // ë¹Œë“œ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const buildElapsed = now - buildStart;
            const buildMin = Math.floor(buildElapsed / 60000);
            const buildSec = Math.floor((buildElapsed % 60000) / 1000);
            const buildDuration = buildMin > 0 ? `${buildMin}ë¶„ ${buildSec}ì´ˆ` : `${buildSec}ì´ˆ`;

            const body = [
              '## ğŸ âŒ iOS TestFlight ë¹Œë“œ ì‹¤íŒ¨',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”§ ì¤€ë¹„ | âœ… ì™„ë£Œ | ${prepareDuration} |`,
              `| ğŸ”¨ IPA ë¹Œë“œ | âŒ ì‹¤íŒ¨ | ${buildDuration} |`,
              '| ğŸ“¤ TestFlight ë°°í¬ | â¸ï¸ ì·¨ì†Œë¨ | - |',
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì•± ë²„ì „** | \`0.0.0(${buildNumber})\` |`,
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              `| **ì»¤ë°‹** | \`${commitHash}\` |`,
              '',
              'âŒ **IPA ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.**',
              '',
              `ğŸ”— [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸ í™•ì¸](${runUrl})`
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            console.log(`âŒ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì™„ë£Œ: IPA ë¹Œë“œ ì‹¤íŒ¨`);

  # ============================================
  # TestFlight ë°°í¬ (ë§ˆë²•ì‚¬ ìƒì„± Fastfile ì‚¬ìš©)
  # ============================================
  deploy-testflight-test:
    name: TestFlight í…ŒìŠ¤íŠ¸ ë°°í¬
    runs-on: macos-15
    needs: [prepare-test-build, build-ios-test]

    steps:
      # ë°°í¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
      - name: ë°°í¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
        id: deploy_start
        uses: actions/github-script@v7
        with:
          script: |
            core.setOutput('time', Date.now().toString());

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref }}

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/ipa/

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: Verify Fastfile exists
        run: |
          if [ ! -f "ios/fastlane/Fastfile" ]; then
            echo "âŒ ios/fastlane/Fastfileì´ ì—†ìŠµë‹ˆë‹¤!"
            echo "ì›¹ ë§ˆë²•ì‚¬ë¥¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì • íŒŒì¼ì„ ìƒì„±í•˜ì„¸ìš”:"
            echo "  ë¸Œë¼ìš°ì €ì—ì„œ .github/util/flutter/ios-testflight-setup-wizard/index.html ì—´ê¸°"
            exit 1
          fi
          echo "âœ… Fastfile í™•ì¸ë¨: ios/fastlane/Fastfile"

      - name: Install Fastlane
        run: gem install fastlane

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          # IPA íŒŒì¼ ì°¾ê¸°
          IPA_PATH=$(find $GITHUB_WORKSPACE/ios/build/ipa -name "*.ipa" | head -1)
          echo "ğŸ“¦ Found IPA at: $IPA_PATH"

          if [ ! -f "$IPA_PATH" ]; then
            echo "âŒ IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            ls -la ios/build/ipa/
            exit 1
          fi

          # Release notes ì¤€ë¹„
          if [ -f "final_release_notes.txt" ]; then
            RELEASE_NOTES=$(cat final_release_notes.txt)
            echo "ğŸ“ Release Notes:"
            echo "$RELEASE_NOTES"
          else
            RELEASE_NOTES="í…ŒìŠ¤íŠ¸ ë¹Œë“œ #${{ needs.prepare-test-build.outputs.build_number }}"
            echo "ğŸ“ ê¸°ë³¸ Release Notes: $RELEASE_NOTES"
          fi

          # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (Fastfileì—ì„œ ì‚¬ìš©)
          export API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          export IPA_PATH="$IPA_PATH"
          export RELEASE_NOTES="$RELEASE_NOTES"

          echo "ğŸ”§ Working directory: $(pwd)"
          echo "ğŸ”§ IPA_PATH: $IPA_PATH"
          echo "ğŸ”§ API_KEY_PATH: $API_KEY_PATH"

          # Fastlane ì‹¤í–‰ (ë§ˆë²•ì‚¬ê°€ ìƒì„±í•œ Fastfile ì‚¬ìš©)
          cd ios
          fastlane upload_testflight

      - name: Notify TestFlight Upload Success
        if: success()
        run: |
          echo "âœ… TestFlight í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì—…ë¡œë“œ ì„±ê³µ!"
          echo "ë²„ì „: 0.0.0"
          echo "ë¹Œë“œ ë²ˆí˜¸: ${{ needs.prepare-test-build.outputs.build_number }}"
          if [ -n "${{ needs.prepare-test-build.outputs.pr_number }}" ]; then
            echo "PR ë²ˆí˜¸: ${{ needs.prepare-test-build.outputs.pr_number }}"
          fi
          echo "ë¸Œëœì¹˜: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.branch_name || github.ref_name }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          if [ -n "${{ needs.prepare-test-build.outputs.issue_url }}" ]; then
            echo "ê´€ë ¨ ì´ìŠˆ: ${{ needs.prepare-test-build.outputs.issue_url }}"
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ TestFlight í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì—…ë¡œë“œ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."

      # ì§„í–‰ ìƒí™© ìµœì¢… ì—…ë°ì´íŠ¸ - ì„±ê³µ
      - name: ì§„í–‰ ìƒí™© ìµœì¢… ì—…ë°ì´íŠ¸ - ì„±ê³µ
        if: success() && github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != '' && needs.prepare-test-build.outputs.progress_comment_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ needs.prepare-test-build.outputs.progress_comment_id }}');
            const prepareStart = parseInt('${{ needs.prepare-test-build.outputs.prepare_start }}');
            const buildStart = parseInt('${{ needs.build-ios-test.outputs.build_start }}');
            const deployStart = parseInt('${{ steps.deploy_start.outputs.time }}');
            const branchName = '${{ github.event.client_payload.branch_name }}';
            const buildNumber = '${{ github.event.client_payload.build_number }}';
            const commitHash = '${{ needs.prepare-test-build.outputs.commit_hash }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const now = Date.now();

            // ì¤€ë¹„ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const prepareElapsed = buildStart - prepareStart;
            const prepareMin = Math.floor(prepareElapsed / 60000);
            const prepareSec = Math.floor((prepareElapsed % 60000) / 1000);
            const prepareDuration = prepareMin > 0 ? `${prepareMin}ë¶„ ${prepareSec}ì´ˆ` : `${prepareSec}ì´ˆ`;

            // ë¹Œë“œ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const buildElapsed = deployStart - buildStart;
            const buildMin = Math.floor(buildElapsed / 60000);
            const buildSec = Math.floor((buildElapsed % 60000) / 1000);
            const buildDuration = buildMin > 0 ? `${buildMin}ë¶„ ${buildSec}ì´ˆ` : `${buildSec}ì´ˆ`;

            // ë°°í¬ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const deployElapsed = now - deployStart;
            const deployMin = Math.floor(deployElapsed / 60000);
            const deploySec = Math.floor((deployElapsed % 60000) / 1000);
            const deployDuration = deployMin > 0 ? `${deployMin}ë¶„ ${deploySec}ì´ˆ` : `${deploySec}ì´ˆ`;

            // ì „ì²´ ì†Œìš” ì‹œê°„
            const totalElapsed = now - prepareStart;
            const totalMin = Math.floor(totalElapsed / 60000);
            const totalSec = Math.floor((totalElapsed % 60000) / 1000);
            const totalDuration = totalMin > 0 ? `${totalMin}ë¶„ ${totalSec}ì´ˆ` : `${totalSec}ì´ˆ`;

            const body = [
              '## ğŸ âœ… iOS TestFlight ë¹Œë“œ ì™„ë£Œ',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”§ ì¤€ë¹„ | âœ… ì™„ë£Œ | ${prepareDuration} |`,
              `| ğŸ”¨ IPA ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ“¤ TestFlight ë°°í¬ | âœ… ì™„ë£Œ | ${deployDuration} |`,
              '',
              `**ì´ ì†Œìš” ì‹œê°„: ${totalDuration}**`,
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì•± ë²„ì „** | \`0.0.0(${buildNumber})\` |`,
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              `| **ì»¤ë°‹** | \`${commitHash}\` |`,
              '',
              'ğŸ“± **TestFlightì—ì„œ í…ŒìŠ¤íŠ¸ ì•±ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**',
              '',
              `ğŸ”— [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸](${runUrl})`
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            console.log(`âœ… ì§„í–‰ ìƒí™© ìµœì¢… ì—…ë°ì´íŠ¸ ì™„ë£Œ: ì „ì²´ ì„±ê³µ (${totalDuration})`);

      # ì§„í–‰ ìƒí™© ìµœì¢… ì—…ë°ì´íŠ¸ - ì‹¤íŒ¨
      - name: ì§„í–‰ ìƒí™© ìµœì¢… ì—…ë°ì´íŠ¸ - ì‹¤íŒ¨
        if: failure() && github.event_name == 'repository_dispatch' && github.event.client_payload.pr_number != '' && needs.prepare-test-build.outputs.progress_comment_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = parseInt('${{ needs.prepare-test-build.outputs.progress_comment_id }}');
            const prepareStart = parseInt('${{ needs.prepare-test-build.outputs.prepare_start }}');
            const buildStart = parseInt('${{ needs.build-ios-test.outputs.build_start }}');
            const deployStart = parseInt('${{ steps.deploy_start.outputs.time }}');
            const branchName = '${{ github.event.client_payload.branch_name }}';
            const buildNumber = '${{ github.event.client_payload.build_number }}';
            const commitHash = '${{ needs.prepare-test-build.outputs.commit_hash }}';
            const runId = '${{ github.run_id }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            const now = Date.now();

            // ì¤€ë¹„ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const prepareElapsed = buildStart - prepareStart;
            const prepareMin = Math.floor(prepareElapsed / 60000);
            const prepareSec = Math.floor((prepareElapsed % 60000) / 1000);
            const prepareDuration = prepareMin > 0 ? `${prepareMin}ë¶„ ${prepareSec}ì´ˆ` : `${prepareSec}ì´ˆ`;

            // ë¹Œë“œ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const buildElapsed = deployStart - buildStart;
            const buildMin = Math.floor(buildElapsed / 60000);
            const buildSec = Math.floor((buildElapsed % 60000) / 1000);
            const buildDuration = buildMin > 0 ? `${buildMin}ë¶„ ${buildSec}ì´ˆ` : `${buildSec}ì´ˆ`;

            // ë°°í¬ ë‹¨ê³„ ì†Œìš” ì‹œê°„
            const deployElapsed = now - deployStart;
            const deployMin = Math.floor(deployElapsed / 60000);
            const deploySec = Math.floor((deployElapsed % 60000) / 1000);
            const deployDuration = deployMin > 0 ? `${deployMin}ë¶„ ${deploySec}ì´ˆ` : `${deploySec}ì´ˆ`;

            const body = [
              '## ğŸ âŒ iOS TestFlight ë¹Œë“œ ì‹¤íŒ¨',
              '',
              '| ë‹¨ê³„ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |',
              '|------|------|----------|',
              `| ğŸ”§ ì¤€ë¹„ | âœ… ì™„ë£Œ | ${prepareDuration} |`,
              `| ğŸ”¨ IPA ë¹Œë“œ | âœ… ì™„ë£Œ | ${buildDuration} |`,
              `| ğŸ“¤ TestFlight ë°°í¬ | âŒ ì‹¤íŒ¨ | ${deployDuration} |`,
              '',
              '| í•­ëª© | ê°’ |',
              '|------|-----|',
              `| **ì•± ë²„ì „** | \`0.0.0(${buildNumber})\` |`,
              `| **ë¸Œëœì¹˜** | \`${branchName}\` |`,
              `| **ì»¤ë°‹** | \`${commitHash}\` |`,
              '',
              'âŒ **TestFlight ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.**',
              '',
              `ğŸ”— [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸ í™•ì¸](${runUrl})`
            ].join('\n');

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: body
            });

            console.log(`âŒ ì§„í–‰ ìƒí™© ìµœì¢… ì—…ë°ì´íŠ¸ ì™„ë£Œ: TestFlight ë°°í¬ ì‹¤íŒ¨`);
