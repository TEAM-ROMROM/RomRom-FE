name: í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸

on:
  pull_request:
    branches: ["main"]

jobs:
  test-project-build:
    name: í”„ë¡œì íŠ¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        id: checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
        id: create-env
        run: |
          printf "%s\n" "${{ secrets.ENV }}" > .env
          if [ $? -ne 0 ]; then
            echo "::error::í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì‹¤íŒ¨!"
            exit 1
          fi

      - name: í‚¤ìŠ¤í† ì–´ ì„¤ì •
        id: setup-keystore
        run: |
          mkdir -p android/app/keystore
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > android/app/keystore/key.jks
          if [ $? -ne 0 ]; then
            echo "::error::í‚¤ìŠ¤í† ì–´ íŒŒì¼ ìƒì„± ì‹¤íŒ¨!"
            exit 1
          fi
          
          echo "storeFile=keystore/key.jks" > android/key.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          
          if [ ! -f android/key.properties ]; then
            echo "::error::key.properties íŒŒì¼ ìƒì„± ì‹¤íŒ¨!"
            exit 1
          fi

      - name: Flutter ì„¤ì •
        id: setup-flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.3"
          cache: true
          cache-key: flutter-${{ runner.os }}-3.27.3

      - name: Flutter ì˜ì¡´ì„± ìºì‹±
        id: cache-flutter
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Gradle ì˜ì¡´ì„± ìºì‹±
        id: cache-gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/build.gradle', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: local.properties ìƒì„±
        id: create-local-props
        run: |
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          echo "flutter.sdk=$FLUTTER_HOME" >> android/local.properties
          
          if [ ! -f android/local.properties ]; then
            echo "::error::local.properties íŒŒì¼ ìƒì„± ì‹¤íŒ¨!"
            exit 1
          fi

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        id: install-deps
        run: |
          flutter pub get
          if [ $? -ne 0 ]; then
            echo "::error::Flutter ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨!"
            exit 1
          fi

      - name: Gradle ì„¤ì •
        id: setup-gradle
        working-directory: android
        run: |
          chmod +x gradlew
          if [ $? -ne 0 ]; then
            echo "::error::Gradle ì„¤ì • ì‹¤íŒ¨!"
            exit 1
          fi

      - name: Java ì„¤ì •
        id: setup-java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Android SDK ì„¤ì •
        id: setup-android
        uses: android-actions/setup-android@v3

      - name: ì½”ë“œ ë¶„ì„ ì‹¤í–‰
        id: flutter-analyze
        run: |
          flutter analyze
          if [ $? -ne 0 ]; then
            echo "::error::ì½”ë“œ ë¶„ì„ ì‹¤íŒ¨! ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            exit 1
          fi

      - name: APK ë¹Œë“œ
        id: build-apk
        run: |
          flutter build apk --debug
          if [ $? -ne 0 ]; then
            echo "::error::APK ë¹Œë“œ ì‹¤íŒ¨!"
            exit 1
          fi

      - name: ë¹Œë“œ ê²°ê³¼ í™•ì¸
        id: check-output
        run: |
          if [ ! -d "build/app/outputs/flutter-apk/" ]; then
            echo "::error::ë¹Œë“œ ê²°ê³¼ë¬¼ ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            exit 1
          fi
          
          ls -la build/app/outputs/flutter-apk/
          
          if [ ! -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "::error::APK íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            exit 1
          fi

      - name: ì‹¤íŒ¨í•œ ë‹¨ê³„ ì°¾ê¸°
        id: find-failure
        if: failure()
        run: |
          echo "failed_step=${{ steps.checkout.outcome == 'failure' && 'ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ' ||
            steps.create-env.outcome == 'failure' && 'í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±' ||
            steps.setup-keystore.outcome == 'failure' && 'í‚¤ìŠ¤í† ì–´ ì„¤ì •' ||
            steps.setup-flutter.outcome == 'failure' && 'Flutter ì„¤ì •' ||
            steps.create-local-props.outcome == 'failure' && 'local.properties ìƒì„±' ||
            steps.install-deps.outcome == 'failure' && 'ì˜ì¡´ì„± ì„¤ì¹˜' ||
            steps.setup-gradle.outcome == 'failure' && 'Gradle ì„¤ì •' ||
            steps.setup-java.outcome == 'failure' && 'Java ì„¤ì •' ||
            steps.setup-android.outcome == 'failure' && 'Android SDK ì„¤ì •' ||
            steps.flutter-analyze.outcome == 'failure' && 'ì½”ë“œ ë¶„ì„' ||
            steps.build-apk.outcome == 'failure' && 'APK ë¹Œë“œ' ||
            steps.check-output.outcome == 'failure' && 'ë¹Œë“œ ê²°ê³¼ í™•ì¸' ||
            'ì•Œ ìˆ˜ ì—†ëŠ” ë‹¨ê³„' }}" >> $GITHUB_OUTPUT

      - name: PRì— ì„±ê³µ ë©”ì‹œì§€ ì‘ì„±
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… í”„ë¡œì íŠ¸ ë¹Œë“œ ì„±ê³µ!
            
              ëª¨ë“  ë‹¨ê³„ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.
            
              ### ë¹Œë“œ ì •ë³´
              - ë¹Œë“œ ì‹œê°„: ${new Date().toISOString()}
              - ì»¤ë°‹: ${context.sha.substring(0, 7)}
              - ë¸Œëœì¹˜: ${context.ref.replace('refs/heads/', '')}
            
              ë¹Œë“œëœ ì•±ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‘`
            })

      - name: PRì— ì‹¤íŒ¨ ë©”ì‹œì§€ ì‘ì„±
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let errorLog = '';
            
            try {
              // ì‹¤íŒ¨í•œ ë‹¨ê³„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
              const failedStep = '${{ steps.find-failure.outputs.failed_step }}';
            
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## âŒ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹¤íŒ¨!
            
                ### ì‹¤íŒ¨í•œ ë‹¨ê³„: ${failedStep}
            
                ìì„¸í•œ ì˜¤ë¥˜ ë‚´ìš©ì€ [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¡œê·¸](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            
                ë¹Œë“œ ë¬¸ì œë¥¼ í•´ê²°í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸ”`
              })
            } catch (error) {
              console.log(`Error creating comment: ${error}`);
            }