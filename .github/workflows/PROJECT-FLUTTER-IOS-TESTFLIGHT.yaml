# ===================================================================
# Flutter iOS TestFlight ìë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” Flutter iOS ì•±ì„ ë¹Œë“œí•˜ì—¬ TestFlightì— ìë™ ë°°í¬í•©ë‹ˆë‹¤.
#
# â˜… ë§ˆë²•ì‚¬ ìš°ì„  ì•„í‚¤í…ì²˜ â˜…
# - ë¹Œë“œì— í•„ìš”í•œ ì„¤ì • íŒŒì¼ë“¤ì€ ì›¹ ë§ˆë²•ì‚¬ê°€ ìƒì„±í•©ë‹ˆë‹¤
# - ì›Œí¬í”Œë¡œìš°ëŠ” ë§ˆë²•ì‚¬ê°€ ìƒì„±í•œ íŒŒì¼ë“¤ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤
# - ë§ˆë²•ì‚¬ ê²½ë¡œ: .github/util/flutter/ios-testflight-setup-wizard/index.html
#   (ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ì„œ ì‚¬ìš©)
#
# ë¹Œë“œ íŒŒì´í”„ë¼ì¸:
#   1. flutter build ios --no-codesign (Flutter ë¹Œë“œ)
#   2. xcodebuild archive (Xcode ì•„ì¹´ì´ë¸Œ ìƒì„±)
#   3. xcodebuild -exportArchive (IPA ìƒì„±, ExportOptions.plist ì‚¬ìš©)
#   4. fastlane upload_testflight (ë§ˆë²•ì‚¬ ìƒì„± Fastfile ì‚¬ìš©)
#
# ===================================================================
# ğŸ“‹ í•„ìš”í•œ GitHub Secrets
# ===================================================================
#
# ğŸ” Apple ì¸ì¦ì„œ & í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ (í•„ìˆ˜):
#   - APPLE_CERTIFICATE_BASE64        : .p12 ì¸ì¦ì„œ (base64 ì¸ì½”ë”©)
#   - APPLE_CERTIFICATE_PASSWORD      : .p12 ì¸ì¦ì„œ ë¹„ë°€ë²ˆí˜¸
#   - APPLE_PROVISIONING_PROFILE_BASE64 : .mobileprovision íŒŒì¼ (base64 ì¸ì½”ë”©)
#   - IOS_PROVISIONING_PROFILE_NAME   : í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ ì´ë¦„ (ì˜ˆ: "MyApp Distribution")
#
# ğŸ”‘ App Store Connect API (í•„ìˆ˜):
#   - APP_STORE_CONNECT_API_KEY_ID    : API Key ID (10ìë¦¬, ì˜ˆ: ABC123DEF4)
#   - APP_STORE_CONNECT_ISSUER_ID     : Issuer ID (UUID í˜•ì‹)
#   - APP_STORE_CONNECT_API_KEY_BASE64: AuthKey_XXXXXX.p8 íŒŒì¼ (base64 ì¸ì½”ë”©)
#
# ğŸ“ í™˜ê²½ ì„¤ì • (ì„ íƒ):
#   - ENV_FILE (ë˜ëŠ” ENV)             : .env íŒŒì¼ ë‚´ìš© (ì•±ì—ì„œ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ë³€ìˆ˜)
#   - SECRETS_XCCONFIG                : ios/Flutter/Secrets.xcconfig ë‚´ìš© (ì„ íƒ)
#                                       iOS ë„¤ì´í‹°ë¸Œ ë¹Œë“œ ì‹œ í•„ìš”í•œ API í‚¤ ë“±
#                                       (ì˜ˆ: GOOGLE_MAPS_API_KEY=xxx)
#
# ===================================================================
# ğŸ› ï¸ ì´ˆê¸° ì„¤ì • ë°©ë²•
# ===================================================================
#
# 1. ì›¹ ë§ˆë²•ì‚¬ ì‹¤í–‰:
#    ë¸Œë¼ìš°ì €ì—ì„œ .github/util/flutter/ios-testflight-setup-wizard/index.html ì—´ê¸°
#    â†’ í•„ìš”í•œ ì •ë³´ ì…ë ¥ í›„ ì„¤ì • íŒŒì¼ ë‹¤ìš´ë¡œë“œ
#
# 2. GitHub Secrets ì„¤ì • (ìœ„ ëª©ë¡ ì°¸ê³ )
#
# 3. ìƒì„±ëœ íŒŒì¼ ì»¤ë°‹:
#    git add ios/
#    git commit -m "chore: iOS TestFlight ë°°í¬ ì„¤ì •"
#
# 4. deploy ë¸Œëœì¹˜ë¡œ í‘¸ì‹œí•˜ì—¬ ë°°í¬ ì‹œì‘
#
# ===================================================================

name: PROJECT-iOS-TestFlight-Deploy

on:
  push:
    branches: ["deploy"]
  workflow_run:
    workflows: ["CHANGELOG ìë™ ì—…ë°ì´íŠ¸"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

# ============================================
# ğŸ”§ í”„ë¡œì íŠ¸ë³„ ì„¤ì • (ì•„ë˜ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”)
# ============================================
env:
  FLUTTER_VERSION: "3.35.5"
  XCODE_VERSION: "16.3"
  PROJECT_TYPE: "flutter"

  # ============================================
  # ğŸ“ í™˜ê²½ íŒŒì¼ ì„¤ì •
  # ============================================
  # .env íŒŒì¼ ìƒì„± ê²½ë¡œ (í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê¸°ì¤€)
  ENV_FILE_PATH: ".env"

  # ============================================
  # ğŸ“ TestFlight Changelog ì„¤ì •
  # ============================================
  SKIP_WAITING_FOR_BUILD_PROCESSING: "false"

jobs:
  prepare-build:
    name: í™˜ê²½ ì„¤ì • ë° ì¤€ë¹„
    runs-on: macos-15
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}

    outputs:
      version: ${{ steps.current_version.outputs.version }}
      build_number: ${{ steps.current_version.outputs.build_number }}
      project_type: ${{ steps.current_version.outputs.project_type }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Create .env file
        run: |
          cat << 'EOF' > ${{ env.ENV_FILE_PATH }}
          ${{ secrets.ENV_FILE || secrets.ENV }}
          EOF
          echo "âœ… ${{ env.ENV_FILE_PATH }} file created"

      - name: Create Secrets.xcconfig file
        run: |
          mkdir -p ios/Flutter
          if [ -n "${{ secrets.SECRETS_XCCONFIG }}" ]; then
            echo "${{ secrets.SECRETS_XCCONFIG }}" > ios/Flutter/Secrets.xcconfig
            echo "Secrets.xcconfig created"
          else
            echo "// No secrets provided" > ios/Flutter/Secrets.xcconfig
          fi

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install

      - name: ë²„ì „ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
        run: |
          chmod +x ./.github/scripts/version_manager.sh
          chmod +x ./.github/scripts/changelog_manager.py

      - name: í˜„ì¬ ë²„ì „ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: current_version
        run: |
          VERSION=$(./.github/scripts/version_manager.sh get | tail -n 1)
          BUILD_NUMBER=$(./.github/scripts/version_manager.sh get-code | tail -n 1)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "project_type=${{ env.PROJECT_TYPE }}" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ ë²„ì „: $VERSION (ë¹Œë“œë²ˆí˜¸: $BUILD_NUMBER)"

      - name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        id: release_notes
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"

          if [ -f "CHANGELOG.json" ]; then
            python3 ./.github/scripts/changelog_manager.py generate-md
            python3 ./.github/scripts/changelog_manager.py export --version $VERSION --output final_release_notes.txt

            if [ -s final_release_notes.txt ]; then
              echo "RELEASE_NOTES_FOUND=true" >> $GITHUB_ENV
            else
              echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
              echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
            fi
          else
            echo "RELEASE_NOTES_FOUND=false" >> $GITHUB_ENV
            echo "v$VERSION ì—…ë°ì´íŠ¸" > final_release_notes.txt
          fi

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: final_release_notes.txt
          retention-days: 1

      - name: Upload project files
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: |
            ${{ env.ENV_FILE_PATH }}
            ios/Flutter/Secrets.xcconfig
            pubspec.yaml
            lib/
            assets/
          retention-days: 1

  # ============================================
  # iOS ë¹Œë“œ (xcodebuild ì§ì ‘ ì‚¬ìš©)
  # ============================================
  build-ios:
    name: iOS ì•± ë¹Œë“œ
    runs-on: macos-15
    needs: prepare-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin deploy

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

      - name: Download project files
        uses: actions/download-artifact@v4
        with:
          name: project-files
          path: .

      - name: Ensure .env file exists
        run: |
          if [ ! -f "${{ env.ENV_FILE_PATH }}" ]; then
            cat << 'EOF' > ${{ env.ENV_FILE_PATH }}
          ${{ secrets.ENV_FILE || secrets.ENV }}
          EOF
            echo "âœ… ${{ env.ENV_FILE_PATH }} file created (fallback)"
          fi

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-flutter-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install

      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profile
        run: |
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          uuid=$(grep -A1 -a "UUID" profile.mobileprovision | grep string | sed -e "s/<string>//" -e "s/<\/string>//" -e "s/[[:space:]]//g")
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$uuid.mobileprovision

      - name: Verify ExportOptions.plist
        run: |
          cd ios
          if [ ! -f "ExportOptions.plist" ]; then
            exit 1
          fi

      - name: Flutter build (no codesign)
        run: |
          flutter build ios --release --no-codesign \
            --build-name="${{ needs.prepare-build.outputs.version }}" \
            --build-number="${{ needs.prepare-build.outputs.build_number }}"

      - name: Create Archive
        env:
          IOS_PROVISIONING_PROFILE_NAME: ${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}
        run: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -archivePath build/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            archive \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$IOS_PROVISIONING_PROFILE_NAME" \
            CODE_SIGN_IDENTITY="Apple Distribution"

      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/ipa/*.ipa
          retention-days: 1

  # ============================================
  # TestFlight ë°°í¬ (ë§ˆë²•ì‚¬ ìƒì„± Fastfile ì‚¬ìš©)
  # ============================================
  deploy-testflight:
    name: TestFlight ë°°í¬
    runs-on: macos-15
    needs: [prepare-build, build-ios]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: deploy
          fetch-depth: 0

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa
          path: ios/build/ipa/

      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: Verify Fastfile exists
        run: |
          if [ ! -f "ios/fastlane/Fastfile" ]; then
            echo "âŒ ios/fastlane/Fastfileì´ ì—†ìŠµë‹ˆë‹¤!"
            echo "ì›¹ ë§ˆë²•ì‚¬ë¥¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì • íŒŒì¼ì„ ìƒì„±í•˜ì„¸ìš”:"
            echo "  ë¸Œë¼ìš°ì €ì—ì„œ .github/util/flutter/ios-testflight-setup-wizard/index.html ì—´ê¸°"
            exit 1
          fi
          echo "âœ… Fastfile í™•ì¸ë¨: ios/fastlane/Fastfile"

      - name: Install Fastlane
        run: gem install fastlane

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          SKIP_WAITING_FOR_BUILD_PROCESSING: ${{ env.SKIP_WAITING_FOR_BUILD_PROCESSING }}
        run: |
          # IPA íŒŒì¼ ì°¾ê¸°
          IPA_PATH=$(find $GITHUB_WORKSPACE/ios/build/ipa -name "*.ipa" | head -1)
          echo "ğŸ“¦ Found IPA at: $IPA_PATH"

          if [ ! -f "$IPA_PATH" ]; then
            echo "âŒ IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            ls -la ios/build/ipa/
            exit 1
          fi

          # Release notes ì¤€ë¹„
          if [ -f "final_release_notes.txt" ]; then
            RELEASE_NOTES=$(cat final_release_notes.txt)
            echo "ğŸ“ Release Notes:"
            echo "$RELEASE_NOTES"
          else
            RELEASE_NOTES="v${{ needs.prepare-build.outputs.version }} ì—…ë°ì´íŠ¸"
            echo "ğŸ“ ê¸°ë³¸ Release Notes: $RELEASE_NOTES"
          fi

          # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (Fastfileì—ì„œ ì‚¬ìš©)
          export API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8"
          export IPA_PATH="$IPA_PATH"
          export RELEASE_NOTES="$RELEASE_NOTES"

          # ë””ë²„ê¹… ì •ë³´
          echo "ğŸ”§ Working directory: $(pwd)"
          echo "ğŸ”§ IPA_PATH: $IPA_PATH"
          echo "ğŸ”§ API_KEY_PATH: $API_KEY_PATH"

          # Fastlane ì‹¤í–‰ (ë§ˆë²•ì‚¬ê°€ ìƒì„±í•œ Fastfile ì‚¬ìš©)
          cd ios
          fastlane upload_testflight

      - name: Notify TestFlight Upload Success
        if: success()
        run: |
          echo "âœ… TestFlight ì—…ë¡œë“œ ì„±ê³µ!"
          echo "ğŸ“± ë²„ì „: ${{ needs.prepare-build.outputs.version }}"
          echo "ğŸ”¢ ë¹Œë“œë²ˆí˜¸: ${{ needs.prepare-build.outputs.build_number }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ TestFlight ì—…ë¡œë“œ ì‹¤íŒ¨!"
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
