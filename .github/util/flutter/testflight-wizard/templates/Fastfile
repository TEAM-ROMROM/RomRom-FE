# ============================================
# Fastfile for iOS TestFlight Deployment
# ============================================
#
# ì´ íŒŒì¼ì€ flutter-ios-testflight-init ë§ˆë²•ì‚¬ì— ì˜í•´ ìƒì„±ë©ë‹ˆë‹¤.
# GitHub Actions ì›Œí¬í”Œë¡œìš°ì—ì„œ ì´ íŒŒì¼ì„ ì§ì ‘ ì‚¬ìš©í•©ë‹ˆë‹¤.
#
# ë¹Œë“œ íŒŒì´í”„ë¼ì¸:
#   1. flutter build ios --no-codesign (Flutter ë¹Œë“œ)
#   2. xcodebuild archive (Xcode ì•„ì¹´ì´ë¸Œ ìƒì„±)
#   3. xcodebuild -exportArchive (IPA ìƒì„±)
#   4. fastlane upload_testflight (ì´ íŒŒì¼ì˜ lane ì‹¤í–‰)
#
# í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜:
#   - APP_STORE_CONNECT_API_KEY_ID: App Store Connect API Key ID
#   - APP_STORE_CONNECT_ISSUER_ID: App Store Connect Issuer ID
#   - API_KEY_PATH: API Key íŒŒì¼ ê²½ë¡œ (.p8)
#   - IPA_PATH: ì—…ë¡œë“œí•  IPA íŒŒì¼ ê²½ë¡œ
#   - RELEASE_NOTES: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ (í•œêµ­ì–´/ì˜ì–´ ë™ì‹œ ì ìš©)
#
# ì‚¬ìš©ë²• (CI):
#   fastlane upload_testflight
#
# ì‚¬ìš©ë²• (ë¡œì»¬):
#   bundle exec fastlane upload_testflight
#   bundle exec fastlane build_and_deploy changelog:"ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸"
#
# ============================================

default_platform(:ios)

platform :ios do
  desc "TestFlightì— IPA ì—…ë¡œë“œ (CIìš© - IPAê°€ ì´ë¯¸ ë¹Œë“œëœ ìƒíƒœ)"
  lane :upload_testflight do
    UI.message("ğŸš€ TestFlight ì—…ë¡œë“œ ì‹œì‘")

    # App Store Connect API Key ì„¤ì •
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["API_KEY_PATH"],
      duration: 1200,
      in_house: false
    )

    # IPA íŒŒì¼ í™•ì¸
    ipa_path = ENV["IPA_PATH"]
    if ipa_path.nil? || ipa_path.empty?
      ipa_path = Dir.glob("build/ipa/*.ipa").first
    end

    UI.message("ğŸ“¦ IPA ê²½ë¡œ: #{ipa_path}")

    # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì„¤ì •
    release_notes = ENV["RELEASE_NOTES"] || "ìƒˆë¡œìš´ ë¹Œë“œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤."
    UI.message("ğŸ“ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸: #{release_notes}")

    # TestFlight ì—…ë¡œë“œ (upload_to_testflight = pilot)
    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      changelog: release_notes,
      localized_build_info: {
        "ko" => { whats_new: release_notes },
        "en-US" => { whats_new: release_notes }
      },
      skip_waiting_for_build_processing: ENV["SKIP_WAITING_FOR_BUILD_PROCESSING"] == "true",
      distribute_external: false,
      notify_external_testers: false,
      uses_non_exempt_encryption: ENV["USES_NON_EXEMPT_ENCRYPTION"] == "true"
    )

    UI.success("âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!")
  end

  desc "ë¡œì»¬ì—ì„œ IPA ë¹Œë“œ ë° TestFlight ì—…ë¡œë“œ (ê°œë°œìš©)"
  lane :build_and_deploy do |options|
    UI.message("ğŸ—ï¸ ë¡œì»¬ ë¹Œë“œ ë° ë°°í¬ ì‹œì‘")
    
    # App Store Connect API Key ì„¤ì •
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["API_KEY_PATH"],
      duration: 1200,
      in_house: false
    )

    # Archive ìƒì„±
    UI.message("ğŸ“¦ Archive ìƒì„± ì¤‘...")
    sh("xcodebuild -workspace Runner.xcworkspace " \
       "-scheme Runner " \
       "-archivePath build/Runner.xcarchive " \
       "-destination 'generic/platform=iOS' " \
       "archive " \
       "CODE_SIGN_STYLE=Manual " \
       "PROVISIONING_PROFILE_SPECIFIER='#{ENV['IOS_PROVISIONING_PROFILE_NAME']}' " \
       "CODE_SIGN_IDENTITY='Apple Distribution'")

    # IPA ë‚´ë³´ë‚´ê¸°
    UI.message("ğŸ“¦ IPA ë‚´ë³´ë‚´ê¸° ì¤‘...")
    sh("xcodebuild -exportArchive " \
       "-archivePath build/Runner.xcarchive " \
       "-exportPath build/ipa " \
       "-exportOptionsPlist ExportOptions.plist")

    # TestFlight ì—…ë¡œë“œ
    ipa_path = Dir.glob("build/ipa/*.ipa").first
    pilot(
      api_key: api_key,
      ipa: ipa_path,
      changelog: options[:changelog] || "ìƒˆë¡œìš´ ë¹Œë“œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.",
      skip_waiting_for_build_processing: ENV["SKIP_WAITING_FOR_BUILD_PROCESSING"] == "true",
      distribute_external: false,
      notify_external_testers: false,
      uses_non_exempt_encryption: false
    )

    UI.success("âœ… ë¹Œë“œ ë° TestFlight ì—…ë¡œë“œ ì™„ë£Œ!")
  end
end
